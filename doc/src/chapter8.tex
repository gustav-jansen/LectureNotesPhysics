\newcommand{\element}[3]{\bra{#1}#2\ket{#3}}
\newcommand{\normord}[1]{\left\{#1\right\}}
\newcommand*{\kpr}[1]{\left\{#1\right\}}
\newcommand*{\fpr}[1]{\left[#1\right]}
\newcommand*{\for}[3]{\langle#1|#2|#3\rangle} 

\title{Computational Nuclear Physics and Post Hartree-Fock Methods}
\author{Justin G.~Lietz, Samuel Novario, Gustav R.~Jansen, Gaute
  Hagen, and Morten Hjorth-Jensen,} \institute{Justin G.~Lietz \at
  Department of Physics and Astronomy and National Superconducting
  Cyclotron Laboratory, Michigan State University, East Lansing,
  Michigan, USA, \email{lietz@nscl.msu.edu}, \and Samuel Novario \at
  Department of Physics and Astronomy and National Superconducting
  Cyclotron Laboratory, Michigan State University, East Lansing,
  Michigan, USA, \email{novarios@nscl.msu.edu}, \and Gustav R.~Jansen
  \at National Center for Computational Sciences and Physics Division, Oak Ridge National Laboratory, Oak Ridge,
  Tennessee, USA, \email{jansen@ornl.gov},
  \and Gaute Hagen \at Physics Division, Oak Ridge National Laboratory, Oak Ridge, Tennessee, USA and Department of Physics and
  Astronomy, University of Tennessee, Knoxville, Tennessee, USA,
  \email{hageng@ornl.gov}, \and Morten Hjorth-Jensen \at Department of
  Physics and Astronomy and National Superconducting Cyclotron
  Laboratory, Michigan State University, East Lansing, Michigan, USA
  and Department of Physics, University of Oslo, Oslo, Norway,
\email{hjensen@msu.edu}}

\maketitle 
\abstract{We present a computational approach to infinite
  nuclear matter employing Hartree-Fock theory, many-body perturbation
  theory and coupled cluster theory. These lectures are closely linked
  with those in chapters 9, 10 and 11 and serve as input for the
  correlation functions employed in Monte Carlo calculations in
  chapter 9, the in-medium similarity renormalization group theory of
  dense fermionic systems of chapter 10 and the Green's function
  approach in chapter 11.  We provide extensive code examples and
  benchmark calculations, allowing thereby an eventual reader to start
  writing her/his own codes. We start with an object-oriented serial
  code and end with in-depth discussions on strategies for porting the
  code to present and planned high-performance computing facilities. }


%\maketile

\section{Introduction}\label{sec:chap8intro}


Studies of dense baryonic matter are of central importance to our
basic understanding of the stability of nuclear matter, spanning from
matter at high densities and temperatures to matter as found within
dense astronomical objects like neutron stars.  An object like a
neutron star offers an intriguing interplay between nuclear processes
and astrophysical observables, spanning many orders of magnitude in
density and several possible compositions of matter, from the crust of
the star to a possible quark matter phase in its interior, see for
example
Refs.~\cite{lattimer2007,lattimer2012,weber1999,hh2000}
for discussions.  A central issue in studies of infinite nuclear
matter is the determination of the equation of state (EoS), which can
in turn be used to determine properties like the mass range, the
mass-radius relationship, the thickness of the crust and the rate by
which a neutron star cools down over time. The EoS is also an
important ingredient in studies of the energy release in supernova
explosions.

The determination and our understanding of the EoS for dense nuclear
matter is intimately linked with our capability to solve the nuclear
many-body problem. In particular, to be able to provide precise
constraints on the role of correlations beyond the mean field, is
crucial for improved and controlled calculations of the EoS of
nucleonic matter.  In recent years, there has been a considerable
algorithmic development of first principle (or {\em ab initio})
methods for solving the nuclear many-body problem. Linked with a
similar progress in the derivation of nuclear forces based on
effective field theory (EFT), see chapters four, five and six of the
present text and Refs.~\cite{vankolck1994,machleidt2011,epelbaum2009},
we are now in a situation where reliable results can be provided at
different levels of approximation.  The nuclear Hamiltonians which are
now used routinely in nuclear structure and nuclear matter
calculations, include both nucleon-nucleon ($NN$) and three-nucleon forces (3NFs) derived from EFT, see for
example
Refs.~\cite{binder2013,hergert2013,roth2012,hagen2012a,hagen2012b,cipollone2013,carbone2013}.
Parallel to the development of nuclear forces from EFT, which employs
symmetries of quantum chromodynamics, there are recent and promising
approaches to derive the EoS using forces constrained from lattice
quantum chromodynamics calculations \cite{tetsuo2013}, see chapters 2
and 3 of the present text.

Theoretical studies of nuclear matter and the pertinent EoS span back
to the very early days of nuclear many-body physics. These early
developments are nicely summarized in for example the review of Day
\cite{day1967} from 1967. These early state-of-the-art calculations
were performed using what is known as Brueckner-Bethe-Goldstone theory
\cite{brueckner1954,brueckner1955}, see for example
Refs.\cite{hh2000,baldo2012,baldo2012a} for recent reviews and
developments.  In these calculations, mainly particle-particle
correlations were summed to infinite order.  Other correlations were
often included in a perturbative way. A systematic inclusion of other
correlations in a non-perturbative way are nowadays accounted for in
many-body methods like coupled cluster theory
\cite{bartlett2007,shavittbartlett2009}, various Monte Carlo methods
\cite{gandolfi2009,lovato2012}, Green's function approaches
\cite{baldo2012a,carbone2013,dickhoff2004} and density functional
theories \cite{erler2013}, just to mention a few of the actual
many-body methods which are used for nuclear matter studies. Many of these methods
are discussed in detail in this and the following chapters.


The aim of this part of the lectures (comprising this chapter and the
three subsequent ones) is to provide the necessary ingredients for
perfoming studies of neutron star matter (or matter in
$\beta$-equilibrium) and symmetric nuclear matter.  We will mainly
focus on pure neutron matter, but the framework and formalism can
easily be extended to other dense and homogeneous fermionic systems
such as the electron gas in two and three dimensions. The introductory
material we present here forms also the basis for the next three
chapters, starting with the definition of the single-particle basis
and our Hamiltonians as well as Hartree-Fock theory. For infinite
matter, due to the translational invariance of the Hamiltonian, the
single-particle basis, in terms of plane waves, is unchanged under
Hartree-Fock calculations.

Neutron star matter at densities of 0.1 fm$^{-3}$ and greater, is
often assumed to be made of mainly neutrons, protons, electrons and
muons in beta equilibrium. However, other baryons like various
hyperons may exist, as well as possible mesonic condensates and
transitions to quark degrees of freedom at higher densities
\cite{hh2000,prakash1996,steiner2010}.  In these notes we limit ourselves to matter composed
of neutrons only.  Furthermore, we will also consider matter at
temperatures much lower than the typical Fermi energies.

In the next section we present some of the basic quantities that enter
the different many-body methods discussed in this and the three
subsequent chapters. All these methods start with some single-particle
basis states, normally obtained via the solution of mean-field
approaches like Hartree-Fock theory. Contributions from correlations
beyond such a mean-field basis to selected observables, are then
obtained via a plethora of many-body methods. These methods represent
different mathematical algorithms used to solve either
Schr\"{o}dinger's or Dirac's equations for many interacting
fermions. After the definitions of our basis states, we derive the
Hartree-Fock equations in the subsequent section and move on with
many-body perturbation theory, full configuration interaction theory
and coupled cluster theory.  Monte Carlo methods, Green's function
theory approaches and Similarity Renormlization group approaches are
discussed in the subsequent three chapters.

The strengths and weaknesses of these methods are discussed throughout
these chapters, with applications to either a simple pairing model
and/or pure neutron matter. Our focus will be on pure neutron matter,
starting with a simple model for the interaction between
nucleons. This allows us to focus on pedagogical and algorithmic
aspects of the various many-body methods, avoiding thereby the full
complexity of nuclear forces.  If properly written however, the codes
can easily be extended to include models of the nuclear interactions
based on effective field theory (see chapters four, five and six of
the present text) and other baryon species than just neutrons. In our
conclusions we point back to models for nuclear forces and their links
to the underlying theory of the strong interaction discussed in the
first chapters of this book, bridging thereby the gap between the
theory of nuclear Hamiltonians and many-body methods.


\section{Single-particle basis, Hamiltonians and models for the nuclear force}\label{sec:chap8forces}

\subsection{Introduction to nuclear matter and Hamiltonians}

Although our focus here and in the coming chapters is on neutron
matter only, our formalism lends itself easily to studies of nuclear
matter with a given proton fraction and electrons. In this section we
outline some of the background details, with a focus on the
calculational basis and the representation of a nuclear Hamiltonian.

Neutron star matter is not composed of only neutrons. Rather, matter
is composed of various baryons and leptons in chemical and charge
equilibrium.  The equilibrium conditions are governed by the weak
processes (normally referred to as the processes for
$\beta$-equilibrium)
\begin{equation} 
      b_1 \rightarrow b_2 + l +\bar{\nu}_l \hspace{1cm} b_2 +l
      \rightarrow b_1 +\nu_l,
      \label{eq:betadecay}
\end{equation}
where $b_1$ and $b_2$ refer to different types of baryons, for example
a neutron and a proton.  The symbol $l$ is either an electron or a
muon and $\bar{\nu}_l $ and $\nu_l$ their respective anti-neutrinos
and neutrinos. Leptons like muons appear at a density close to nuclear
matter saturation density, the latter being
\[
     n_0 \approx 0.16 \pm 0.02 \hspace{0.1cm} \mathrm{fm}^{-3},
\]
with a corresponding energy per baryon ${\cal E}_0$ for symmetric
nuclear matter at saturation density of
\[
     {\cal E}_0 = B/A=-15.6\pm 0.2 \hspace{0.1cm} \mathrm{MeV}.
\]
The energy per baryon is the central quantity in the present
studies. From the energy per baryon, we can define the pressure $P$
which counteracts the gravitional forces and hinders the gravitational
collapse of a neutron star. The pressure is defined through the
relation
\begin{equation}
    P=n^2\frac{\partial {\cal E}}{\partial n}= n\frac{\partial
      \varepsilon}{\partial n}-\varepsilon,
\end{equation}
where $\varepsilon$ is the energy density.  Similarly, the chemical
potential for particle species $i$ is given by
\begin{equation}
     \mu_i = \left(\frac{\partial \varepsilon}{\partial n_i}\right).
     \label{eq:chemicalpotdef}
\end{equation}
In calculations of properties of neutron star matter in
$\beta$-equilibrium, we need to calculate the energy per baryon ${\cal E}$ 
for several proton fractions $x_p$. The proton fraction
corresponds to the ratio of protons as compared to the total nucleon
number ($Z/A$). It is defined as
\begin{equation}
    x_p = \frac{n_p}{n},
\end{equation}
where $n=n_p+n_n$ is the total baryonic density if neutrons and
protons are the only baryons present. If this is the case, the total
Fermi momentum $k_F$ and the Fermi momenta $k_{Fp}$, $k_{Fn}$ for
protons and neutrons, respectively, are related to the total nucleon density $n$ by
\begin{align}
     n = & \frac{2}{3\pi^2} k_F^3 \nonumber \\ = & x_p n + (1-x_p) n
     \nonumber \\ = & \frac{1}{3\pi^2} k_{Fp}^3 + \frac{1}{3\pi^2}
     k_{Fn}^3.
    \label{eq:densi}
\end{align}
The energy per baryon will thus be labelled as ${\cal E}(n,x_p)$. The
quantity ${\cal E}(n,0)$ refers then to the energy per baryon for pure
neutron matter while ${\cal E}(n,\frac{1}{2})$ is the
corresponding value for symmetric nuclear matter. Furthermore, in this work, subscripts
$n,p,e,\mu$ will always refer to neutrons, protons, electrons and
muons, respectively.


Since the mean free path of a neutrino in a neutron star is bigger
than the typical radius of such a star ($\sim 10$ km), we will
throughout assume that neutrinos escape freely from the neutron star,
see for example Ref.~\cite{prakash2006} for a discussion on trapped
neutrinos. Eq.~(\ref{eq:betadecay}) yields then the following
conditions for matter in $\beta$-equilibrium with for example
nucleonic degrees freedom only
\begin{equation}
    \mu_n=\mu_p+\mu_e,
     \label{eq:npebetaequilibrium}
\end{equation}
and
\begin{equation}
     n_p = n_e,
     \label{eq:chargeconserv}
\end{equation}
where $\mu_i$ and $n_i$ refer to the chemical potential and number
density in fm$^{-3}$ of particle species $i$.  If muons are present as
well, we need to modify the equation for charge conservation,
Eq. (\ref{eq:chargeconserv}), to read
\[
     n_p = n_e+n_{\mu},
\]
and require that $\mu_e = \mu_{\mu}$.

An important ingredient in the discussion of the EoS and the criteria
for matter in $\beta$-equilibrium is the so-called symmetry energy
${\cal S} (n)$, defined as the difference in energy for symmetric
nuclear matter and pure neutron matter
\begin{equation}
      {\cal S} (n) = {\cal E} (n,x_p=0) - {\cal E} (n,x_p=1/2 ).
      \label{eq:symenergy}
\end{equation}
If we expand the energy per baryon in the case of nucleonic degrees of
freedom only in the proton concentration $x_p$ about the value of the
energy for SNM ($x_p=\frac{1}{2}$), we obtain,
\begin{equation}
     {\cal E} (n,x_p)={\cal E} (n,x_p=\frac{1}{2})+
     \frac{1}{2}\frac{d^2 {\cal E}}{dx_p^2}
     (n)\left(x_p-1/2\right)^2+\dots ,
     \label{eq:energyexpansion}
\end{equation}
where the term $d^2 {\cal E}/dx_p^2$ is to be associated with the
symmetry energy ${\cal S} (n)$ in the empirical mass formula. If we
assume that higher order derivatives in the above expansion are small,
then through the conditions for $\beta$-equilbrium of
Eqs.~(\ref{eq:npebetaequilibrium}) and (\ref{eq:chargeconserv}) and
Eq.~(\ref{eq:chemicalpotdef}) we can define the proton fraction by the
symmetry energy as
\begin{equation}  
    \hbar c\left(3\pi^2nx_p\right)^{1/3} = 4{\cal S}
    (n)\left(1-2x_p\right),
    \label{eq:crudeprotonfraction}
\end{equation}
where the electron chemical potential is given by $\mu_e = \hbar c
k_F$, i.e.\ ultrarelativistic electrons are assumed.  Thus, the
symmetry energy is of paramount importance for studies of neutron star
matter in $\beta$-equilibrium.  One can extract information about the
value of the symmetry energy at saturation density $n_0$ from
systematic studies of the masses of atomic nuclei. However, these
results are limited to densities around $n_0$ and for proton fractions
close to $\frac{1}{2}$, see for example the various contributions in
Ref.~\cite{symmetryenergy2013}.  Typical values for ${\cal S} (n)$ at
$n_0$ are in the range $27-38$ MeV.  For densities greater than $n_0$
it is more difficult to get a reliable information on the symmetry
energy, and thereby the related proton fraction.


With this background, we are now ready to define our basic inputs and
approximations to the various many-body theories discussed in this
chapter and the three subsequent ones.  We will assume that the
interacting part of the Hamiltonian can be approximated by a two-body
interaction.  This means that our Hamiltonian is written as the sum of
a one-body part and a two-body part
\begin{equation}
    \hat{H} = \hat{H}_0 + \hat{H}_I = \sum_{i=1}^A \hat{h}_0(x_i) +
    \sum_{i < j}^A \hat{v}(r_{ij}),
\label{Hnuclei}
\end{equation}
with
\begin{equation}
  H_0=\sum_{i=1}^A \hat{h}_0(x_i).
\label{hinuclei}
\end{equation}
The one-body operator is defined as
\[
\hat{h}_0(x_i)=\hat{t}(x_i) + \hat{u}_{\mathrm{ext}}(x_i),
\]
where $\hat{t}$ represents the kinetic energy and $x_i$ represents
both spatial and spin degrees of freedom.  For many-body calculations
of finite nuclei, the external potential $u_{\mathrm{ext}}(x_i)$ is
normally approximated by a harmonic oscillator or Woods-Saxon
potential. For atoms, the external potential is defined by the Coulomb
interaction an electron feels from the atomic nucleus. However, other
potentials are fully possible, such as one derived from the
self-consistent solution of the Hartree-Fock equations to be discussed
below. Since we will work with infinite matter and plane wave basis states, the one-body operator is
simply given by the kinetic energy operator.

Our Hamiltonian is invariant under the permutation (interchange) of
two particles.  Since we deal with fermions however, the total wave
function is anti-symmetric.  Let $\hat{P}$ be an operator which
interchanges two particles.  Due to the symmetries we have ascribed to
our Hamiltonian, this operator commutes with the total Hamiltonian,
\[
[\hat{H},\hat{P}] = 0,
 \]
meaning that a many-body eigenstate $\Psi_{\lambda}(x_1, x_2, \dots ,
x_A)$ of $\hat{H}$ is an eigenfunction of $\hat{P}$ as well.

In our case we assume that we can approximate the exact eigenfunction
for say the ground state with a Slater determinant
\begin{equation}
   \Phi_0(x_1, x_2,\dots ,x_A,\alpha,\beta,\dots,
   \sigma)=\frac{1}{\sqrt{A!}}  \left| \begin{array}{ccccc}
     \psi_{\alpha}(x_1)& \psi_{\alpha}(x_2)& \dots & \dots &
     \psi_{\alpha}(x_A)\\ \psi_{\beta}(x_1)&\psi_{\beta}(x_2)& \dots &
     \dots & \psi_{\beta}(x_A)\\ \dots & \dots & \dots & \dots & \dots
     \\ \dots & \dots & \dots & \dots & \dots
     \\ \psi_{\sigma}(x_1)&\psi_{\sigma}(x_2)& \dots & \dots &
     \psi_{\sigma}(x_A)\end{array} \right|, \label{eq:HartreeFockDet}
\end{equation}
where $x_i$ stand for the coordinates and spin values of particle
$i$ and $\alpha,\beta,\dots, \gamma$ are quantum numbers needed to
describe remaining quantum numbers.

The single-particle function $\psi_{\alpha}(x_i)$ are eigenfunctions
of the one-body Hamiltonian $h_0$, that is
\[
\hat{h}_0(x_i) \psi_{\alpha}(x_i)=\left(\hat{t}(x_i) +
\hat{u}_{\mathrm{ext}}(x_i)\right)\psi_{\alpha}(x_i)=\varepsilon_{\alpha}\psi_{\alpha}(x_i).
\]
The energies $\varepsilon_{\alpha}$ are the so-called non-interacting
single-particle energies, or unperturbed energies.  The total energy
is in this case the sum over all single-particle energies, if no
two-body or more complicated many-body interactions are present.

The properties of the determinant lead to a straightforward
implementation of the Pauli principle since no two particles can be at
the same place (two columns being the same in the above determinant)
and no two particles can be in the same state (two rows being the
same).  As a practical matter, however, Slater determinants beyond
$N=4$ quickly become unwieldy. Thus we turn to the occupation
  representation or second quantization to simplify
calculations. For a good introduction to second quantization see for
examples Ref.~\cite{shavittbartlett2009}.

We start with a set of orthonormal single-particle states $\{
\psi_{\alpha}(x) \}$.  To each single-particle state
$\psi_{\alpha}(x)$ we associate a creation operator
$a^\dagger_{\alpha}$ and an annihilation operator $a_{\alpha}$.  When
acting on the vacuum state $| 0 \rangle$, the creation operator
$a^\dagger_{\alpha}$ causes a particle to occupy the single-particle
state $\psi_{\alpha}(x)$
\[
\psi_{\alpha}(x) \rightarrow a^\dagger_{\alpha} |0 \rangle.
\]
But with multiple creation operators we can occupy multiple states
\[
\psi_{\alpha}(x) \psi_{\beta}(x^\prime) \psi_{\delta}(x^{\prime
  \prime}) \rightarrow a^\dagger_{\alpha} a^\dagger_{\beta}
a^\dagger_{\delta} |0 \rangle.
\]

Now we impose anti-symmetry by having the fermion operators satisfy
the anti-commutation relations
\[
a^\dagger_{\alpha} a^\dagger_{\beta} + a^\dagger_{\beta}
a^\dagger_{\alpha} = \left\{ a^\dagger_{\alpha}
,a^\dagger_{\beta}\right\}= 0,
\]
with the consequence that
\[
a^\dagger_{\alpha} a^\dagger_{\beta} = - a^\dagger_{\beta}
a^\dagger_{\alpha}.
\]
Because of this property, we obtain $a^\dagger_{\alpha}
a^\dagger_{\alpha} = 0$, enforcing the Pauli exclusion principle.
Thus we can represent a Slater determinant using creation operators as
\[
a^\dagger_{\alpha} a^\dagger_{\beta} a^\dagger_{\delta} \ldots |0\rangle,
\]
where each index $\alpha,\beta,\delta, \ldots$ has to be unique.

We will now find it convenient to define a Fermi level and introduce a
new reference vacuum. The Fermi level is normally  defined in terms of all
occupied single-particle states below a certain
single-particle energy.  With the definition of a Fermi level, we can
in turn define our ansatz for the ground state, represented by a
Slater determinant $\Phi_0$.  We will throughout the rest of this
text use creation and annihilation operators to represent quantum
mechanical operators and states.  It means that our compact
representation for a given Slater determinant in Fock space is
\[
  \Phi_{0}=|i_1 \dots i_A\rangle= a_{i_1}^{\dagger} \dots
  a_{i_A}^{\dagger} |0\rangle
\]
where $\vert 0\rangle$ is the true vacuum and we have defined the
creation and annihilation operators as
    \[
        a_p^\dagger|0\rangle = |p\rangle, \quad a_p |q\rangle =
        \delta_{pq}|0\rangle
    \]
with the anti-commutation relations
\[
  \delta_{pq} = \left\{a_p, a_q^\dagger \right\},
\]
and
\[
\left\{a_p^\dagger, a_q \right\} = \left\{a_p, a_q \right\} =
\left\{a_p^\dagger, a_q^\dagger \right\}=0.
\]

We can rewrite the ansatz for the ground state as
\[
\vert\Phi_0\rangle = \prod_{i\le F}a_{i}^{\dagger} |0\rangle,
\]
where we have introduced the shorthand labels for states below the
Fermi level $F$ as $i,j,\ldots \leq F$. For single-particle states
above the Fermi level we reserve the labels $a,b,\ldots > F$, while
the labels $p,q, \ldots$ represent any possible single particle state.


Since our focus is on infinite systems, the one-body part of the
Hamiltonian is given by the kinetic energy operator only.  In second
quantization it is defined as
\[
\hat{H}_0=\hat{T} = \sum_{pq} \langle p|\hat{t}|q\rangle a_p^\dagger
a_q,
\]
where the matrix elements $\langle p|\hat{t}|q\rangle$ are defined in
Eq.~(\ref{eq:kineticenergy}).  The two-body interaction reads
\[
\hat{H}_I=\hat{V} = \frac{1}{4} \sum_{pqrs} \langle
pq|\hat{v}|rs\rangle_{AS} a_p^\dagger a_q^\dagger a_s a_r,
\]
where we have defined the anti-symmetrized matrix elements
\[
\langle pq|\hat{v}|rs\rangle_{AS} = \langle pq|\hat{v}|rs\rangle -
\langle pq|\hat{v}|sr\rangle.
\]

We can also define a three-body operator
\[
\hat{V}_3 = \frac{1}{36} \sum_{pqrstu} \langle
pqr|\hat{v}_3|stu\rangle_{AS} a_p^\dagger a_q^\dagger a_r^\dagger a_u
a_t a_s,
\]
with the anti-symmetrized matrix element
\begin{align}
            \langle pqr|\hat{v}_3|stu\rangle_{AS} = \langle
            pqr|\hat{v}_3|stu\rangle + \langle
            pqr|\hat{v}_3|tus\rangle + \langle
            pqr|\hat{v}_3|ust\rangle- \langle pqr|\hat{v}_3|sut\rangle
            - \langle pqr|\hat{v}_3|tsu\rangle - \langle
            pqr|\hat{v}_3|uts\rangle.
\end{align}
In this and the forthcoming chapters we will limit ourselves to
two-body interactions at most.  Throughout this chapter and the subsequent three we will drop the subscript $AS$ and use only anti-symmetrized matrix elements.

Using the ansatz for the ground state $\vert \Phi_0\rangle$ as new reference
vacuum state, we need to redefine the anticommutation relations to
\[
\left\{a_p^\dagger, a_q \right\}= \delta_{pq}, p, q \leq F,
\]
and
\[
\left\{a_p, a_q^\dagger \right\} = \delta_{pq}, \hspace{0.1cm} p, q > F.
\]
It is easy to see that
\[
        a_i|\Phi_0\rangle = |\Phi_i\rangle\ne 0, \hspace{0.5cm}
        a_a^\dagger|\Phi_0\rangle = |\Phi^a\rangle\ne 0,
\]
and
\[
a_i^\dagger|\Phi_0\rangle = 0 \hspace{0.5cm} a_a|\Phi_0\rangle = 0.
\]
With the new reference vacuum state the Hamiltonian can be rewritten
as, see problem \ref{problem:prob8.1},
\[
\hat{H}=E_{\mathrm{Ref}}+\hat{H}_N,
\]
with the reference energy defined as the expectation value of the
Hamiltonian using the reference state $\Phi_0$
\[
E_{\mathrm{Ref}}=\langle \Phi_0 \vert \hat{H} \vert \Phi_0\rangle =
\sum_{i\le F} \langle i|\hat{h}_0|i\rangle + \frac{1}{2} \sum_{ij\le
  F}\langle ij|\hat{v}|ij\rangle,
\]
and the new normal-ordered Hamiltonian is defined as
\begin{equation}\label{eq:Hnormalorder}
\hat{H}_N = \sum_{pq} \langle p|\hat{h}_0|q\rangle \left\{a^\dagger_p
a_q\right\}+\frac{1}{4} \sum_{pqrs} \langle pq|\hat{v}|rs\rangle
\left\{a^\dagger_p a^\dagger_q a_s a_r\right\}+\sum_{pq,i\le F}
\langle pi|\hat{v}|qi\rangle \left\{a^\dagger_p a_q\right\},
\end{equation}
where the curly brackets represent normal-ordering with respect to the
new reference vacuum state.  The normal-ordered Hamiltonian can be
rewritten in terms of a new one-body operator and a two-body operator
as
\[
\hat{H}_N=\hat{F}_N+\hat{V}_N,
\]
with
\begin{equation}\label{eq:hfn}
\hat{F}_N=\sum_{pq} \langle p|\hat{f}|q\rangle \left\{a^\dagger_pa_q\right\},
\end{equation}
where
\[
\langle p|\hat{f}|q\rangle= \langle p|\hat{h}_0|q\rangle +\sum_{i\le F}
\langle pi|\hat{v}|qi\rangle.
\]
The last term on the right hand side represents a medium modification
to the single-particle Hamiltonian due to the two-body interaction.
Finally, the two-body interaction is given by
\begin{equation}\label{eq:hvn}	     
\hat{V}_N = \frac{1}{4} \sum_{pqrs} \langle pq|\hat{v}|rs\rangle
\left\{a^\dagger_p a^\dagger_q a_s a_r\right\}.
\end{equation}	     

\subsection{Single-particle basis for infinite matter}

Infinite nuclear or neutron matter is a homogeneous system and the
one-particle wave functions are given by plane wave functions
normalized to a volume $\Omega$ for a box with length $L$ (the limit
$L\rightarrow \infty$ is to be taken after we have computed various
expectation values)
\[
\psi_{\mathbf{k}\sigma}(\mathbf{r})=
\frac{1}{\sqrt{\Omega}}\exp{(i\mathbf{kr})}\xi_{\sigma}
\]
where $\mathbf{k}$ is the wave number and $\xi_{\sigma}$ is the spin
function for either spin up or down nucleons
\[ 
\xi_{\sigma=+1/2}=\left(\begin{array}{c} 1
  \\ 0 \end{array}\right) \hspace{0.5cm}
\xi_{\sigma=-1/2}=\left(\begin{array}{c} 0 \\ 1 \end{array}\right).
\]

We focus first on the kinetic energy operator.  We assume that we have
periodic boundary conditions which limit the allowed wave numbers to
\[
k_i=\frac{2\pi n_i}{L}\hspace{0.5cm} i=x,y,z \hspace{0.5cm} n_i=0,\pm
1,\pm 2, \dots
\]
The operator for the kinetic energy can be written as, see problem
\ref{problem:prob8kinetic},
\[
\hat{T}=\sum_{\mathbf{p}\sigma_p}\frac{\hbar^2k_P^2}{2m}a_{\mathbf{p}\sigma_p}^{\dagger}a_{\mathbf{p}\sigma_p}.
\]
When using periodic boundary conditions, the discrete-momentum
single-particle basis functions (excluding spin and/or isospin degrees
of freedom) result in the following single-particle energy
\begin{align}
  \varepsilon_{n_{x}, n_{y}, n_{z}} = \frac{\hbar^{2}}{2m} \left(
  \frac{2\pi }{L}\right)^{2} \left( n_{x}^{2} + n_{y}^{2} +
  n_{z}^{2}\right)=\frac{\hbar^2}{2m}\left(k_{n_x}^2+k_{n_y}^2+k_{n_z}^2\right),
\end{align} 
for a three-dimensional system with
\[
k_{n_i}=\frac{2\pi n_i}{L} \hspace{0.1cm} n_i = 0, \pm 1, \pm 2,
\dots,
\]
We will select the single-particle basis such that both the occupied
and unoccupied single-particle spaces have a closed-shell
structure. This means that all single-particle states corresponding to
energies below a chosen cutoff are included in the basis. We study
only the unpolarized spin phase, in which all orbitals are occupied
with one spin-up and one spin-down fermion (neutrons and protons in
our case).  With the kinetic energy rewritten in terms of the
discretized momenta we can set up a similar table and obtain (assuming
identical particles one and including spin up and spin down solutions)
for energies less than or equal to $n_{x}^{2}+n_{y}^{2}+n_{z}^{2}\le
3$, as shown in Table \ref{tab:table1}
\begin{table}
\begin{center}
\caption{Total number of particle filling $N_{\uparrow \downarrow }$
  for various $n_{x}^{2}+n_{y}^{2}+n_{z}^{2}$ values for one spin-1/2
  fermion species.  Borrowing from nuclear shell-model terminology,
  filled shells corresponds to all single-particle states for one
  $n_{x}^{2}+n_{y}^{2}+n_{z}^{2}$ value being occupied.  For matter
  with both protons and neutrons, the filling degree increased with a
  factor of $2$.} \label{tab:table1}
\begin{tabular}{ccccc}
\hline \multicolumn{1}{c}{ $n_{x}^{2}+n_{y}^{2}+n_{z}^{2}$ } &
\multicolumn{1}{c}{ $n_{x}$ } & \multicolumn{1}{c}{ $n_{y}$ } &
\multicolumn{1}{c}{ $n_{z}$ } & \multicolumn{1}{c}{ $N_{\uparrow
    \downarrow }$ } \\ \hline 0 & 0 & 0 & 0 & 2 \\ \hline 1 & -1 & 0 &
0 & \\ 1 & 1 & 0 & 0 & \\ 1 & 0 & -1 & 0 & \\ 1 & 0 & 1 & 0 & \\ 1 & 0
& 0 & -1 & \\ 1 & 0 & 0 & 1 & 14 \\ \hline 2 & -1 & -1 & 0 & \\ 2 & -1
& 1 & 0 & \\ 2 & 1 & -1 & 0 & \\ 2 & 1 & 1 & 0 & \\ 2 & -1 & 0 & -1 &
\\ 2 & -1 & 0 & 1 & \\ 2 & 1 & 0 & -1 & \\ 2 & 1 & 0 & 1 & \\ 2 & 0 &
-1 & -1 & \\ 2 & 0 & -1 & 1 & \\ 2 & 0 & 1 & -1 & \\ 2 & 0 & 1 & 1 &
38 \\ \hline 3 & -1 & -1 & -1 & \\ 3 & -1 & -1 & 1 & \\ 3 & -1 & 1 &
-1 & \\ 3 & -1 & 1 & 1 & \\ 3 & 1 & -1 & -1 & \\ 3 & 1 & -1 & 1 & \\ 3
& 1 & 1 & -1 & \\ 3 & 1 & 1 & 1 & 54 \\ \hline
\end{tabular}
\end{center}
\end{table}


Continuing in this way we get for $n_{x}^{2}+n_{y}^{2}+n_{z}^{2}=4$ a
total of 22 additional states, resulting in $76$ as a new magic
number. For the lowest six energy values the degeneracy in energy
gives us $2$, $14$, $38$, $54$, $76$ and $114$ as magic numbers. These
numbers will then define our Fermi level when we compute the energy in
a Cartesian basis. When performing calculations based on many-body
perturbation theory, Coupled cluster theory or other many-body
methods, we need then to add states above the Fermi level in order to
sum over single-particle states which are not occupied.

If we wish to study infinite nuclear matter with both protons and
neutrons, the above magic numbers become $4, 28, 76, 108, 132, 228,
\dots$.

Every number of particles for filled shells defines also the number of
particles to be used in a given calculation. The number of particles
can in turn be used to define the density $n$ (or the Fermi momentum)
of the system via
\[
n = g \frac{k_F^3}{6\pi^2},
\]
where $k_F$ is the Fermi momentum and the degeneracy $g$, which is two
for one type of spin-$1/2$ particles and four for symmetric nuclear
matter.  With the density defined and having fixed the number of
particles $A$ and the Fermi momentum $k_F$, we can define the length
$L$ of the box used with periodic boundary contributions via the
relation
\[
  V= L^3= \frac{A}{n}.
\]
With $L$ we can to define the spacing between various
$k$-values given by
\[
  \Delta k = \frac{2\pi}{L}.
\]
Here, $A$ is the number of nucleons. If we deal with the electron
gas only, this needs to be replaced by the number of electrons $N$.
Exercise \ref{problem:spbasissetup} deals with setting up a program
that establishes the single-particle basis for nuclear matter
calculations with input a given number of nucleons and a user
specificied density or Fermi momentum.


\subsection{Two-body interaction}

As mentioned above, we will employ a plane wave basis for our
calculations of infinite matter properties. With a cartesian basis it
means that we can calculate directly the various matrix elements, as
discussed in the previous subsection. However, a cartesian basis
represents an approximation to the thermodynamical limit. In order to
compare the stability of our basis with results from the
thermodynamical limit, it is convenient to rewrite the nucleon-nucleon
interaction in terms of a partial wave expansion. This will allow us
to compute the Hartree-Fock energy of the ground state in the
thermodynamical limit (with the caveat that we need to limit the
number of partial waves). In order to find the expressions for the
Hartree-Fock energy in a partial wave basis, we will find it
convenient to rewrite our two-body force in terms of the relative and
center-of-mass motion momenta.

The direct matrix element, with single-particle three-dimensional
momenta $\mathbf{k}_p$, spin $\sigma_p$ and isospin $\tau_p$, is
defined as
\[
\langle \mathbf{k}_p\sigma_p\tau_p \mathbf{k}_q\sigma_q\tau_q \vert
\hat{v}\vert \mathbf{k}_r\sigma_r\tau_r \mathbf{k}_s\sigma_s\tau_s
\rangle,
\]
or in a more compact form as $\langle \mathbf{p}\mathbf{q}\vert
\hat{v} \vert \mathbf{r}\mathbf{s} \rangle$ where the boldfaced
letters $\mathbf{p}$ etc represent the relevant quantum numbers, here
momentum, spin and isospin. Introducing the relative momentum
\[
\mathbf{k} = \frac{1}{2}\left(\mathbf{k}_p-\mathbf{k}_q\right),
\]
and the center-of-mass momentum
\[
\mathbf{K} = \mathbf{k}_p+\mathbf{k}_q,
\]
we have
\[
\langle \mathbf{k}_p\sigma_p\tau_p \mathbf{k}_q\sigma_q\tau_q \vert
\hat{v}\vert \mathbf{k}_r\sigma_r\tau_r \mathbf{k}_s\sigma_s\tau_s
\rangle=\langle \mathbf{k}\mathbf{K}\sigma_p\tau_p \sigma_q\tau_q
\vert \hat{v}\vert \mathbf{k}'\mathbf{K}'\sigma_r\tau_r \sigma_s\tau_s
\rangle.
\]
The nucleon-nucleon interaction conserves the total momentum and
charge, implying that the above uncoupled matrix element reads
\[
\langle \mathbf{k}\mathbf{K}\sigma_p\tau_p \sigma_q\tau_q \vert
\hat{v}\vert \mathbf{k}'\mathbf{K}'\sigma_r\tau_r \sigma_s\tau_s
\rangle=\delta_{T_z,T_z'}\delta(\mathbf{K}-\mathbf{K}')\langle
\mathbf{k}T_zS_z=(\sigma_a+\sigma_b) \vert \hat{v}\vert
\mathbf{k}'T_zS_z'=(\sigma_c+\sigma_d) \rangle,
\]
where we have defined the isospin projections $T_z=\tau_p+\tau_q$ and
$T_z'=\tau_r+\tau_s$.  Defining
$\hat{v}=\hat{v}(\mathbf{k},\mathbf{k}' )$, we can rewrite the
previous equation in a more compact form as
\[
\delta_{T_z,T_z'}\delta(\mathbf{K}-\mathbf{K}')\langle
\mathbf{k}T_zS_z=(\sigma_p+\sigma_q) \vert \hat{v}\vert
\mathbf{k}'T_zS_z'=(\sigma_r+\sigma_s)
\rangle=\delta_{T_z,T_z'}\delta(\mathbf{K}-\mathbf{K}')\langle
T_zS_z\vert\hat{v}(\mathbf{k},\mathbf{k}' ) \vert T_zS_z' \rangle.
\]
These matrix elements can in turn be rewritten in terms of the total
two-body quantum numbers for the spin $S$ of two spin-1/2 fermions as
\[
\langle \mathbf{k}T_zS_z \vert \hat{v}(\mathbf{k},\mathbf{k}' )\vert
\mathbf{k}'T_zS_z' \rangle=\sum_{SS'}\langle
\frac{1}{2}\sigma_p\frac{1}{2}\sigma_q\vert SS_z\rangle \langle
\frac{1}{2}\sigma_r\frac{1}{2}\sigma_s\vert S'S_z'\rangle \langle
\mathbf{k}T_zSS_z\vert \hat{v}(\mathbf{k},\mathbf{k}' )\vert
\mathbf{k}T_zS'S_z' \rangle
\]
The coefficients $\langle \frac{1}{2}\sigma_p\frac{1}{2}\sigma_q\vert
SS_z\rangle$ are so-called Clebsch-Gordan recoupling coefficients.  We
will assume that our interactions break charge and isospin
symmetry. We will refer to $T_z=0$ as the $pn$ (proton-neutron)
channel, $T_z=-1$ as the $pp$ (proton-proton) channel and $T_z=1$ as
the $nn$ (neutron-neutron) channel.

The nucleon-nucleon force is often derived and analyzed theoretically
in terms of a partial wave expansion. A state with linear momentum
$\mathbf{k}$ can be written as
\[
\vert \mathbf{k} \rangle =
\sum_{l=0}^{\infty}\sum_{l_l=-l}^{L}\imath^lY_{l}^{m_l}(\hat{k}\vert
klm_l\rangle.
\]

In terms of the relative and center-of-mass momenta $\mathbf{k}$ and
$\mathbf{K}$, the potential in momentum space is related to the
nonlocal operator $V(\mathbf{r},\mathbf{r}')$ by
\begin{equation}
      \langle \mathbf{k'K'}\vert \hat{v} \vert \mathbf{k'K} \rangle=
      \int d\mathbf{r}d \mathbf{r'} e^{-\imath
        \mathbf{k'r'}}V(\mathbf{r'},\mathbf{r}) e^{\imath \mathbf{kr}}
      \delta(\mathbf{K},\mathbf{K'}).
\end{equation}
We will assume that the interaction is spherically symmetric and use
the partial wave expansion of the plane waves in terms of spherical
harmonics.  This means that we can separate the radial part of the
wave function from its angular dependence. The wave function of the
relative motion is described in terms of plane waves as
\begin{equation}
       e^{\imath \mathbf{kr}} = \langle\mathbf{r}\vert
       \mathbf{k}\rangle = 4\pi \sum_{lm} \imath ^{l} j_{l} (kr)
       Y_{lm}^{*}(\mathbf{\hat{k}}) Y_{lm}(\mathbf{\hat{r}}),
\end{equation}
where $j_l$ is a spherical Bessel function and $Y_{lm}$ the spherical
harmonic.  This partial wave basis is useful for defining the operator
for the nucleon-nucleon interaction, which is symmetric with respect
to rotations, parity and isospin transformations. These symmetries
imply that the interaction is diagonal with respect to the quantum
numbers of total angular momentum $J$, spin $S$ and isospin $T$. Using
the above plane wave expansion, and coupling to final $J$, $S$ and $T$
we get
\begin{equation}
      \langle \mathbf{k'}\vert V \vert \mathbf{k}\rangle = (4\pi)^2
      \sum_{JM}\sum_{lm}\sum_{l'm'} \imath ^{l+l'}
      Y_{lm}^{*}(\mathbf{\hat{k}}) Y_{l'm'}(\mathbf{\hat{k}'}) {\cal
        C}_{m'M_SM}^{l'SJ}{\cal C}_{mM_SM}^{lSJ} \langle k'l'STJM
      \vert V \vert klSTJM \rangle,
\label{eq:vpartial}
\end{equation}
where we have defined
\begin{equation}
    \langle k'l'STJM\vert V \vert klSTJM\rangle = \int
    j_{l'}(k'r')\langle l'STJM\vert V(r',r)\vert lSTJM \rangle j_l(kr)
    {r'}^2 dr' r^2 dr.
\end{equation}
We have omitted the momentum of the center-of-mass motion $\mathbf{K}$
and the corresponding orbital momentum $L$, since the interaction is
diagonal in these variables. The potentials we will employ in this
work, like those of the Bonn group, are all non-local potentials
defined in momentum space, and we will therefore not need the last
equation.


The interaction we will use for these calculations is a semirealistic
nucleon-nucleon potential known as the Minnesota potential
\cite{minnesota} which has the form, $V_{\alpha}\left(
r\right)=V_{\alpha}\exp{(-\alpha r^{2})}$. The spin and isospin
dependence of the Minnesota potential is given by,
\begin{equation}
V\left( r\right)=\frac{1}{2}\left( V_{R}+\frac{1}{2}\left(
1+P_{12}^{\sigma}\right) V_{T}+\frac{1}{2}\left(
1-P_{12}^{\sigma}\right) V_{S}\right)\left(
1-P_{12}^{\sigma}P_{12}^{\tau}\right),
\end{equation}
where $P_{12}^{\sigma}=\frac{1}{2}\left(
1+\sigma_{1}\cdot\sigma_{2}\right)$ and
$P_{12}^{\tau}=\frac{1}{2}\left( 1+\tau_{1}\cdot\tau_{2}\right)$ are
the spin and isospin exchange operators, respectively. A Fourier
transform to momentum space of the radial part $V_{\alpha}\left(
r\right)$ is rather simple, see problem \ref{problem:fourier}, since
the radial depends only on the magnitude of the relative distance and
thereby the relative momentum
$\vec{q}=\frac{1}{2}\left(\vec{k}_{p}-\vec{k}_{q}-\vec{k}_{r}+\vec{k}_{s}\right)$. Omitting
spin and isospin dependencies, the momentum space version of the
interaction reads
\begin{equation}
\langle \mathbf{k}_p \mathbf{k}_q \vert V_{\alpha}\vert
\mathbf{k}_r\mathbf{k}_s\rangle=\frac{V_{\alpha}}{L^{3}}\left(\frac{\pi}{\alpha}\right)^{3/2}\exp{(\frac{-q^{2}}{4\alpha})}\delta_{\vec{k}_{p}+\vec{k}_{q},\vec{k}_{r}+\vec{k}_{s}}
\end{equation}
The various parameters defining the interaction model used in this
work are listed in Table \ref{tab:minnesotatab}.
\begin{table}
\caption{Parameters used to define the Minnesota interaction model
  \cite{minnesota}.}\label{tab:minnesotatab}
\begin{center}
  \begin{tabular}{| l | l | l |}
    \hline $\alpha$ & $V_{\alpha}$ & $\kappa_{\alpha}$ \\ \hline $R$ &
    200 $\mathrm{MeV}$ & 1.487 $\mathrm{fm}^{-2}$ \\ \hline $T$ & 178
    $\mathrm{MeV}$ & 0.639 $\mathrm{fm}^{-2}$ \\ \hline $S$ & 91.85
    $\mathrm{MeV}$ & 0.465 $\mathrm{fm}^{-2}$ \\ \hline
  \end{tabular}
\end{center}
\end{table}


\subsection{Models from Effective field theory for the two- and three-nucleon interactions}\label{subsec:forcemodels}

During the past two decades it has been demonstrated that chiral
effective field theory represents a powerful tool to deal with
hadronic interactions at low energy in a systematic and
model-independent way (see
Refs.~\cite{weinberg1990,weinberg1991,ordonez1992,ordonez1994,ordonez1996,vankolck1999,machleidt2011,epelbaum2009,ekstrom2013,ekstromPRX}).
Effective field theories (EFTs) are defined in terms of effective Lagrangians which are given by
an infinite series of terms with increasing number of derivatives
and/or nucleon fields, with the dependence of each term on the pion
field prescribed by the rules of broken chiral symmetry.  Applying
this Lagrangian to a particular process, an unlimited number of
Feynman graphs can be drawn. Therefore, a scheme is needed that makes
the theory manageable and calculable.  This scheme which tells us how
to distinguish between large (important) and small (unimportant)
contributions is chiral perturbation theory (ChPT).  Chiral perturbation theory  allows for
an expansion in terms of $(Q/\Lambda_\chi)^\nu$, where $Q$ is generic
for an external momentum (nucleon three-momentum or pion
four-momentum) or a pion mass, and $\Lambda_\chi \sim 1$ GeV is the
chiral symmetry breaking scale.  Determining the power $\nu$ has
become known as power counting.

Nuclear potentials are defined as sets of irreducible graphs up to a
given order.  The power $\nu$ of a few-nucleon diagram involving $A$
nucleons is given in terms of naive dimensional analysis by:
\begin{equation} 
\nu = -2 +2A - 2C + 2L + \sum_i \Delta_i \, ,
\label{eq_nu} 
\end{equation}
with
\begin{equation}
\Delta_i \equiv d_i + \frac{n_i}{2} - 2 \, ,
\label{eq_Deltai}
\end{equation}
where $A$ labels the number of nucleons, $C$ denotes the number of separately connected pieces and $L$
the number of loops in the diagram; $d_i$ is the number of derivatives
or pion-mass insertions and $n_i$ the number of nucleon fields
(nucleon legs) involved in vertex $i$; the sum runs over all vertices
contained in the diagram under consideration.  Note that $\Delta_i
\geq 0$ for all interactions allowed by chiral symmetry.  In this work
we will focus on optimized two- and three-nucleon forces at order
NNLO, as indicated in Fig.~\ref{fig_diagNNLO}.  

Below we revisit briefly the formalism and results presented in
Refs.~\cite{ekstromPRX}. For further details on chiral effective
field theory and nuclear interactions, see for example
Refs.~\cite{machleidt2011,epelbaum2009,ekstrom2013}
\begin{figure}[t]\centering
%\vspace*{-0.25cm}
\scalebox{0.14}{\includegraphics{Chapter8-figures/diagNNLO.pdf}}
%\vspace*{-1.0cm}
\caption{Nuclear forces in ChPT up to NNLO. Solid lines represent
  nucleons and dashed lines pions.  Small dots, large solid dots, and
  solid squares denote vertices of index $\Delta_i= \, $ 0, 1, and 2,
  respectively.}
\label{fig_diagNNLO}
\end{figure}
For an irreducible $NN$ diagram (``two-nucleon potential'', $A=2$,
$C=1$), Eq.~(\ref{eq_nu}) collapses to
\begin{equation} 
\nu = 2L + \sum_i \Delta_i \, .
\label{eq_nunn} 
\end{equation}
Thus, in terms of naive dimensional analysis or ``Weinberg counting''
\cite{weinberg1990,weinberg1991}, the various orders of the
irreducible graphs which define the chiral $NN$ potential are given by
(cf.\ Fig.~\ref{fig_diagNNLO})
\begin{eqnarray}
V_{\rm LO} & = & V_{\rm ct}^{(0)} + V_{1\pi}^{(0)}
\label{eq_VLO}
\\ V_{\rm NLO} & = & V_{\rm LO} + V_{\rm ct}^{(2)} + V_{1\pi}^{(2)} +
V_{2\pi}^{(2)}
\label{eq_VNLO}
\\ V_{\rm NNLO} & = & V_{\rm NLO} + V_{1\pi}^{(3)} + V_{2\pi}^{(3)}
\label{eq_VNNLO}
\end{eqnarray}
where the superscript denotes the order $\nu$ of the low-momentum
expansion.  LO stands for leading order, NLO for next-to-leading order
and NNLO stands for next-to-next-to leading order.  Contact potentials
carry the subscript ``ct'' and pion-exchange potentials can be
identified by an obvious subscript.

The charge-independent one-pion-exchange (1PE) potential reads
\begin{equation}
V_{1\pi} ({\vec k}~', \vec k) = -
%\frac{1}{(2\pi)^3} \,
\frac{g_A^2}{4f_\pi^2} \: {\vec \tau}_1 \cdot {\vec \tau}_2 \: \frac{
  \vec \sigma_1 \cdot \vec q \,\, \vec \sigma_2 \cdot \vec q} {q^2 +
  m_\pi^2} \,,
\label{eq:eq_1PEci}
\end{equation}
where ${\vec k}~'$ and $\vec k$ represent the final and initial
nucleon momenta in the center-of-mass system (CMS) and $\vec q \equiv
{\vec k}~' - \vec k$ is the momentum transfer; $\vec \sigma_{1,2}$ and
$\vec \tau_{1,2}$ are the spin and isospin operators of nucleon 1 and
2; $g_A$, $f_\pi$, and $m_\pi$ denote axial-vector coupling constant,
the pion decay constant, and the pion mass, respectively.  Since
higher order corrections contribute only to mass and coupling constant
renormalizations and since, on shell, there are no relativistic
corrections, the on-shell 1PE has the form of Eq.~(\ref{eq:eq_1PEci})
to all orders.

It is well known that for high-precision $NN$ potentials, charge
dependence is important.  Therefore, we will take the charge
dependence of the 1PE into account.  Defining a pion-mass dependent
1PE by
\[
V_{1\pi} (m_\pi) \equiv - \,
%\frac{1}{(2\pi)^3} \,
\frac{g_A^2}{4f_\pi^2} \, \frac{ \vec \sigma_1 \cdot \vec q \,\, \vec
  \sigma_2 \cdot \vec q} {q^2 + m_\pi^2} \,,
\]
the 1PE for proton-proton ($pp$) and neutron-neutron ($nn$) scattering
is
\[
V_{1\pi}^{(pp)} ({\vec k}~', \vec k) = V_{1\pi}^{(nn)} ({\vec k}~',
\vec k) = V_{1\pi} (m_{\pi^0}) \,,
\]
while for neutron-proton ($np$) scattering we have
\[
V_{1\pi}^{(np)} ({\vec k}~', \vec k) = -V_{1\pi} (m_{\pi^0}) +
(-1)^{T+1}\, 2\, V_{1\pi} (m_{\pi^\pm}) \,,
\]
where $T$ denotes the isospin of the two-nucleon system.  We use
$m_{\pi^0}=134.9766$ MeV and $m_{\pi^\pm}=139.5702$ MeV.  For the
leading-order, next-to-leading order and NNLO, we refer the reader to
Refs.~\cite{machleidt2011,ekstromPRX}.  The final interaction at
order NNLO is multiplied with the following factors
\cite{machleidt2011},
\begin{equation}
\widehat{V}({\vec k}~',{\vec k}) \equiv \frac{1}{(2\pi)^3}
\sqrt{\frac{M_N}{E_{p'}}}\: {V}({\vec p}~',{\vec p})\:
\sqrt{\frac{M_N}{E_{p}}}
\label{eq_minrel1}
\end{equation}
with $E_p=\sqrt{M_N^2+p^2}$ and where the factor $1/(2\pi)^3$ is just
added for convenience.  The potential $\widehat{V}$ satisfies the
nonrelativistic Lippmann-Schwinger (LS) equation,
\begin{equation}
 \widehat{T}({\vec k}~',{\vec k})= \widehat{V}({\vec k}~',{\vec k})+
 \int d^3p''\: \widehat{V}({\vec k}~',{\vec k}~'')\: \frac{M_N} {{
     k}^{2}-{k''}^{2}+i\epsilon}\: \widehat{T}({\vec k}~'',{\vec k})
 \, .
\label{eq_LS}
\end{equation}
In $pp$ scattering, we use $M_N=M_p=938.2720$ MeV, and in $nn$
scattering, $M_N=M_n=939.5653$ MeV.  Moreover, the on-shell momentum
is simply
\begin{equation}
p^2 = \frac12 M_N T_{\rm lab} \,,
\end{equation}
where $T_{\rm lab}$ denotes the kinetic energy of the incident nucleon
in the laboratory system (``Lab.\ Energy'').  For $np$ scattering, we
have
\begin{eqnarray}
M_N &=& \frac{2M_pM_n}{M_p+M_n} = 938.9182 \mbox{ MeV, and} \\ p^2 & =
& \frac{M_p^2 T_{\rm lab} (T_{\rm lab} + 2M_n)} {(M_p + M_n)^2 +
  2T_{\rm lab} M_p} \,,
\end{eqnarray}
which is based upon relativistic kinematics.

Iteration of $\widehat V$ in the Lippman-Schwinger equation, Eq.~(\ref{eq_LS}),
requires cutting $\widehat V$ off for high momenta to avoid
infinities.  This is consistent with the fact that ChPT is a
low-momentum expansion which is valid only for momenta $Q \ll
\Lambda_\chi \approx 1$ GeV.  Therefore, the potential $\widehat V$ is
multiplied with the regulator function $f(k',k)$,
\begin{equation}
{\widehat V}(\vec{ k}~',{\vec k}) \longmapsto {\widehat V}(\vec{
  k}~',{\vec k}) \, f(k',k)
\end{equation}
with
\begin{equation}
f(p',p) = \exp[-(p'/\Lambda)^{2n}-(p/\Lambda)^{2n}] \,.
\label{eq:eq_f}
\end{equation}


Up to NNLO in chiral perturbation theory there are, in addition to the
two-body interaction diagrams discussed above, also a few three-body
interaction diagrams, see Fig.~\ref{fig_diagNNLO}. In chiral
perturbation theory, the orders are generated systematically, and at a
given chiral order the number of Feynman diagrams is
finite. Consistency requires that a calculation includes all diagrams
which are present at the chosen order. In this work we employ chirally
consistent many-body calculations including all NNLO nuclear
interactions.

There are in total five contact terms that determine the strength of
the NNLO three-nucleon force (3NF); $c_1,c_3,$ and $c_4$ are
associated with the three-body two-pion-exchange (2PE) diagram, $c_D$
and $c_E$ determine the strength of the one-pion-exchange plus contact
(1PE) diagram and the pure contact (CNT) diagram,
respectively. Following the notation of Ref.~\cite{epelbaum2002} the
three-body diagrams are given by
\begin{equation}
V^{\textnormal{2PE}}_{ijk} = \sum_{i \neq j \neq k} \frac{1}{2} \left(
\frac{g_A}{f_{\pi}} \right)^2 \frac{(\vec{\sigma_i} \cdot
  \vec{q_i})(\vec{\sigma_j}\cdot \vec{q_j})}{(\vec{q_i}^2 +
  m_{\pi)}^2)(\vec{q_j}^2 + m_{\pi)}^2)} F_{ijk}^{\alpha \beta}
\tau_i^{\alpha}\tau_{j}^{\beta} \,,
\end{equation}
where $q_{i}$ denotes the momentum transfer associated with nucleon
$i$, and
\begin{align}
F_{ijk}^{\alpha \beta} ={}& \delta^{\alpha \beta} \left[
  -\frac{4c_1m_{\pi}^2}{f_{\pi}^2} +
  \frac{2c_3}{f_{\pi}^2}\vec{q_i}\cdot
  \vec{q_j}\right]\\ {}&+\sum_{\gamma}\frac{c_4}{f_{\pi}^2}\epsilon^{\alpha
  \beta \gamma} \tau_{k}^{\gamma} \vec{\sigma_k} \cdot [\vec{q_i}
  \times \vec{q_j}] \,.
\end{align}
For this diagram, no new parameters are introduced since the
$c_1,c_3,c_4$ appear already in the 2PE two-nucleon interaction. The
remaining two three-body terms are given by
\begin{equation}
V^{\textnormal{1PE}}_{ijk} = -\sum_{i \neq j \neq k}
\frac{g_A}{8f_{\pi}^2} \frac{c_D}{f_{\pi}^2\Lambda_{\chi}} \frac{
  (\vec{\sigma_j} \cdot \vec{q_j})}{(\vec{q_j}^2 + m_{\pi}^2)} (\tau_i
\cdot \tau_j)(\vec{\sigma_i}\cdot \vec{\sigma_j})
\end{equation}
and
\begin{equation}
V^{\textnormal{CNT}}_{ijk} = \frac{1}{2}\sum_{i \neq j \neq k}
\frac{c_E}{f_{\pi}^4 \Lambda_{\chi}} (\tau_i \cdot \tau_j)
\end{equation}
with $\Lambda_{\chi}=700$ MeV. Following~\cite{navratil2007}, we use a
regulator depending on the momentum-transfer $q$,
\begin{equation}
f(q) = \exp[-q^4/\Lambda]
\end{equation}
and thus obtain a local three-body force.

\section{Hartree-Fock theory}\label{sec:chap8hf}

Hartree-Fock (HF) theory is an algorithm for finding an approximative
expression for the ground state of a given Hamiltonian. The basic
ingredients contain a single-particle basis $\{\psi_{\alpha}\}$
defined by the solution of the following eigenvalue problem
\[ 
\hat{h}^{\mathrm{HF}}\psi_{\alpha} =\varepsilon_{\alpha}\psi_{\alpha},
\]
with the Hartree-Fock Hamiltonian defined as
\[
\hat{h}^{\mathrm{HF}}=\hat{t}+\hat{u}_{\mathrm{ext}}+\hat{u}^{\mathrm{HF}}.
\]

The term $\hat{u}^{\mathrm{HF}}$ is a single-particle potential to be
determined by the HF algorithm. The HF algorithm means to choose
$\hat{u}^{\mathrm{HF}}$ in order to have
\[ \langle \hat{H} \rangle = E^{\mathrm{HF}}= \langle \Phi_0^{HF} | \hat{H}|\Phi_0^{HF} \rangle,
\]
as a local minimum with a Slater determinant
$\Phi_0^{HF}$ being the ansatz for the ground state.  The variational
principle ensures that $E^{\mathrm{HF}} \ge E_0$, with $E_0$ the representing the exact
ground state energy.

We will show that the Hartree-Fock Hamiltonian $\hat{h}^{\mathrm{HF}}$
equals our definition of the operator $\hat{f}$ discussed in
connection with the new definition of the normal-ordered Hamiltonian,
that is we have, for a specific matrix element
\[
\langle p |\hat{h}^{\mathrm{HF}}| q \rangle =\langle p |\hat{f}| q
\rangle=\langle p|\hat{t}+\hat{u}_{\mathrm{ext}}|q \rangle +\sum_{i\le
  F} \langle pi | \hat{V} | qi\rangle,
\]
meaning that
\[
\langle p|\hat{u}^{\mathrm{HF}}|q\rangle = \sum_{i\le F} \langle pi |
\hat{V} | qi\rangle.
\]
The so-called Hartree-Fock potential $\hat{u}^{\mathrm{HF}}$ brings an
explicit medium dependence due to the summation over all
single-particle states below the Fermi level $F$. It brings also in an
explicit dependence on the two-body interaction (in nuclear physics we
can also have complicated three- or higher-body forces). The two-body
interaction, with its contribution from the other bystanding fermions,
creates an effective mean field in which a given fermion moves, in
addition to the external potential $\hat{u}_{\mathrm{ext}}$ which
confines the motion of the fermion. For systems like nuclei or
infinite nuclear matter, there is no external confining
potential. Nuclei and nuclear matter are examples of self-bound
systems, where the binding arises due to the intrinsic nature of the
strong force. For nuclear systems thus, there would be no external
one-body potential in the Hartree-Fock Hamiltonian.


Another possibility is to expand the single-particle functions in a
known basis and vary the coefficients, that is, the new
single-particle wave function is written as a linear expansion in
terms of a fixed chosen orthogonal basis (for example the well-known
harmonic oscillator functions or the hydrogen-like functions etc).  We
define our new Hartree-Fock single-particle basis by performing a
unitary transformation on our previous basis (labelled with greek
indices) as
\begin{equation}
\psi_p^{HF} = \sum_{\lambda}
C_{p\lambda}\phi_{\lambda}. \label{eq:newbasis}
\end{equation}
In this case we vary the coefficients $C_{p\lambda}$. If the basis has
infinitely many solutions, we need to truncate the above sum.  We
assume that the basis $\phi_{\lambda}$ is orthogonal. A unitary
transformation keeps the orthogonality, as discussed in problem
\ref{problem:unitarity} below.


It is normal to choose a single-particle basis defined as the
eigenfunctions of parts of the full Hamiltonian. The typical situation
consists of the solutions of the one-body part of the Hamiltonian,
that is we have
\[
\hat{h}_0\phi_{\lambda}=\epsilon_{\lambda}\phi_{\lambda}.
\]
For infinite nuclear matter $\hat{h}_0$ is given by the kinetic energy
operator and the states are given by plane wave functions. Due to the
translational invariance of the two-body interaction, the Hartree-Fock
single-particle eigenstates are also given by the same functions. For
infinite matter thus, it is only the single-particle energies that
change when we solve the Hartree-Fock equations.

The single-particle wave functions $\phi_{\lambda}({\bf r})$, defined
by the quantum numbers $\lambda$ and ${\bf r}$ are defined as the
overlap
\[
   \phi_{\lambda}({\bf r}) = \langle {\bf r} | \lambda \rangle .
\]
In our discussions we will use our definitions of single-particle
states above and below the Fermi ($F$).  


We use greek letters to refer to our original single-particle
basis. The expectation value for the energy with the ansatz $\Phi_0$
for the ground state reads (see problem \ref{problem:referenceE}, with
application to infinite nuclear matter)
\[
  E[\Phi_0] = \sum_{\mu=1}^A \langle \mu | h | \mu \rangle +
  \frac{1}{2}\sum_{{\mu}=1}^A\sum_{{\nu}=1}^A \langle
  \mu\nu|\hat{v}|\mu\nu\rangle.
\]
Now we are interested in defining a new basis defined in terms of a
chosen basis as defined in Eq.~(\ref{eq:newbasis}). We can then
rewrite the energy functional as
\begin{equation}
  E[\Phi^{HF}] = \sum_{i\le F} \langle i | h | i \rangle +
  \frac{1}{2}\sum_{ij\le F}\langle
  ij|\hat{v}|ij\rangle, \label{FunctionalEPhi2}
\end{equation}
where $\Phi^{HF}$ is the new Slater determinant defined by the new
basis of Eq.~(\ref{eq:newbasis}).





Using Eq.~(\ref{eq:newbasis}) we can rewrite
Eq.~(\ref{FunctionalEPhi2}) as
\begin{equation}
  E[\Psi] = \sum_{i\le F} \sum_{\alpha\beta}
  C^*_{i\alpha}C_{i\beta}\langle \alpha | h | \beta \rangle +
  \frac{1}{2}\sum_{ij\le F}\sum_{{\alpha\beta\gamma\delta}}
  C^*_{i\alpha}C^*_{j\beta}C_{i\gamma}C_{j\delta}\langle
  \alpha\beta|\hat{v}|\gamma\delta\rangle. \label{FunctionalEPhi3}
\end{equation}


We wish now to minimize the above functional. We introduce a set of
Lagrange multipliers, noting that since $\langle i | j \rangle =
\delta_{i,j}$ and $\langle \alpha | \beta \rangle =
\delta_{\alpha,\beta}$, the coefficients $C_{i\gamma}$ obey the
relation
\[
 \langle i | j \rangle=\delta_{i,j}=\sum_{\alpha\beta}
 C^*_{i\alpha}C_{i\beta}\langle \alpha | \beta \rangle= \sum_{\alpha}
 C^*_{i\alpha}C_{i\alpha},
\]
which allows us to define a functional to be minimized that reads
\begin{equation}
  F[\Phi^{HF}]=E[\Phi^{HF}] - \sum_{i\le F}\epsilon_i\sum_{\alpha}
  C^*_{i\alpha}C_{i\alpha}.
\end{equation}


Minimizing with respect to $C^*_{i\alpha}$ (the equations for
$C^*_{i\alpha}$ and $C_{i\alpha}$ can be written as two independent
equations) we obtain
\[
\frac{d}{dC^*_{i\alpha}}\left[ E[\Phi^{HF}] -
  \sum_{j}\epsilon_j\sum_{\alpha} C^*_{j\alpha}C_{j\alpha}\right]=0,
\]
which yields for every single-particle state $i$ and index $\alpha$
(recalling that the coefficients $C_{i\alpha}$ are matrix elements of
a unitary matrix, or orthogonal for a real symmetric matrix) the
following Hartree-Fock equations
\[
\sum_{\beta} C_{i\beta}\langle \alpha | h | \beta \rangle+
\sum_{j\le F}\sum_{\beta\gamma\delta}
C^*_{j\beta}C_{j\delta}C_{i\gamma}\langle
\alpha\beta|\hat{v}|\gamma\delta\rangle=\epsilon_i^{HF}C_{i\alpha}.
\]


We can rewrite this equation as (changing dummy variables)
\[
\sum_{\beta} \left\{\langle \alpha | h | \beta \rangle+
\sum_{j\le F}\sum_{\gamma\delta} C^*_{j\gamma}C_{j\delta}\langle
\alpha\gamma|\hat{v}|\beta\delta\rangle\right\}C_{i\beta}=\epsilon_i^{HF}C_{i\alpha}.
\]
Note that the sums over greek indices run over the number of basis set
functions (in principle an infinite number).

Defining
\[
h_{\alpha\beta}^{HF}=\langle \alpha | h | \beta \rangle+
\sum_{j\le F}\sum_{\gamma\delta} C^*_{j\gamma}C_{j\delta}\langle
\alpha\gamma|\hat{v}|\beta\delta\rangle,
\]
we can rewrite the new equations as
\begin{equation}
\sum_{\gamma}h_{\alpha\beta}^{HF}C_{i\beta}=\epsilon_i^{HF}C_{i\alpha}. \label{eq:newhf}
\end{equation}
The latter is nothing but a standard eigenvalue problem.  Our
Hartree-Fock matrix is thus
\[
\hat{h}_{\alpha\beta}^{HF}=\langle \alpha | \hat{h}_0 | \beta \rangle+
\sum_{j\le F}\sum_{\gamma\delta} C^*_{j\gamma}C_{j\delta}\langle
\alpha\gamma|\hat{v}|\beta\delta\rangle.
\]
The Hartree-Fock equations are solved in an iterative way starting
with a guess for the coefficients $C_{j\gamma}=\delta_{j,\gamma}$ and
solving the equations by diagonalization till the new single-particle
energies $\epsilon_i^{\mathrm{HF}}$ do not change anymore by a
prefixed quantity.

Normally we assume that the single-particle basis $|\beta\rangle$
forms an eigenbasis for the operator $\hat{h}_0$, meaning that the
Hartree-Fock matrix becomes
\[
\hat{h}_{\alpha\beta}^{HF}=\epsilon_{\alpha}\delta_{\alpha,\beta}+
\sum_{j\le F}\sum_{\gamma\delta} C^*_{j\gamma}C_{j\delta}\langle
\alpha\gamma|\hat{v}|\beta\delta\rangle.
\]

\subsection{Hartree-Fock algorithm with simple Python code}

The equations are often rewritten in terms of a so-called density matrix,
which is defined as 
\begin{equation}
\rho_{\gamma\delta}=\sum_{i\le F}\langle\gamma|i\rangle\langle i|\delta\rangle = \sum_{i=1}^{N}C_{i\gamma}C^*_{i\delta}.
\end{equation}
It means that we can rewrite the Hartree-Fock Hamiltonian as
\[
\hat{h}_{\alpha\beta}^{HF}=\epsilon_{\alpha}\delta_{\alpha,\beta}+
\sum_{\gamma\delta} \rho_{\gamma\delta}\langle \alpha\gamma|V|\beta\delta\rangle.
\]
It is convenient to use the density matrix since we can precalculate in every iteration the product of the eigenvector components $C$. 

The Hartree-Fock equations are, in their simplest form, solved in an
iterative way, starting with a guess for the coefficients
$C_{i\alpha}$. We label the coefficients as $C_{i\alpha}^{(n)}$, where
the superscript $n$ stands for iteration $n$.  To set up the algorithm
we can proceed as follows.

\begin{svgraybox}
\begin{enumerate}
\item We start with a guess
  $C_{i\alpha}^{(0)}=\delta_{i,\alpha}$. Alternatively, we could have
  used random starting values as long as the vectors are
  normalized. Another possibility is to give states below the Fermi
  level a larger weight. We construct then the density matrix and the 
Hartree-Fock Hamiltonian. 
\item The Hartree-Fock matrix simplifies then to
\[
\hat{h}_{\alpha\beta}^{HF}(0)=\epsilon_{\alpha}\delta_{\alpha,\beta}+
\sum_{\gamma\delta} \rho_{\gamma\delta}^{(0)}\langle \alpha\gamma|V|\beta\delta\rangle.
\]
Solving the Hartree-Fock eigenvalue problem yields then new eigenvectors $C_{i\alpha}^{(1)}$ and eigenvalues
$\epsilon_i^{\mathrm{HF}}(1)$. 
\item With the new eigenvectors we can set up a new Hartree-Fock potential 
\[
\sum_{\gamma\delta} \rho_{\gamma\delta}^{(1)}\langle \alpha\gamma|V|\beta\delta\rangle.
\]
The diagonalization with the new Hartree-Fock potential yields new eigenvectors and eigenvalues.
\item This process is continued till a user defined test is
  satisfied. As an example, we can require that
\[
\frac{\sum_{p} |\epsilon_i^{(n)}-\epsilon_i^{(n-1)}|}{m} \le \lambda,
\]
where $\lambda$ is a small number defined by the user ($\lambda \sim
10^{-8}$ or smaller) and $p$ runs over all calculated single-particle
energies and $m$ is the number of single-particle states.

\end{enumerate}
\end{svgraybox}
The following simple Python program implements the above algorithm using the density matrix formalism outlined above.
We have omitted the functions that set up the single-particle basis and the anti-symmetrized two-body interaction matrix elements.
These have to be provided, see \url{https://github.com/ManyBodyPhysics/LectureNotesPhysics/blob/master/doc/src/Chapter8-programs/python/hfnuclei.py}
for full code and matrix elements.
\begin{lstlisting}
# We skip here functions that set up the one- and two-body parts of the Hamiltonian 
# These functions need to be defined by the user. The two-body interaction below is
# calculated by calling the function TwoBodyInteraction(alpha,gamma,beta,delta)
# Similalry, the one-body part is computed by the function singleparticleH(alpha)
# We have omitted specific quantum number tests as well (isopsin conservation, 
# momentum conservation etc)
import numpy as np 
from decimal import Decimal

if __name__ == '__main__':
	
	""" Star HF-iterations, preparing variables and density matrix """

        """ Coefficients for setting up density matrix, assuming only one along the diagonals """
	C = np.eye(spOrbitals) # HF coefficients
        DensityMatrix = np.zeros([spOrbitals,spOrbitals])
        for gamma in range(spOrbitals):
            for delta in range(spOrbitals):
                sum = 0.0
                for i in range(Nparticles):
                    sum += C[gamma][i]*C[delta][i]
                DensityMatrix[gamma][delta] = Decimal(sum)
        maxHFiter = 100
        epsilon =  1.0e-5 
        difference = 1.0
	hf_count = 0
	oldenergies = np.zeros(spOrbitals)
	newenergies = np.zeros(spOrbitals)
	while hf_count < maxHFiter and difference > epsilon:
   	        HFmatrix = np.zeros([spOrbitals,spOrbitals])		
		for alpha in range(spOrbitals):
			for beta in range(spOrbitals):
                            """  Setting up the Fock matrix using the density matrix and antisymmetrized two-body interaction  """
     		            sumFockTerm = 0.0
                            for gamma in range(spOrbitals):
                                for delta in range(spOrbitals):
                                    sumFockTerm += DensityMatrix[gamma][delta]*
                                                   TwoBodyInteraction(alpha,gamma,beta,delta)
                            HFmatrix[alpha][beta] = Decimal(sumFockTerm)
                            """  Adding the one-body term """
                            if beta == alpha:   HFmatrix[alpha][alpha] += singleparticleH(alpha)
		spenergies, C = np.linalg.eigh(HFmatrix)
                """ Setting up new density matrix """
                DensityMatrix = np.zeros([spOrbitals,spOrbitals])
                for gamma in range(spOrbitals):
                    for delta in range(spOrbitals):
                        sum = 0.0
                        for i in range(Nparticles):
                            sum += C[gamma][i]*C[delta][i]
                        DensityMatrix[gamma][delta] = Decimal(sum)
		newenergies = spenergies
                """ Brute force computation of difference between previous and new sp HF energies """
                sum =0.0
                for i in range(spOrbitals):
                    sum += (abs(newenergies[i]-oldenergies[i]))/spOrbitals
                difference = sum
                oldenergies = newenergies
                print "Single-particle energies, ordering may have changed "
                for i in range(spOrbitals):
                    print('{0:4d}  {1:.4f}'.format(i, Decimal(oldenergies[i])))
		hf_count += 1
\end{lstlisting}





  We end this section by rewriting the ground state energy by adding
  and subtracting $\hat{u}^{HF}$
  \[
    E_0^{HF} =\langle \Phi_0 | \hat{H} | \Phi_0\rangle = \sum_{i\le
      F}^A \langle i | \hat{h}_0 +\hat{u}^{HF}| j\rangle+
    \frac{1}{2}\sum_{i\le F}^A\sum_{j \le F}^A\left[\langle ij
      |\hat{v}|ij \rangle-\langle
      ij|\hat{v}|ji\rangle\right]-\sum_{i\le F}^A \langle i
    |\hat{u}^{HF}| i\rangle,
  \]
  which results in
  \[
    E_0^{HF} = \sum_{i\le F}^A \varepsilon_i^{HF} +
    \frac{1}{2}\sum_{i\le F}^A\sum_{j \le F}^A\langle ij\vert\hat{v}\vert ij \rangle-\sum_{i\le F}^A \langle i\vert\hat{u}^{HF}\vert i\rangle.
  \]
  Our single-particle states $ijk\dots$ are now single-particle states
  obtained from the solution of the Hartree-Fock equations.



  Using our definition of the Hartree-Fock single-particle energies we
  obtain then the following expression for the total ground-state
  energy
  \[
    E_0^{HF} = \sum_{i\le F}^A \varepsilon_i - \frac{1}{2}\sum_{i\le
      F}^A\sum_{j \le F}^A\left[\langle ij |\hat{v}|ij \rangle-\langle
      ij|\hat{v}|ji\rangle\right].
  \]
  This equation demonstrates that the total energy is not given as the
  sum of the individual single-particle energies.

  \section{Full Configuration Interaction Theory}\label{sec:chap8fci}

  Full configuration theory (FCI), which represents a discretized
  variant of the continuous eigenvalue problem, allows for, in
  principle, an exact (to numerical precision) solution of Schr\"odinger's equation
  for many interacting fermions or bosons with a given basis set. This
  basis set defines an effective Hilbert space.  For fermionic
  problems, the standard approach is to define an upper limit for the
  set of singel-particle states. As an example, if we use the harmonic
  oscillator one-body Hamiltonian to generate an orthogonal
  single-particle basis, truncating the basis at some oscillator
  excitation energy provides thereby an upper limit.  Similarly,
  truncating the maximum values of $n_{x,y,z}$ for plane wave states
  with periodic boundary conditions, yields a similar upper limit.
  Table \ref{tab:table1} lists several possible truncations to the
  basis set in terms of the single-particle energies as functions of
  $n_{x,y,z}$.  This single-particle basis is then used to define all
  possible Slater determinants which can be constructed with a given
  number of fermions $A$.  The total number of Slater determinants
  determines thereafter the dimensionality of the Hamiltonian matrix
  and thereby an effective Hilbert space. 
  If we are able to set up the Hamiltonian matrix
  and solve the pertinent eigenvalue problem within this basis set,
  FCI provides numerically exact solutions to all states of interest
  for a given many-body problem. The dimensionality of the problem
  explodes however quickly. To see this it suffices to consider
  the total number of Slater determinants which can be built with say
  $N$ neutrons distributed among $n$ single-particle states. The total number is
  \[
  \left (\begin{array}{c} n \\ N\end{array} \right)
    =\frac{n!}{(n-N)!N!}.
  \]
  As an example, for a model space which comprises the first four
  major harmonic oscillator shells only, that is the $0s$, $0p$,
  $1s0d$ and $1p0f$ shells we have $40$ single particle states for
  neutrons and protons.  For the eight neutrons of oxygen-16 we would
  then have
  \[
  \left (\begin{array}{c} 40 \\ 8\end{array} \right)
    =\frac{40!}{(32)!8!}\sim 8\times 10^{7},
  \]
  possible Slater determinants. Multiplying this with the number of
  proton Slater determinants we end up with approximately $d\sim 10^{15}$ 
  possible Slater determinants and a Hamiltonian matrix of
  dimension $10^{15}\times 10^{15}$, an intractable problem if we wish to diagonalize the Hamiltonian matrix. The
  dimensionality can be reduced if we look at specific symmetries,
  however these symmetries will never reduce the problem to
  dimensionalities which can be handled by standard eigenvalue
  solvers. These are normally lumped into two main categories, direct
  solvers for matrices of dimensionalities which are smaller than
  $d\sim 10^5$, and iterative eigenvalue solvers (when only selected
  states are being sought after) for dimensionalities up to
  $10^{10}\times 10^{10}$.

  Due to its discreteness thus, the effective Hilbert space will
  always represent an approximation to the full continuous problem.
  However, with a given Hamiltonian matrix and effective Hilbert
  space, FCI provides us with true benchmarks that can convey
  important information on correlations beyond Hartree-Fock theory and
  various approximative many-body methods like many-body perturbation
  theory, coupled cluster theory, Green's function theory and the
  Similarity Renormalization Group approach. These methods are all
  discussed in this text.  Assuming that we can diagonalize the
  Hamiltonian matrix, and thereby obtain the exact solutions, this
  section serves the aim to link the exact solution obtained from FCI with various
  approximative methods, hoping thereby that eventual differences can
  shed light on which correlations  play a major role and should be
  included in the above approximative methods. The simple pairing
  model discussed in problem \ref{problem:pairingmodel} is an example
  of a system that allows us to compare exact solutions with
  those defined by many-body perturbation theory to a given order in
  the interaction, coupled cluster theory, Green's function theory and
  the Similarity Renormalization Group (SRG). Many-body perturbation
  theory and coupled cluster theory are discussed in this chapter,
  while various SRG approaches are discussed in Chapter 10. Green's
  function theory is discussed in Chapter 11.

  In order to familiarize the reader with these approximative
  many-body methods, we start with the general definition of the full
  configuration interaction problem.

  We have defined the ansatz for the ground state as
  \[
  |\Phi_0\rangle = \left(\prod_{i\le
    F}\hat{a}_{i}^{\dagger}\right)|0\rangle,
  \]
  where the variable  $i$ defines different single-particle states up to
  the Fermi level. We have assumed that we have $A$ nucleons and that the chosen single-particle basis are eigenstates of 
the one-body Hamiltonian $\hat{h}_0$ (defining thereby an orthogonal basis set).  
A given
  one-particle-one-hole ($1p1h$) state can be written as
  \[
  |\Phi_i^a\rangle = \hat{a}_{a}^{\dagger}\hat{a}_i|\Phi_0\rangle,
  \]
  while a $2p2h$ state can be written as
  \[
  |\Phi_{ij}^{ab}\rangle =
  \hat{a}_{a}^{\dagger}\hat{a}_{b}^{\dagger}\hat{a}_j\hat{a}_i|\Phi_0\rangle,
  \]
  and a general $ApAh$ state as
  \[
  |\Phi_{ijk\dots}^{abc\dots}\rangle =
  \hat{a}_{a}^{\dagger}\hat{a}_{b}^{\dagger}\hat{a}_{c}^{\dagger}\dots\hat{a}_k\hat{a}_j\hat{a}_i|\Phi_0\rangle.
  \]

  As before, we use letters $ijkl\dots$ for states below the Fermi level and
  $abcd\dots$ for states above the Fermi level. A general
  single-particle state is given by letters $pqrs\dots$.

  We can then expand our exact state function for the ground state as
  \[
  |\Psi_0\rangle=C_0|\Phi_0\rangle+\sum_{ai}C_i^a|\Phi_i^a\rangle+\sum_{abij}C_{ij}^{ab}|\Phi_{ij}^{ab}\rangle+\dots
  =(C_0+\hat{C})|\Phi_0\rangle,
  \]
  where we have introduced the so-called correlation operator
  \[
  \hat{C}=\sum_{ai}C_i^a\hat{a}_{a}^{\dagger}\hat{a}_i
  +\sum_{abij}C_{ij}^{ab}\hat{a}_{a}^{\dagger}\hat{a}_{b}^{\dagger}\hat{a}_j\hat{a}_i+\dots
  \]
  Since the normalization of $\Psi_0$ is at our disposal and since
  $C_0$ is by assumption not zero, we may arbitrarily set $C_0=1$ with
  corresponding proportional changes in all other coefficients. Using
  this so-called intermediate normalization we have
  \[
  \langle \Psi_0 | \Phi_0 \rangle = \langle \Phi_0 | \Phi_0 \rangle =
  1,
  \]
  resulting in
  \[
  |\Psi_0\rangle=(1+\hat{C})|\Phi_0\rangle.
  \]


  We rewrite
  \[
  |\Psi_0\rangle=C_0|\Phi_0\rangle+\sum_{ai}C_i^a|\Phi_i^a\rangle+\sum_{abij}C_{ij}^{ab}|\Phi_{ij}^{ab}\rangle+\dots,
  \]
  in a more compact form as
  \[
  |\Psi_0\rangle=\sum_{PH}C_H^P\Phi_H^P=\left(\sum_{PH}C_H^P\hat{A}_H^P\right)|\Phi_0\rangle,
  \]
  where $H$ stands for $0,1,\dots,n$ hole states and $P$ for
  $0,1,\dots,n$ particle states. The operator $\hat{A}_H^P$ represents
  a given set of particle-hole excitations. For a two-particle-to-hole
  excitation this operator is given by
  $\hat{A}_{2h}^{2p}=\hat{a}_{a}^{\dagger}\hat{a}_{b}^{\dagger}\hat{a}_j\hat{a}_i$.
  Our requirement of unit normalization gives
  \[
  \langle \Psi_0 | \Psi_0 \rangle = \sum_{PH}|C_H^P|^2= 1,
  \]
  and the energy can be written as
  \[
  E= \langle \Psi_0 | \hat{H} |\Psi_0 \rangle=
  \sum_{PP'HH'}C_H^{*P}\langle \Phi_H^P | \hat{H} |\Phi_{H'}^{P'}
  \rangle C_{H'}^{P'}.
  \]
  The last equation is normally solved by diagonalization, with the
  Hamiltonian matrix defined by the basis of all possible Slater
  determinants. A diagonalization is equivalent to finding the
  variational minimum of
  \[
   \langle \Psi_0 | \hat{H} |\Psi_0 \rangle-\lambda \langle \Psi_0
   |\Psi_0 \rangle,
  \]
  where $\lambda$ is a variational multiplier to be identified with
  the energy of the system.

  The minimization process results in
  \begin{align}
  0=&\delta\left[ \langle \Psi_0 | \hat{H} |\Psi_0 \rangle-\lambda
    \langle \Psi_0 |\Psi_0 \rangle\right]\\
  =& \sum_{P'H'}\left\{\delta[C_H^{*P}]\langle \Phi_H^P | \hat{H}
  |\Phi_{H'}^{P'} \rangle C_{H'}^{P'}+ C_H^{*P}\langle \Phi_H^P |
  \hat{H} |\Phi_{H'}^{P'} \rangle \delta[C_{H'}^{P'}]- \lambda(
  \delta[C_H^{*P}]C_{H'}^{P'}+C_H^{*P}\delta[C_{H'}^{P'}]\right\}.
  \end{align}
  Since the coefficients $\delta[C_H^{*P}]$ and $\delta[C_{H'}^{P'}]$
  are complex conjugates it is necessary and sufficient to require the
  quantities that multiply with $\delta[C_H^{*P}]$ to vanish.

  This leads to
  \[
  \sum_{P'H'}\langle \Phi_H^P | \hat{H} |\Phi_{H'}^{P'} \rangle
  C_{H'}^{P'}-\lambda C_H^{P}=0,
  \]
  for all sets of $P$ and $H$.

  If we then multiply by the corresponding $C_H^{*P}$ and sum over
  $PH$ we obtain
  \[ 
  \sum_{PP'HH'}C_H^{*P}\langle \Phi_H^P | \hat{H} |\Phi_{H'}^{P'}
  \rangle C_{H'}^{P'}-\lambda\sum_{PH}|C_H^P|^2=0,
  \]
  leading to the identification $\lambda = E$. This means that we have
  for all $PH$ sets
  \begin{equation}
  \sum_{P'H'}\langle \Phi_H^P | \hat{H} -E|\Phi_{H'}^{P'} \rangle =
  0. \label{eq:fullci}
  \end{equation}



  An alternative way to derive the last equation is to start from
  \[
  (\hat{H} -E)|\Psi_0\rangle = (\hat{H}
  -E)\sum_{P'H'}C_{H'}^{P'}|\Phi_{H'}^{P'} \rangle=0,
  \]
  and if this equation is successively projected against all
  $\Phi_H^P$ in the expansion of $\Psi$, we end up with
  Eq.~(\ref{eq:fullci}).

  If we are able to solve this equation by numerical diagonalization in
  a large Hilbert space (it will be truncated in terms of the number
  of single-particle states included in the definition of Slater
  determinants), it can then serve as a benchmark for other many-body
  methods which approximate the correlation operator $\hat{C}$.  Our
  pairing model discussed in problem \ref{problem:pairingmodel} is an
  example of a system which can be diagonalized exactly, providing
  thereby benchmarks for different approximative methods.


  To better understand the meaning of possible configurations and the
  derivation of a Hamiltonian matrix, we consider here a simple
  example of six fermions. We assume we can make an ansatz for the
  ground state with all six fermions below the Fermi level. We 
  label this state as a zero-particle-zero-hole state $0p-0h$. With
  six nucleons we can make at most $6p-6h$ excitations. If we have an
  infinity of single particle states above the Fermi level, we will
  obviously have an infinity of say $2p-2h$ excitations. Each specific way
  to distribute the particles represents a configuration. We will
  always have to truncate  the basis of single-particle states.
  This gives us a finite number of possible Slater determinants. Our
  Hamiltonian matrix would then look like (where each block which is
  marked with an $x$ can contain a large quantity of non-zero matrix
  elements) as shown here
  \begin{table}[h]
  \begin{center}
  \begin{tabular}{cccccccc}
  \hline \multicolumn{1}{c}{ } & \multicolumn{1}{c}{ $0p-0h$ } &
  \multicolumn{1}{c}{ $1p-1h$ } & \multicolumn{1}{c}{ $2p-2h$ } &
  \multicolumn{1}{c}{ $3p-3h$ } & \multicolumn{1}{c}{ $4p-4h$ } &
  \multicolumn{1}{c}{ $5p-5h$ } & \multicolumn{1}{c}{ $6p-6h$ }
  \\ \hline $0p-0h$ & x & x & x & 0 & 0 & 0 & 0 \\ $1p-1h$ & x & x & x
  & x & 0 & 0 & 0 \\ $2p-2h$ & x & x & x & x & x & 0 & 0 \\ $3p-3h$ &
  0 & x & x & x & x & x & 0 \\ $4p-4h$ & 0 & 0 & x & x & x & x & x
  \\ $5p-5h$ & 0 & 0 & 0 & x & x & x & x \\ $6p-6h$ & 0 & 0 & 0 & 0 &
  x & x & x \\ \hline
  \end{tabular}
  \end{center}
  \end{table}
  if the Hamiltonian contains at most a two-body interaction, as
  demonstrated in problem \ref{problem:hamiltoniansetup}.  If we use a
  so-called canonical Hartree-Fock basis \cite{shavittbartlett2009}, this corresponds to a particular unitary
  transformation where matrix elements of the type 
$\langle 0p-0h\vert \hat{H} \vert 1p-1h\rangle =\langle \Phi_0 |\hat{H}|\Phi_{i}^{a}\rangle=0$.
With a canonical Hartree-Fock basis our Hamiltonian matrix reads
  \begin{table}[h]
  \begin{center}
  \begin{tabular}{cccccccc}
  \hline \multicolumn{1}{c}{ } & \multicolumn{1}{c}{ $0p-0h$ } &
  \multicolumn{1}{c}{ $1p-1h$ } & \multicolumn{1}{c}{ $2p-2h$ } &
  \multicolumn{1}{c}{ $3p-3h$ } & \multicolumn{1}{c}{ $4p-4h$ } &
  \multicolumn{1}{c}{ $5p-5h$ } & \multicolumn{1}{c}{ $6p-6h$ }
  \\ \hline $0p-0h$ & $\tilde{x}$ & 0 & $\tilde{x}$ & 0 & 0 & 0 & 0
  \\ $1p-1h$ & 0 & $\tilde{x}$ & $\tilde{x}$ & $\tilde{x}$ & 0 & 0 & 0
  \\ $2p-2h$ & $\tilde{x}$ & $\tilde{x}$ & $\tilde{x}$ & $\tilde{x}$ &
  $\tilde{x}$ & 0 & 0 \\ $3p-3h$ & 0 & $\tilde{x}$ & $\tilde{x}$ &
  $\tilde{x}$ & $\tilde{x}$ & $\tilde{x}$ & 0 \\ $4p-4h$ & 0 & 0 &
  $\tilde{x}$ & $\tilde{x}$ & $\tilde{x}$ & $\tilde{x}$ & $\tilde{x}$
  \\ $5p-5h$ & 0 & 0 & 0 & $\tilde{x}$ & $\tilde{x}$ & $\tilde{x}$ &
  $\tilde{x}$ \\ $6p-6h$ & 0 & 0 & 0 & 0 & $\tilde{x}$ & $\tilde{x}$ &
  $\tilde{x}$ \\ \hline
  \end{tabular}
  \end{center}
  \end{table}
  If we do not make any truncations in the possible sets of Slater
  determinants (many-body states) we can make by distributing $A$
  nucleons among $n$ single-particle states, we call such a
  calculation for a full configuration interaction (FCI) approach.  If
  we make truncations, we have several different possibilities to
  reduce the dimensionality of the problem.  A well-known example is
  the standard nuclear shell-model. For the shell model, we define an
  effective Hilbert space with respect to a given core. The
  calculations are normally then performed for all many-body states
  that can be constructed from the effective Hilbert spaces. This
  approach requires a properly defined effective Hamiltonian.  Another
  possibility to constrain the dimensionality of the problem is to
  truncate in the number of excitations. As an example, we can limit
  the possible Slater determinants to only $1p-1h$ and $2p-2h$
  excitations. This is called a configuration interaction calculation
  at the level of singles and doubles excitations. If we truncate at
  the level of three-particle-three-hole excitations we end up with
  singles, doubles and triples excitations.  Such truncations reduce
  considerably the size of the Hamiltonian matrices to be
  diagonalized, but can lead to so-called unlinked contributions, and
  thereby wrong results, for a given expectation value
  \cite{barrettmusial2007}.  A third possibility is to constrain the
  number of excitations by an energy cutoff. This cutoff defines a
  maximum excitation energy. The maximum excitation energy is normally given by the 
sum of single-particle energies defined by the unperturbed one-body part of the Hamiltonian.
A commonly used basis in nuclear physics is the harmonic oscillator. The 
cutoff in energy is then defined by the maximum number of harmonic oscillator excitations.
If we do not define a core, this defines normally what is
  called the no-core shell-model approach \cite{navratil2009}.


  \subsection{A non-practical way of solving the eigenvalue problem}

  For reasons to come (links with coupled cluster theory and many-body
  perturbation theory), we will rewrite Eq.~(\ref{eq:fullci}) as a set
  of coupled non-linear equations in terms of the unknown coefficients
  $C_H^P$.  To obtain the eigenstates and eigenvalues in terms of
  non-linear equations is, from a computational perspective as 
  inefficient as finding the roots (and thereby eigenvalues) of the
  characteristic polynomial. However, this digression serves the scope
  of linking full configuration interaction theory with approximative
  solutions to the many-body problem.

  To see this, we look at the contributions arising from
  \[
  \langle \Phi_H^P | = \langle \Phi_0|
  \]
  in Eq.~(\ref{eq:fullci}), that is we multiply with $\langle \Phi_0|$ from the left in
  \[
  (\hat{H} -E)\sum_{P'H'}C_{H'}^{P'}|\Phi_{H'}^{P'} \rangle=0.
  \]
  If we assume that we have a two-body operator at most, the
  Slater-Condon rule for a two-body interaction, see problem
  \ref{problem:hamiltoniansetup}, results in an expression for the
  correlation energy in terms of $C_i^a$ and $C_{ij}^{ab}$ only, namely
  \[
  \langle \Phi_0 | \hat{H} -E| \Phi_0\rangle + \sum_{ai}\langle \Phi_0
  | \hat{H} -E|\Phi_{i}^{a} \rangle C_{i}^{a}+ \sum_{abij}\langle
  \Phi_0 | \hat{H} -E|\Phi_{ij}^{ab} \rangle C_{ij}^{ab}=0,
  \]
  or
  \[
  E-E_{\mathrm{Ref}} =\Delta E=\sum_{ai}\langle \Phi_0 |
  \hat{H}|\Phi_{i}^{a} \rangle C_{i}^{a}+ \sum_{abij}\langle \Phi_0 |
  \hat{H}|\Phi_{ij}^{ab} \rangle C_{ij}^{ab},
  \]
  where the energy $E_{\mathrm{Ref}}$ is the reference energy and
  $\Delta E$ defines the so-called correlation energy.  The
  single-particle basis functions could  result from  a
  Hartree-Fock calculation or they could be the eigenstates of the one-body operator that defined the
  non-interacting part of the Hamiltonian.

  In our Hartree-Fock discussions, we have already computed
  the matrix $\langle \Phi_0 | \hat{H}|\Phi_{i}^{a}\rangle $ and
  $\langle \Phi_0 | \hat{H}|\Phi_{ij}^{ab}\rangle$.  If we are using a
  Hartree-Fock basis we have $\langle \Phi_0 | \hat{H}|\Phi_{i}^{a}\rangle=0$
  and we are left with a \emph{correlation energy} given by
  \[
  E-E_{\mathrm{Ref}} =\Delta E^{HF}=\sum_{abij}\langle \Phi_0 |
  \hat{H}|\Phi_{ij}^{ab} \rangle C_{ij}^{ab}.
  \]


  Inserting the various matrix elements we can rewrite the previous
  equation as
  \begin{equation}\label{eq:correlationenergy}
  \Delta E=\sum_{ai}\langle i| \hat{f}|a \rangle C_{i}^{a}+
  \sum_{abij}\langle ij | \hat{v}| ab \rangle C_{ij}^{ab}.
  \end{equation}
  This equation determines the correlation energy but not the
  coefficients $C$.  We need more equations. Our next step is to set
  up
  \[ 
  \langle \Phi_i^a | \hat{H} -E| \Phi_0\rangle + \sum_{bj}\langle
  \Phi_i^a | \hat{H} -E|\Phi_{j}^{b} \rangle C_{j}^{b}+
  \sum_{bcjk}\langle \Phi_i^a | \hat{H} -E|\Phi_{jk}^{bc} \rangle
  C_{jk}^{bc}+ \sum_{bcdjkl}\langle \Phi_i^a | \hat{H}
  -E|\Phi_{jkl}^{bcd} \rangle C_{jkl}^{bcd}=0,
  \]
  as this equation will allow us to find an expression for the
  coefficents $C_i^a$  through 
  \begin{equation}\label{eq:c1p1h}
  \langle i | \hat{f}| a\rangle +\langle \Phi_i^a |
  \hat{H}|\Phi_{i}^{a} \rangle C_{i}^{a}+ \sum_{bj\ne ai}\langle
  \Phi_i^a | \hat{H}|\Phi_{j}^{b} \rangle C_{j}^{b}+
  \sum_{bcjk}\langle \Phi_i^a | \hat{H}|\Phi_{jk}^{bc} \rangle
  C_{jk}^{bc}+ \sum_{bcdjkl}\langle \Phi_i^a |
  \hat{H}|\Phi_{jkl}^{bcd} \rangle C_{jkl}^{bcd}=EC_i^a.
  \end{equation}

  We see that on the right-hand side we have the energy $E$. This
  leads to a non-linear equation in the unknown coefficients since the coefficients appear also in the definition of the correlation
energy of Eq.~(\ref{eq:correlationenergy}).  These
  equations are normally solved iteratively, that is we  start
  with a guess for the coefficients $C_i^a$. A common choice is to
  use perturbation theory as a starting point for the unknown coefficients. For the one-particle-one-hole coefficients, the wave operator
(see section \ref{sec:chap8mbpt}) to first order in the interaction is given by
  \[
   C_{i}^{a}=\frac{\langle i | \hat{f}|
     a\rangle}{\epsilon_i-\epsilon_a}.
  \]

  The observant reader will however see that we need an equation for
  $C_{jk}^{bc}$ and $C_{jkl}^{bcd}$ and more complicated particle-hole excitations as well.  To find the equations for
  these coefficients we need then to continue our multiplications from
  the left with the various $\Phi_{H}^P$ terms.


  For $C_{jk}^{bc}$ we have
  \begin{align}\label{eq:c2p2h}
  0=&\langle \Phi_{ij}^{ab} | \hat{H} -E| \Phi_0\rangle +
  \sum_{kc}\langle \Phi_{ij}^{ab} | \hat{H} -E|\Phi_{k}^{c} \rangle
  C_{k}^{c}+ \\
  &\sum_{cdkl}\langle \Phi_{ij}^{ab} | \hat{H} -E|\Phi_{kl}^{cd}
  \rangle C_{kl}^{cd}+\sum_{cdeklm}\langle \Phi_{ij}^{ab} | \hat{H}
  -E|\Phi_{klm}^{cde} \rangle C_{klm}^{cde}+\sum_{cdefklmn}\langle
  \Phi_{ij}^{ab} | \hat{H} -E|\Phi_{klmn}^{cdef} \rangle
  C_{klmn}^{cdef}.
  \end{align}
  We can isolate the coefficients $C_{kl}^{cd}$ in a similar way
  as we did for the coefficients $C_{i}^{a}$.  A standard choice for
  the first iteration is to use again perturbation theory to first order in the interaction and set
  \[
  C_{ij}^{ab} =\frac{\langle ij \vert \hat{v} \vert ab
    \rangle}{\epsilon_i+\epsilon_j-\epsilon_a-\epsilon_b}.
  \]
  At the end we can rewrite our solution of the Schr\"odinger equation
  in terms of a series coupled equations for the coefficients $C_H^P$.
  This is a very cumbersome way of solving a many-body
  problem. However, by using this iterative scheme we can illustrate
  how we can compute the various terms in the wave operator or
  correlation operator $\hat{C}$. We will later identify the
  calculation of the various terms $C_H^P$ as parts of different
  many-body approximations to full configuration interaction theory.

  \subsection{Short summary}


  If we can directly diagonalize large matrices, full configuration interaction
  theory is the method of choice since  we obtain all  eigenvectors and eigenvalues. 
  The eigenvectors are obtained directly from the coefficients
    $C_H^P$ which result from the diagonalization.  We can then
compute expectation values of other operators,
    as well as transition probabilities. Moreover, correlations are easy to understand in terms of contributions
    to a given operator beyond the Hartree-Fock contribution. 
For larger dimensionalities $d$, with $d > 10^5$, iterative Krylov methods \cite{krylov} like Lanczos' \cite{lanczos} or Davidson's \cite{davidson} 
algorithms are frequently used. These methods yield, with a finite number of iteration, only a subset of all eigenvalues of interest. Lanczos' algorithm converges to the extreme values, yielding the lowest-lying and highest-lying eigenstates, see for example Ref.~\cite{golubvanloan} for a proof. 

With the eigenvectors we can compute
  the correlation energy, which is defined as (with a two-body Hamiltonian)
  \[
  \Delta E=\sum_{ai}\langle i| \hat{f}|a \rangle C_{i}^{a}+
  \sum_{abij}\langle ij | \hat{v}| ab \rangle C_{ij}^{ab}.
  \]
The energy of  the ground state is then
  \[
  E=E_{\mathrm{Ref}}+\Delta E,
  \]
where $E_{\mathrm{Ref}}$ is the reference energy.
  However, as we have seen, even for a
  small case like the four first major shells and 
  oxygen-16 with 16 active nucleons, the dimensionality becomes quickly intractable. If we
  wish to include single-particle states that reflect weakly bound
  systems, we need a much larger single-particle basis. We need thus
  approximative methods that sum specific correlations to infinite
  order.  All these methods start normally with a Hartree-Fock basis
  as the calculational basis. In the next section we discuss one of
  these possible approximative methods, namely many-body perturbation
  theory.

  \section{Many-body perturbation theory}\label{sec:chap8mbpt}

  We assume here that we are only interested in the non-degenerate
  ground state of a given system and expand the exact wave function in
  terms of a series of Slater determinants
  \[
  \vert \Psi_0\rangle = \vert \Phi_0\rangle +
  \sum_{m=1}^{\infty}C_m\vert \Phi_m\rangle,
  \]
  where we have assumed that the true ground state is dominated by the
  solution of the unperturbed problem, that is
  \[
  \hat{H}_0\vert \Phi_0\rangle= W_0\vert \Phi_0\rangle.
  \]
  The state $\vert \Psi_0\rangle$ is not normalized and we employ again
  intermediate normalization via $\langle \Phi_0 \vert
  \Psi_0\rangle=1$.

  The Schr\"odinger equation is given by
  \[
  \hat{H}\vert \Psi_0\rangle = E\vert \Psi_0\rangle,
  \]
  and multiplying the latter from the left with $\langle \Phi_0\vert $
  gives
  \[
  \langle \Phi_0\vert \hat{H}\vert \Psi_0\rangle = E\langle
  \Phi_0\vert \Psi_0\rangle=E,
  \]
  and subtracting from this equation
  \[
  \langle \Psi_0\vert \hat{H}_0\vert \Phi_0\rangle= W_0\langle
  \Psi_0\vert \Phi_0\rangle=W_0,
  \]
  and using the fact that the  operators $\hat{H}$ and $\hat{H}_0$
  are hermitian results in
  \begin{equation}\label{eq:mbptcorrel}
  \Delta E=E-W_0=\langle \Phi_0\vert \hat{H}_I\vert \Psi_0\rangle,
  \end{equation}
  which is an exact result. This resembles our previous definition of the correlation energy except that the reference energy is now defined
by the unperturbed energy $W_0$. The reader should contrast this equation to our previous definition of the correlation energy
  \[
  \Delta E=\sum_{ai}\langle i| \hat{f}|a \rangle C_{i}^{a}+
  \sum_{abij}\langle ij | \hat{v}| ab \rangle C_{ij}^{ab},
  \]
and the total energy
  \[
  E=E_{\mathrm{Ref}}+\Delta E,
  \]
where the reference energy is given by
\[   
   E_{\mathrm{Ref}}= \langle \Phi_0 \vert \hat{H} \vert \Phi_0\rangle.
\]

  Equation (\ref{eq:mbptcorrel}) forms the starting point for all perturbative
  derivations. However, as it stands it represents nothing but a mere
  formal rewriting of Schr\"odinger's equation and is not of much
  practical use. The exact wave function $\vert \Psi_0\rangle$ is
  unknown. In order to obtain a perturbative expansion, we need to
  expand the exact wave function in terms of the interaction
  $\hat{H}_I$.

  Here we have assumed that our model space defined by the operator
  $\hat{P}$ is one-dimensional, meaning that
  \[
  \hat{P}= \vert \Phi_0\rangle \langle \Phi_0\vert ,
  \]
  and
  \[
  \hat{Q}=\sum_{m=1}^{\infty}\vert \Phi_m\rangle \langle \Phi_m\vert .
  \]


  We can thus rewrite the exact wave function as
  \[
  \vert \Psi_0\rangle= (\hat{P}+\hat{Q})\vert \Psi_0\rangle=\vert
  \Phi_0\rangle+\hat{Q}\vert \Psi_0\rangle.
  \]
  Going back to the Schr\"odinger equation, we can rewrite it as,
  adding and a subtracting a term $\omega \vert \Psi_0\rangle$ as
  \[
  \left(\omega-\hat{H}_0\right)\vert
  \Psi_0\rangle=\left(\omega-E+\hat{H}_I\right)\vert \Psi_0\rangle,
  \]
  where $\omega$ is an energy variable to be specified later.


  We assume also that the resolvent of $\left(\omega-\hat{H}_0\right)$
  exits, that is it has an inverse which defines the unperturbed
  Green's function as
  \[
  \left(\omega-\hat{H}_0\right)^{-1}=\frac{1}{\left(\omega-\hat{H}_0\right)}.
  \]

  We can rewrite Schr\"odinger's equation as
  \[
  \vert
  \Psi_0\rangle=\frac{1}{\omega-\hat{H}_0}\left(\omega-E+\hat{H}_I\right)\vert
  \Psi_0\rangle,
  \]
  and multiplying from the left with $\hat{Q}$ results in
  \[
  \hat{Q}\vert
  \Psi_0\rangle=\frac{\hat{Q}}{\omega-\hat{H}_0}\left(\omega-E+\hat{H}_I\right)\vert
  \Psi_0\rangle,
  \]
  which is possible since we have defined the operator $\hat{Q}$ in
  terms of the eigenfunctions of $\hat{H}_0$.

 Since these operators commute we have
  \[
  \hat{Q}\frac{1}{\left(\omega-\hat{H}_0\right)}\hat{Q}=\hat{Q}\frac{1}{\left(\omega-\hat{H}_0\right)}=\frac{\hat{Q}}{\left(\omega-\hat{H}_0\right)}.
  \]
  With these definitions we can in turn define the wave function as
  \[
  \vert \Psi_0\rangle=\vert
  \Phi_0\rangle+\frac{\hat{Q}}{\omega-\hat{H}_0}\left(\omega-E+\hat{H}_I\right)\vert
  \Psi_0\rangle.
  \]
  This equation is again nothing but a formal rewrite of
  Schr\"odinger's equation and does not represent a practical
  calculational scheme.  It is a non-linear equation in two unknown
  quantities, the energy $E$ and the exact wave function $\vert
  \Psi_0\rangle$. We can however start with a guess for $\vert
  \Psi_0\rangle$ on the right hand side of the last equation.



   The most common choice is to start with the function which is
   expected to exhibit the largest overlap with the wave function we
   are searching after, namely $\vert \Phi_0\rangle$. This can again
   be inserted in the solution for $\vert \Psi_0\rangle$ in an
   iterative fashion and if we continue along these lines we end up
   with
  \[
  \vert
  \Psi_0\rangle=\sum_{i=0}^{\infty}\left\{\frac{\hat{Q}}{\omega-\hat{H}_0}\left(\omega-E+\hat{H}_I\right)\right\}^i\vert
  \Phi_0\rangle,
  \]
  for the wave function and
  \[
  \Delta E=\sum_{i=0}^{\infty}\langle \Phi_0\vert
  \hat{H}_I\left\{\frac{\hat{Q}}{\omega-\hat{H}_0}\left(\omega-E+\hat{H}_I\right)\right\}^i\vert
  \Phi_0\rangle,
  \]
  which is now a perturbative expansion of the exact energy in terms
  of the interaction $\hat{H}_I$ and the unperturbed wave function
  $\vert \Psi_0\rangle$.



  In our equations for $\vert \Psi_0\rangle$ and $\Delta E$ in terms
  of the unperturbed solutions $\vert \Phi_i\rangle$ we have still an
  undetermined parameter $\omega$ and a dependecy on the exact energy
  $E$. Not much has been gained thus from a practical computational
  point of view.

  In Brilluoin-Wigner perturbation theory \cite{haxton,shavittbartlett2009} it is customary to set
  $\omega=E$. This results in the following perturbative expansion for
  the energy $\Delta E$
  \begin{align}
  \Delta E=&\sum_{i=0}^{\infty}\langle \Phi_0\vert
  \hat{H}_I\left\{\frac{\hat{Q}}{\omega-\hat{H}_0}\left(\omega-E+\hat{H}_I\right)\right\}^i\vert
  \Phi_0\rangle=\\ &\langle \Phi_0\vert
  \left(\hat{H}_I+\hat{H}_I\frac{\hat{Q}}{E-\hat{H}_0}\hat{H}_I+
  \hat{H}_I\frac{\hat{Q}}{E-\hat{H}_0}\hat{H}_I\frac{\hat{Q}}{E-\hat{H}_0}\hat{H}_I+\dots\right)\vert
  \Phi_0\rangle.
  \end{align}
  This expression depends however on the exact energy $E$ and is again
  not very convenient from a practical point of view. It can obviously
  be solved iteratively, by starting with a guess for $E$ and then
  solve till some kind of self-consistency criterion has been reached.

  Defining $e=E-\hat{H}_0$ and recalling that $\hat{H}_0$ commutes
  with $\hat{Q}$ by construction and that $\hat{Q}$ is an idempotent
  operator $\hat{Q}^2=\hat{Q}$, we can rewrite the denominator in the above
  expansion for $\Delta E$ as
  \[
  \hat{Q}\frac{1}{\hat{e}-\hat{Q}\hat{H}_I\hat{Q}}=\hat{Q}\left[\frac{1}{\hat{e}}+\frac{1}{\hat{e}}\hat{Q}\hat{H}_I\hat{Q}
    \frac{1}{\hat{e}}+\frac{1}{\hat{e}}\hat{Q}\hat{H}_I\hat{Q}
    \frac{1}{\hat{e}}\hat{Q}\hat{H}_I\hat{Q}\frac{1}{\hat{e}}+\dots\right]\hat{Q}.
  \]

  Inserted in the expression for $\Delta E$ we obtain
  \[
  \Delta E= \langle \Phi_0\vert
  \hat{H}_I+\hat{H}_I\hat{Q}\frac{1}{E-\hat{H}_0-\hat{Q}\hat{H}_I\hat{Q}}\hat{Q}\hat{H}_I\vert
  \Phi_0\rangle.
  \]
  In Rayleigh-Schr\"odinger (RS) perturbation theory \cite{shavittbartlett2009} we set $\omega = W_0$ and obtain the
  following expression for the energy difference
  \begin{align}
  \Delta E =& \sum_{i=0}^{\infty}\langle \Phi_0\vert
  \hat{H}_I\left\{\frac{\hat{Q}}{W_0-\hat{H}_0}\left(\hat{H}_I-\Delta
  E\right)\right\}^i\vert \Phi_0\rangle\\ & \langle \Phi_0\vert
  \left(\hat{H}_I+\hat{H}_I\frac{\hat{Q}}{W_0-\hat{H}_0}(\hat{H}_I-\Delta
  E)+ \hat{H}_I\frac{\hat{Q}}{W_0-\hat{H}_0}(\hat{H}_I-\Delta
  E)\frac{\hat{Q}}{W_0-\hat{H}_0}(\hat{H}_I-\Delta
  E)+\dots\right)\vert \Phi_0\rangle.
  \end{align}



  Recalling that $\hat{Q}$ commutes with $\hat{H_0}$ and since $\Delta
  E$ is a constant we obtain that
  \[
  \hat{Q}\Delta E\vert \Phi_0\rangle = \hat{Q}\Delta E\vert
  \hat{Q}\Phi_0\rangle = 0.
  \]
  Inserting this results in the expression for the energy results in
  \[
  \Delta E=\langle \Phi_0\vert
  \left(\hat{H}_I+\hat{H}_I\frac{\hat{Q}}{W_0-\hat{H}_0}\hat{H}_I+
  \hat{H}_I\frac{\hat{Q}}{W_0-\hat{H}_0}(\hat{H}_I-\Delta
  E)\frac{\hat{Q}}{W_0-\hat{H}_0}\hat{H}_I+\dots\right)\vert
  \Phi_0\rangle.
  \]



  We can now expand this expression in terms of a perturbative expression in
  terms of $\hat{H}_I$ where we iterate the last expression in terms
  of $\Delta E$, that is 
  \[
  \Delta E=\sum_{i=1}^{\infty}\Delta E^{(i)}.
  \]
  We get the following expression for $\Delta E^{(i)}$
  \[
  \Delta E^{(1)}=\langle \Phi_0\vert \hat{H}_I\vert \Phi_0\rangle,
  \] 
  which is just the contribution to first order in perturbation
  theory,
  \[
  \Delta E^{(2)}=\langle\Phi_0\vert
  \hat{H}_I\frac{\hat{Q}}{W_0-\hat{H}_0}\hat{H}_I\vert \Phi_0\rangle,
  \]
  which is the contribution to second order and
  \[
  \Delta E^{(3)}=\langle \Phi_0\vert
  \hat{H}_I\frac{\hat{Q}}{W_0-\hat{H}_0}\hat{H}_I\frac{\hat{Q}}{W_0-\hat{H}_0}\hat{H}_I\Phi_0\rangle-
  \langle\Phi_0\vert \hat{H}_I\frac{\hat{Q}}{W_0-\hat{H}_0}\langle
  \Phi_0\vert \hat{H}_I\vert
  \Phi_0\rangle\frac{\hat{Q}}{W_0-\hat{H}_0}\hat{H}_I\vert
  \Phi_0\rangle,
  \]
  being the third-order contribution.
  There exists a formal theory for the calculation
  of $\Delta E_0$, see for example Ref.~\cite{shavittbartlett2009}.  According to the well-known Goldstone
  linked-diagram theory, the energy shift $\Delta E_0$ is given
  exactly by the diagrammatic expansion shown in
  Fig.~\ref{fig:goldstone}, where ground state diagrams to third order are listed. This theory is a linked-cluster
  perturbation expansion for the ground state energy of a many-body
  system, and applies equally well to both nuclear matter and
  closed-shell nuclei such as the doubly magic nucleus $^{40}$Ca.  
We assume the reader is familiar 
with the standard rules for deriving and setting up the analytical expressions for various Feymann-Goldstone diagrams \cite{svavittbartlett2009}.
\begin{figure}[hbtp]
    \includegraphics[width=\linewidth]{Chapter8-figures/mbpt.pdf}
      \caption{Diagrams which enter the definition of the ground-state
      correlation energy $\Delta E_0$ to third order in the interaction. We have not included the first-order contribution.}
      \label{fig:goldstone}
\end{figure}
In an infinite system like nuclear matter or the homogenous electron gas, all diagrams with so-called Hartree-Fock insertions like diagrams (2), (6), (7), (10-16) are zero 
due to lack of momentum conservation. They would also be zero in case a canonical \cite{shavittbartlett2009} Hartree-Fock basis is employed. 

  Using the above standard diagram rules, the various
  diagrams contained in Fig.~\ref{fig:goldstone} can be readily calculated (in
  an uncoupled scheme). Diagram  (1) results in
  \begin{equation}
     (1)=\frac{1}{2^2}\sum_{ij\leq F}\sum_{ab>F}
    \frac{\langle ij\vert\hat{v}\vert ab\rangle \langle
      ab\vert\hat{v}\vert ij\rangle}
         {\varepsilon_i+\varepsilon_j-\varepsilon_a-\varepsilon_b},
  \end{equation}
 while diagram (2) is zero due to lack of momentum conservation. We have two factors of $1/2$ since there are two equivalent pairs of fermions (two  particle states and two hole states) starting at the same vertex and ending at the same vertex. The expression for diagram (3)  is 
  \begin{equation}\label{eq:diag3}
     (3)=\sum_{ijk\leq k_F}\sum_{abc > F}
    \frac{\langle ij\vert\hat{v}\vert ab\rangle \langle
      bk\vert\hat{v}\vert ic\rangle \langle ac\vert\hat{v}\vert
      ik\rangle}
         {(\varepsilon_i+\varepsilon_j-\varepsilon_a-\varepsilon_b)
           (\varepsilon_i+\varepsilon_k-\varepsilon_a-\varepsilon_c)}.
  \end{equation}
  Diagrams (4) and (5) read
  \begin{equation}\label{eq:diag4}
     (4)=\frac{1}{2^3}\sum_{ij\le F}\sum_{abcd > F}
    \frac{\langle ij\vert\hat{v}\vert cd\rangle \langle
      cd\vert\hat{v}\vert ab\rangle \langle ab\vert\hat{v}\vert
      ij\rangle}
         {(\varepsilon_i+\varepsilon_j-\varepsilon_c-\varepsilon_d)
           (\varepsilon_i+\varepsilon_j-\varepsilon_a-\varepsilon_b)},
  \end{equation}
  \begin{equation}\label{eq:diag5}
     (5)=\frac{1}{2^3}\sum_{ijkl\le F}\sum_{ab > F}
    \frac{\langle ab\vert\hat{v}\vert kl\rangle \langle
      kl\vert\hat{v}\vert ij\rangle \langle ij\vert\hat{v}\vert
      ab\rangle}
         {(\varepsilon_i+\varepsilon_j-\varepsilon_a-\varepsilon_b)
           (\varepsilon_k+\varepsilon_l-\varepsilon_a-\varepsilon_b)},
  \end{equation}
where the factor $(1/2)^3$ arises due to three equivalent pairs of lines starting and ending at the same vertex. The last two contributions 
have an even number of hole lines and closed loops, resulting thus in a positive sign. In problem \ref{problem:diagrams}, you are asked to calculate the expressions for diagrams like (8) and (9) in the above figure. 

  In the expressions for the various diagrams the quantity $\varepsilon$ denotes the single-particle energies
  defined by $H_0$.  The steps leading to the above expressions for
  the various diagrams are rather straightforward. Though, if we wish
  to compute the matrix elements for the interaction $\hat{v}$, a serious
  problem arises. Typically, the matrix elements will contain a term
  $V(|{\mathbf r}|)$
  which represents the interaction potential $V$ between two nucleons,
  where ${\mathbf r}$ is the internucleon distance.  All modern models
  for $V$ have a strong short-range repulsive core. Hence, matrix
  elements involving $V(|{\mathbf r}|)$, will result in large (or
  infinitely large for a potential with a hard core) and repulsive
  contributions to the ground-state energy. Thus, the diagrammatic
  expansion for the ground-state energy in terms of the potential
  $V(|{\mathbf r}|)$ becomes meaningless. A perturbative expansion in terms of
such interaction matrix elements may thus lead to a slowly converging expansion.
A standard recipe to circumvent such problems has been to sum up 
a selected class of correlations. We discuss such possibilities in section \ref{sec:cc}.  



  \subsection{Interpreting the correlation energy and the wave operator}

  In section \ref{sec:chap8fci} we showed that we could rewrite the exact state
  function for the ground state as a linear expansion in terms of all
  possible Slater determinants.  We expanded then (as an example) our
  exact state function for the ground state as
  \[
  |\Psi_0\rangle=C_0|\Phi_0\rangle+\sum_{ai}C_i^a|\Phi_i^a\rangle+\sum_{abij}C_{ij}^{ab}|\Phi_{ij}^{ab}\rangle+\dots
  =(C_0+\hat{C})|\Phi_0\rangle,
  \]
  where we introduced the so-called correlation operator
  \[
  \hat{C}=\sum_{ai}C_i^a\hat{a}_{a}^{\dagger}\hat{a}_i
  +\sum_{abij}C_{ij}^{ab}\hat{a}_{a}^{\dagger}\hat{a}_{b}^{\dagger}\hat{a}_j\hat{a}_i+\dots
  \]
  In a shell-model calculation, the unknown coefficients in $\hat{C}$
  are the eigenvectors that result from the diagonalization of the
  Hamiltonian matrix.

  How can we use perturbation theory to determine the same
  coefficients? Let us study the contributions to second order in the
  interaction, namely
  \[
  \Delta E^{(2)}=\langle\Phi_0\vert
  \hat{H}_I\frac{\hat{Q}}{W_0-\hat{H}_0}\hat{H}_I\vert \Phi_0\rangle.
  \]
  This contribution will also be discussed in connection with the
  development of a many-body program for nuclear matter, as well as
  the simple pairing model of problem \ref{problem:pairingmodel}.  The
  intermediate states given by $\hat{Q}$ can at most be of a $2p-2h$
  nature if we have a two-body Hamiltonian. This means that to second
  order in perturbation theory we can at most have $1p-1h$ and $2p-2h$
  excitations as intermediate states. When we diagonalize, these
  contributions are included to infinite order. This means that in
  order to include such correlations to higher order in the
  interaction, we need to go to higher-orders in perturbation theory.

  If we limit the attention to a Hartree-Fock basis, we have that
  $\langle\Phi_0\vert \hat{H}_I \vert 2p-2h\rangle$ is the only
  contribution since matrix elements involving $\langle\Phi_0\vert
  \hat{H}_I \vert 1p-1h\rangle$ are zero and the contribution to the
  energy from second order in Rayleigh-Schr\"odinger perturbation
  theory reduces to
  \[
  \Delta E^{(2)}=\frac{1}{4}\sum_{abij}\langle ij\vert \hat{v}\vert
  ab\rangle \frac{\langle ab\vert \hat{v}\vert
    ij\rangle}{\epsilon_i+\epsilon_j-\epsilon_a-\epsilon_b}.
  \]
Here we have used the results from problem \ref{problem:hamiltoniansetup}. 
  If we compare this to the correlation energy obtained from full
  configuration interaction theory with a Hartree-Fock basis, we found
  that
  \[
  E-E_{\mathrm{Ref}} =\Delta E=\sum_{abij}\langle ij | \hat{v}| ab
  \rangle C_{ij}^{ab},
  \]
  where the energy $E_{\mathrm{Ref}}$ is the reference energy and
  $\Delta E$ defines the so-called correlation energy.

  We see that if we set
  \[
  C_{ij}^{ab} =\frac{1}{4}\frac{\langle ab \vert \hat{v} \vert ij
    \rangle}{\epsilon_i+\epsilon_j-\epsilon_a-\epsilon_b},
  \]
  we have a perfect agreement between configuration interaction  theory  and many-body perturbation
  theory. However, configuration interaction  theory includes $2p-2h$ (and more complicated ones as
  well) correlations to infinite order. In order to make a meaningful
  comparison we would at least need to sum such correlations to
  infinite order in perturbation theory. The last equation serves
  however as a very useful comparison between configuration interaction  theory and many-body
  perturbation theory. Furthermore, for our nuclear matter studies,
  one-particle-one-hole intermediate excitations are zero due to the
  requirement of momentum conservation in infinite systems. These
  two-particle-two-hole correlations can also be summed to infinite
  order and a particular class of such excitations are given by
  two-particle excitations only. These represent in case of nuclear interactions, which
  are strongly repulsive at short interparticle distances, a
  physically intuitive way to understand the renomalization of nuclear
  forces. Such correlations are easily computed by simple matrix
  inversion techniques and have been widely employed in nuclear
  many-body theory.  Summing up two-particle excitations to infinite
  order leads to an effective two-body interaction which renomalizes
  the short-range part of the nuclear interactions. 

In summary, many-body perturbation theory introduces order-by-order
specific correlations and we can make comparisons with exact
calculations like those provided by configuration interaction theory.
The advantage of for example Rayleigh-Schr\"odinger perturbation
theory is that at every order in the interaction, we know how to
calculate all contributions since they can be either tabulated or
computed on the fly.  However, many-body perturbation theory suffers
from not being variational theory and there is no guarantee that
higher-order terms will improve the order-by-order convergence.  It is
also extremely tedious to compute terms beyond third order, in
particular if one is interested in effective valence space
interactions.  There are however classes of correlations which can be
summed up to infinite order in the interaction.  The hope is that such
correlations can mitigate specific convergence issues, although there
is no a priori guarantee thereof.  Examples are the so-called TDA and
RPA class of diagrams \cite{ripkablaizot}, as well as the resummation
of two-particle-two-hole correlations discussed in chapter 11. If we limit ourselves to the
resummation of two-particle correlations only, these lead us to the
so-called $G$-matrix resummation of diagrams, see for example Ref.~\cite{day1967}.
There are however computationally inexpensive methods which
sum larger classes of correlations to infinite order in the
interaction. This leads us to section \ref{sec:chap8cctheory} and the final
many-body method of this chapter, coupled cluster theory. 


\section{Coupled cluster theory}\label{sec:chap8cctheory}
  
Coester and Kummel developed the ideas that led to coupled cluster
theory in the late 1950s. The basic idea is that the correlated wave function
of a many-body system $\mid\Psi\rangle$
can be formulated as an exponential of correlation
operators $T$ acting on a reference state $\mid\Phi\rangle$.
\begin{equation}
\mid\Psi\rangle = \exp\left(-\hat{T}\right)\mid\Phi\rangle,
\end{equation}
We will discuss how to define the operators later in this work. This simple
ansatz carries enormous power. It leads to a non-perturbative many-body
theory that includes summation of ladder diagrams \cite{brueckner1955}, ring
diagrams \cite{GB1957}, and an infinite-order
generalization of many-body perturbation theory
\cite{Bart_silver74, Bart_silver76}.
Developments and applications of coupled cluster theory took
different routes in chemistry and nuclear physics. In quantum
chemistry, coupled cluster developments and applications have proven
to be extremely useful, see for example the review by Barrett and
Musial as well as the recent textbook by Shavitt and Bartlett \cite{shavittbartlett2009}.
Many previous applications to nuclear physics struggled with the
repulsive character of the nuclear forces and limited basis sets
used in the computations. Most of these problems have been overcome
during the last decade and coupled cluster theory is one of the
computational methods of preference for doing nuclear physics, with
  applications ranging from light nuclei to medium-heavy nuclei, see
  for example the recent reviews by Hagen {\em et al} \cite{papenbrock2014,hagen2016}.


\subsection{A quick tour of Coupled Cluster theory}

  The ansatz for the wavefunction (ground state) is given by
  \begin{equation}
     \vert \Psi_0\rangle = \vert \Psi_{CC}\rangle = e^{\hat{T}} \vert
     \Phi_0\rangle = \left( \sum_{n=1}^{A} \frac{1}{n!} \hat{T}^n
     \right) \vert \Phi_0\rangle,
  \end{equation}
  where $A$ represents the maximum number of particle-hole excitations
  and $\hat{T}$ is the cluster operator defined as
  \begin{align}
              \hat{T} &= \hat{T}_1 + \hat{T}_2 + \ldots + \hat{T}_A
              \\ \hat{T}_n &= \left(\frac{1}{n!}\right)^2
              \sum_{\substack{ i_1,i_2,\ldots i_n \\ a_1,a_2,\ldots
                  a_n}} t_{i_1i_2\ldots i_n}^{a_1a_2\ldots a_n}
              a_{a_1}^\dagger a_{a_2}^\dagger \ldots a_{a_n}^\dagger
              a_{i_n} \ldots a_{i_2} a_{i_1}.
          \end{align}
      The energy is given by
      \begin{equation}
          E_{\mathrm{CC}} = \langle\Phi_0\vert \overline{H}\vert
          \Phi_0\rangle,
      \end{equation}
      where $\overline{H}$ is a similarity transformed Hamiltonian
      \begin{align}
          \overline{H}&= e^{-\hat{T}} \hat{H}_N e^{\hat{T}}
          \\ \hat{H}_N &= \hat{H} - \langle\Phi_0\vert \hat{H} \vert
          \Phi_0\rangle.
      \end{align}

      The coupled cluster energy is a function of the unknown cluster
      amplitudes $t_{i_1i_2\ldots i_n}^{a_1a_2\ldots a_n}$, given by
      the solutions to the amplitude equations
      \begin{equation}\label{eq:amplitudeeq}
          0 = \langle\Phi_{i_1 \ldots i_n}^{a_1 \ldots a_n}\vert
          \overline{H}\vert \Phi_0\rangle.
      \end{equation}
In order to set up the above equations, 
the similarity transformed Hamiltonian $\overline{H}$ is expanded
  using the Baker-Campbell-Hausdorff expression,
      \begin{equation}\label{eq:bch}
          \overline{H}= \hat{H}_N + \left[ \hat{H}_N, \hat{T} \right]
          + \frac{1}{2} \left[\left[ \hat{H}_N, \hat{T} \right],
            \hat{T}\right] + \ldots + \frac{1}{n!} \left[
            \ldots \left[ \hat{H}_N, \hat{T} \right], \ldots \hat{T}
            \right] +\dots
      \end{equation}
  and simplified using the connected cluster theorem
      \begin{equation}
          \overline{H}= \hat{H}_N + \left( \hat{H}_N \hat{T}\right)_c
          + \frac{1}{2} \left( \hat{H}_N \hat{T}^2\right)_c + \dots +
          \frac{1}{n!} \left( \hat{H}_N \hat{T}^n\right)_c +\dots
      \end{equation}
We will discuss parts of the the derivation below.
For the full derivation of these expressions, see for example Ref.~\cite{shavittbartlett2009}. 

A much used approximation is to truncate the cluster operator
$\hat{T}$ at the $n=2$ level. This defines the so-called singes and
doubles approximation to the coupled cluster wavefunction, normally
shortened to CCSD.
The coupled cluster wavefunction is now given by
  \begin{equation}
              \vert \Psi_{CC}\rangle = e^{\hat{T}_1 + \hat{T}_2} \vert
              \Phi_0\rangle
  \end{equation}
  where
          \begin{align*}
              \hat{T}_1 &= \sum_{ia} t_{i}^{a} a_{a}^\dagger a_i
              \\ \hat{T}_2 &= \frac{1}{4} \sum_{ijab} t_{ij}^{ab}
              a_{a}^\dagger a_{b}^\dagger a_{j} a_{i}.
          \end{align*}

  The amplutudes $t$ play a role similar to the coefficients $C$ in
  the shell-model calculations. They are obtained by solving a set of
  non-linear equations similar to those discussed above in connection
  with the configuration interaction theory  discussion, see Eqs.~(\ref{eq:c1p1h}) and (\ref{eq:c2p2h}). 

  If we truncate our equations at the CCSD level, it corresponds to
  performing a transformation of the Hamiltonian matrix of the
  following type for the six particle problem (with a two-body
  Hamiltonian) discussed in section \ref{sec:chap8fci}
  \begin{table}
\caption{Schematic representation of blocks of matrix elements which are set to zero using the CCSD approximation.}
  \begin{center}
  \begin{tabular}{cccccccc}
  \hline \multicolumn{1}{c}{ } & \multicolumn{1}{c}{ $0p-0h$ } &
  \multicolumn{1}{c}{ $1p-1h$ } & \multicolumn{1}{c}{ $2p-2h$ } &
  \multicolumn{1}{c}{ $3p-3h$ } & \multicolumn{1}{c}{ $4p-4h$ } &
  \multicolumn{1}{c}{ $5p-5h$ } & \multicolumn{1}{c}{ $6p-6h$ }
  \\ \hline $0p-0h$ & $\tilde{x}$ & $\tilde{x}$ & $\tilde{x}$ & 0 & 0
  & 0 & 0 \\ $1p-1h$ & 0 & $\tilde{x}$ & $\tilde{x}$ & $\tilde{x}$ & 0
  & 0 & 0 \\ $2p-2h$ & 0 & $\tilde{x}$ & $\tilde{x}$ & $\tilde{x}$ &
  $\tilde{x}$ & 0 & 0 \\ $3p-3h$ & 0 & $\tilde{x}$ & $\tilde{x}$ &
  $\tilde{x}$ & $\tilde{x}$ & $\tilde{x}$ & 0 \\ $4p-4h$ & 0 & 0 &
  $\tilde{x}$ & $\tilde{x}$ & $\tilde{x}$ & $\tilde{x}$ & $\tilde{x}$
  \\ $5p-5h$ & 0 & 0 & 0 & $\tilde{x}$ & $\tilde{x}$ & $\tilde{x}$ &
  $\tilde{x}$ \\ $6p-6h$ & 0 & 0 & 0 & 0 & $\tilde{x}$ & $\tilde{x}$ &
  $\tilde{x}$ \\ \hline
  \end{tabular}
  \end{center}
  \end{table}

  In our configuration interaction theory discussion the correlation energy is defined as (with a two-body Hamiltonian) 
  \[
  \Delta E=\sum_{ai}\langle i| \hat{f}|a \rangle C_{i}^{a}+
  \sum_{abij}\langle ij | \hat{v}| ab \rangle C_{ij}^{ab}.
  \]
We can obtain a similar expression for the correlation energy using coupled cluster theory. 
Using Eq.~(\ref{eq:bch}) we can write the expression for the coupled cluster  ground state energy as an infinite sum over nested commutators
        \begin{align*}
            E_{CC} &= \bra{\Psi_0}\Bigl( \hat{H}_N + \left[ \hat{H}_N, \hat{T} \right] +
                \frac{1}{2} \left[\left[ \hat{H}_N, \hat{T} \right], \hat{T}\right] \\
                & \qquad + \frac{1}{3!} \left[ \left[\left[ \hat{H}_N, \hat{T} \right], \hat{T}\right], \hat{T} \right] \\
                & \qquad + \frac{1}{4!} \left[ \left[ \left[\left[ \hat{H}_N, \hat{T} \right], \hat{T}\right], \hat{T} \right], \hat{T} \right] ++ \Bigr) \ket{\Psi_0}. \\
        \end{align*}
One can show that this infinite series truncates naturally at a given order of nested commutators \cite{shavittbartlett2009}. 
Let us demonstrate briefly how we can construct the expressions for the correlation 
energy by approximating $\hat{T}$ at the CCSD level, that is $\hat{T}\approx \hat{T}_1+\hat{T}_2$.
        The first term is zero by construction
        \begin{equation*}
            \bra{\Psi_0} \hat{H}_N \ket{\Psi_0} = 0.
        \end{equation*}       
     The second term can be split into the following contributions
        \begin{align*}
        \bra{\Psi_0}\left[ \hat{H}_N, \hat{T} \right]\ket{\Psi_0} & = 
            \bra{\Psi_0} \Bigl(\left[ \hat{F}_N, \hat{T}_1 \right] + \left[ \hat{F}_N, \hat{T}_2 \right]
            + \left[ \hat{V}_N, \hat{T}_1 \right] + \left[ \hat{V}_N, \hat{T}_2 \right] \Bigr) \ket{\Psi_0}.
    \end{align*}
Let us start with $\left[ \hat{F}_N, \hat{T}_1 \right]$, where the one-body operator $\hat{F}_N$ is defined in Eq.~(\ref{eq:hfn}). 
In the equations below we employ the shorthand $f^p_q = \langle p\vert \hat{f} \vert q\rangle$.  
We write out the commutator  as
    \begin{align*}
        \left[ \hat{F}_N, \hat{T}_1 \right] &= \sum_{pqia} \left(f_q^p \normord{a_p^\dagger a_q} 
            t_i^a \normord{a_a^\dagger a_i} - t_i^a \normord{a_a^\dagger a_i} f_q^p \normord{a_p^\dagger a_q} \right) \\
        &= \sum_{pqia} f_q^p t_i^a \left( \normord{a_p^\dagger a_q} \normord{a_a^\dagger a_i} -
                \normord{a_a^\dagger a_i} \normord{a_p^\dagger a_q} \right).
    \end{align*}
We have skipped here the curly brackets that indicate that the chains of operators are normal ordered with respect to the new reference state. 
If we consider the second set of operators and rewrite them with curly brackets (bringing back the normal ordering) we have
        \begin{align*}
            \left\{a_a^\dagger a_i\right\} \left\{a_p^\dagger a_q \right\} &= \normord{a_a^\dagger a_i a_p^\dagger a_q}
                = \normord{a_p^\dagger a_q a_a^\dagger a_i} \\ 
        \normord{a_p^\dagger a_q}\normord{a_a^\dagger a_i} &= \normord{a_p^\dagger a_q a_a^\dagger a_i}  \\
            & \quad + \normord{
               \contraction{}{a}{{}^\dagger_pa_q a^\dagger_a}{a}
                a^\dagger_p a_q a^\dagger_a a_i} +
            \normord{
                \contraction{a^\dagger_p}{a}{{}_q}{a}
                a^\dagger_p a_q a^\dagger_a a_i} \\ 
            & \quad + \normord{
                \contraction[1.5ex]{}{a}{{}^\dagger_pa_q a^\dagger_a}{a}
                \contraction{a^\dagger_p}{a}{{}_q}{a}
                a^\dagger_p a_q a^\dagger_a a_i} \\ 
            &=  \normord{a_p^\dagger a_q a_a^\dagger a_i} + \delta_{qa} \normord{a_p^\dagger a_i} + \delta_{pi} \normord{a_q a_a^\dagger}
            + \delta_{qa}\delta_{pi}.
        \end{align*}
We can then rewrite the two sets of operators as
        \begin{align*}
            \left\{a_p^\dagger a_q \right\}\left\{a_a^\dagger a_i\right\} - \left\{a_a^\dagger a_i\right\} \left\{a_p^\dagger a_q \right\} &= \delta_{qa} \left\{ a_p^\dagger a_i\right\} + \delta_{pi} \left\{ a_q a_a^\dagger \right\} + \delta_{qa}\delta_{pi}.
    \end{align*}

        Inserted into the original expression, we arrive at the explicit value of the commutator
        \[
        \left[ \hat{F}_N, \hat{T}_1 \right] = \sum_{pai} f_a^p t_i^a \normord{a_p^\dagger a_i} + 
                \sum_{qai} f_q^i t_i^a \normord{a_q a_a^\dagger} + \sum_{ai} f_a^i t_i^a.
        \]
We are now ready to compute the expectation value with respect to our reference state. Since the two first terms require the ground state linking to 
a one-particle-one-hole state, the first two terms are zero and we are left with 
\begin{equation}\label{eq:firsttermE}
\langle \Phi_0 \vert \left[ \hat{F}_N, \hat{T}_1 \right] \vert \Phi_0\rangle = \sum_{ai} f_a^i t_i^a.
\end{equation}
The two first terms will however contribute to the calculation of the Hamiltonian  matrix element which connects the ground state and a one-particle-one-hole excitation. 
  
Let us next look at the term $\left[ \hat{F}_N, \hat{T}_2 \right]$. We have
    \begin{align*}
        \left[ \hat{F}_N, \hat{T}_2 \right] 
        &= \left[\sum_{pq} f_q^p \normord{a^\dagger_p a_q},
            \frac{1}{4}\sum_{ijab} t_{ij}^{ab} \normord{a^\dagger_a a^\dagger_b a_j a_i} \right] \\
        &= \frac{1}{4}\sum_{\substack{pq\\ijab}}
            f_q^p t_{ij}^{ab}
        \left( \normord{a^\dagger_p a_q} \normord{a^\dagger_a a^\dagger_b a_j a_i}
            - \normord{a^\dagger_a a^\dagger_b a_j a_i} \normord{a^\dagger_p a_q} \right).
    \end{align*}
The last set of operators can be rewritten as 
    \begin{align*}
        \normord{a^\dagger_a a^\dagger_b a_j a_i} \normord{a^\dagger_p a_q} &= 
            \normord{a^\dagger_a a^\dagger_b a_j a_i a^\dagger_p a_q} \\ 
        &= \normord{a^\dagger_p a_q a^\dagger_a a^\dagger_b a_j a_i} 
        \\
        \normord{a^\dagger_p a_q} \normord{a^\dagger_a a^\dagger_b a_j a_i} &= 
            \normord{a^\dagger_p a_q a^\dagger_a a^\dagger_b a_j a_i}
        + \left\{ 
        \contraction{}{a}{{}^\dagger_pa_q a^\dagger_a a^\dagger_b}{a}
        a^\dagger_p a_q a^\dagger_a a^\dagger_b a_j a_i\right\}
        + \left\{ 
        \contraction{}{a}{{}^\dagger_pa_q a^\dagger_a a^\dagger_b a_j}{a}
        a^\dagger_p a_q a^\dagger_a a^\dagger_b a_j a_i\right\} \\
        & \quad 
        + \left\{ 
        \contraction{a^\dagger_p}{a}{{}_q}{a}
        a^\dagger_p a_q a^\dagger_a a^\dagger_b a_j a_i\right\}
        + \left\{ 
        \contraction{a^\dagger_p}{a}{{}_q a^\dagger_a}{a}
        a^\dagger_p a_q a^\dagger_a a^\dagger_b a_j a_i\right\}
        + \left\{ 
        \contraction{a^\dagger_p}{a}{{}_q}{a}
        \contraction[1.5ex]{}{a}{{}^\dagger_pa_q a^\dagger_a a^\dagger_b}{a}
        a^\dagger_p a_q a^\dagger_a a^\dagger_b a_j a_i\right\} \\
        & \quad 
        + \left\{ 
        \contraction{a^\dagger_p}{a}{{}_q}{a}
        \contraction[1.5ex]{}{a}{{}^\dagger_pa_q a^\dagger_a a^\dagger_b a_j}{a}
        a^\dagger_p a_q a^\dagger_a a^\dagger_b a_j a_i\right\}
        + \left\{ 
        \contraction{a^\dagger_p}{a}{{}_q a^\dagger_a}{a}
        \contraction[1.5ex]{}{a}{{}^\dagger_pa_q a^\dagger_a a^\dagger_b}{a}
        a^\dagger_p a_q a^\dagger_a a^\dagger_b a_j a_i\right\}
        + \left\{ 
        \contraction{a^\dagger_p}{a}{{}_q a^\dagger_a}{a}
        \contraction[1.5ex]{}{a}{{}^\dagger_pa_q a^\dagger_a a^\dagger_b a_j}{a}
        a^\dagger_p a_q a^\dagger_a a^\dagger_b a_j a_i\right\} \\ 
        &= \normord{a^\dagger_p a_q a^\dagger_a a^\dagger_b a_j a_i}
        - \delta_{pj} \normord{a_q a^\dagger_a a^\dagger_b a_i}
        + \delta_{pi} \normord{a_q a^\dagger_a a^\dagger_b a_j} \\
        & \quad + \delta_{qa} \normord{a^\dagger_p a^\dagger_b a_j a_i}
        - \delta_{qb}\normord{a^\dagger_p a^\dagger_a a_j a_i} 
        - \delta_{pj} \delta_{qa} \normord{a^\dagger_b a_i} \\
        & \quad + \delta_{pi} \delta_{qa} \normord{a^\dagger_b a_j}
        + \delta_{pj} \delta_{qb} \normord{a^\dagger_a a_i}
        - \delta_{pi} \delta_{qb} \normord{a^\dagger_a a_j}.
    \end{align*}
 We can then rewrite the two sets of operators as
    \begin{align*}
        & \Bigl( \normord{a^\dagger_p a_q} \normord{a^\dagger_a a^\dagger_b a_j a_i}
            - \normord{a^\dagger_a a^\dagger_b a_j a_i} \normord{a^\dagger_p a_q} \Bigr) = \\
        & \qquad - \delta_{pj} \normord{a_q a^\dagger_a a^\dagger_b a_i}
        + \delta_{pi} \normord{a_q a^\dagger_a a^\dagger_b a_j}
        + \delta_{qa} \normord{a^\dagger_p a^\dagger_b a_j a_i} \\
        & \qquad - \delta_{qb}\normord{a^\dagger_p a^\dagger_a a_j a_i} 
        - \delta_{pj} \delta_{qa} \normord{a^\dagger_b a_i}
        + \delta_{pi} \delta_{qa} \normord{a^\dagger_b a_j}
        + \delta_{pj} \delta_{qb} \normord{a^\dagger_a a_i} \\
        & \qquad - \delta_{pi} \delta_{qb} \normord{a^\dagger_a a_j},
    \end{align*}
which, when    inserted into the original expression gives us
    \begin{align*}
        \left[ \hat{F}_N, \hat{T}_2 \right]
        &= \frac{1}{4} \sum_{\substack{pq\\abij}} f_q^p t_{ij}^{ab} \Bigl(
        - \delta_{pj} \normord{a_q a^\dagger_a a^\dagger_b a_i}
        + \delta_{pi} \normord{a_q a^\dagger_a a^\dagger_b a_j} \\
        & \quad + \delta_{qa} \normord{a^\dagger_p a^\dagger_b a_j a_i}
        - \delta_{qb}\normord{a^\dagger_p a^\dagger_a a_j a_i} 
        - \delta_{pj} \delta_{qa} \normord{a^\dagger_b a_i} \\
        & \quad + \delta_{pi} \delta_{qa} \normord{a^\dagger_b a_j}
        + \delta_{pj} \delta_{qb} \normord{a^\dagger_a a_i}
        - \delta_{pi} \delta_{qb} \normord{a^\dagger_a a_j} \Bigr).
    \end{align*}
    After renaming indices and changing the order of operators, we arrive at the explicit expression
    \[
        \left[ \hat{F}_N, \hat{T}_2 \right]
        = \frac{1}{2} \sum_{qijab} f_q^i t_{ij}^{ab} \normord{a_q a^\dagger_a a^\dagger_b a_j}
        + \frac{1}{2} \sum_{pijab} f_a^p t_{ij}^{ab} \normord{a^\dagger_p a^\dagger_b a_j a_i}+ \sum_{ijab} f_a^i t_{ij}^{ab} \normord{a^\dagger_b a_j}. 
    \]
In this case we have two sets of two-particle-two-hole operators and one-particle-one-hole operators and all these terms result in zero expectation values. 
However, these terms are important for the amplitude equations.  
In a similar was we can compute the terms involving the interaction $\hat{V}_N$.  
We obtain then
    \begin{align*}
        \bra{\Phi_0} \left[ \hat{V}_N, \hat{T}_1 \right] \ket{\Phi_0} &= 
            \bra{\Phi_0}
                \left[ \frac{1}{4} \sum_{pqrs} \bra{pq}\hat{v}\ket{rs} \normord{a^\dagger_p a^\dagger_q a_s  a_r},
                    \sum_{ia} t_i^a \normord{a^\dagger_a a_i} \right] \ket{\Phi_0} \\ 
            &= \frac{1}{4}\sum_{\substack{
                pqr \\
                sia}} \bra{pq}\ket{rs} t_i^a \bra{\Phi_0} 
                \left[ \normord{a^\dagger_p a^\dagger_q a_s  a_r}, \normord{a^\dagger_a a_i} \right]
                \ket{\Phi_0} \\ 
        &= 0,
    \end{align*}
and
    \begin{align*}
        & \bra{\Phi_0} \left[ \hat{V}_N, \hat{T}_2 \right] \ket{\Phi_0}= \\
            & \quad \bra{\Phi_0}
                \left[ \frac{1}{4} \sum_{pqrs} \bra{pq}\hat{v}\ket{rs} \normord{a^\dagger_p a^\dagger_q a_s  a_r},
                    \frac{1}{4}\sum_{ijab} t_{ij}^{ab} \normord{a^\dagger_a a^\dagger_b a_j a_i} \right] \ket{\Phi_0} \\ 
            &= \frac{1}{16}\sum_{\substack{
                    pqr \\
                    sijab}} \bra{pq}\hat{v}\ket{rs}t_{ij}^{ab} \bra{\Phi_0} 
                \left[ \normord{a^\dagger_p a^\dagger_q a_s  a_r}, \normord{a^\dagger_a a^\dagger_b a_j a_i} \right]
                \ket{\Phi_0} \\ 
            &= \frac{1}{16}\sum_{\substack{
                    pqr \\
                    sijab}} \bra{pq}\hat{v}\ket{rs}t_{ij}^{ab} \bra{\Phi_0}
            \Bigl(
            \left\{
            \contraction{a^\dagger_p a^\dagger_q a_s}{a}{{}_r}{a}
            \contraction[1.25ex]{a^\dagger_p a^\dagger_q}{a}{{}_s a_r a^\dagger_a}{a}
            \contraction[1.50ex]{a^\dagger_p}{a}{{}^\dagger_q a_s a_r a^\dagger_a a^\dagger_b}{a}
            \contraction[1.75ex]{}{a}{{}^\dagger_p a^\dagger_q a_s a_r a^\dagger_a a^\dagger_b a_j}{a}
            a^\dagger_p a^\dagger_q a_s  a_r a^\dagger_a a^\dagger_b a_j a_i \right\}
            + \left\{
            \contraction{a^\dagger_p a^\dagger_q}{a}{{}_s a_r}{a}
            \contraction[1.25ex]{a^\dagger_p a^\dagger_q a_s}{a}{{}_r a^\dagger_p}{a}
            \contraction[1.50ex]{a^\dagger_p}{a}{{}^\dagger_q a_s a_r a^\dagger_a a^\dagger_b}{a}
            \contraction[1.75ex]{}{a}{{}^\dagger_p a^\dagger_q a_s a_r a^\dagger_a a^\dagger_b a_j}{a}
            a^\dagger_p a^\dagger_q a_s  a_r a^\dagger_a a^\dagger_b a_j a_i \right\} \\
            & \quad \left\{
            \contraction{a^\dagger_p a^\dagger_q a_s}{a}{{}_r}{a}
            \contraction[1.25ex]{a^\dagger_p a^\dagger_q}{a}{{}_s a_r a^\dagger_a}{a}
            \contraction[1.5ex]{}{a}{{}^\dagger_p a^\dagger_q a_s a_r a^\dagger_a a^\dagger_b}{a}
            \contraction[1.75ex]{a^\dagger_p}{a}{{}^\dagger_q a_s a_r a^\dagger_a a^\dagger_b a_j}{a}
            a^\dagger_p a^\dagger_q a_s  a_r a^\dagger_a a^\dagger_b a_j a_i \right\}
            + \left\{
            \contraction{a^\dagger_p a^\dagger_q}{a}{{}_s a_r}{a}
            \contraction[1.25ex]{a^\dagger_p a^\dagger_q a_s}{a}{{}_r a^\dagger_p}{a}
            \contraction[1.5ex]{}{a}{{}^\dagger_p a^\dagger_q a_s a_r a^\dagger_a a^\dagger_b}{a}
            \contraction[1.75ex]{a^\dagger_p}{a}{{}^\dagger_q a_s a_r a^\dagger_a a^\dagger_b a_j}{a}
            a^\dagger_p a^\dagger_q a_s  a_r a^\dagger_a a^\dagger_b a_j a_i \right\}
            \Bigr) \ket{\Phi_0} \\ 
            &= \frac{1}{4} \sum_{ijab} \bra{ij}\hat{v}\ket{ab} t_{ij}^{ab}.
    \end{align*}
The final contribution to the correlation energy comes from the non-linear terms with the amplitudes squared. 
The contribution from the $\hat{T}^2$ is given by
    \begin{align*}
        & \bra{\Phi_0} \frac{1}{2} \left( \hat{V}_N \hat{T}_1^2 \right) \ket{\Phi_0} = \\
            & \quad \frac{1}{8} \sum_{pqrs} \sum_{ijab} \bra{pq}\hat{v}\ket{rs} t_i^a t_j^b 
            \bra{\Phi_0} \left(\normord{a^\dagger_p a^\dagger_q a_s  a_r} 
            \normord{a^\dagger_a a_i} \normord{a^\dagger_b a_j} \right)_c\ket{\Phi_0} \\ 
        &= \frac{1}{8} \sum_{pqrs} \sum_{ijab} \bra{pq}\hat{v}\ket{rs} t_i^a t_j^b \bra{\Phi_0} \\
        & \quad \Bigl( 
        \left\{
        \contraction{a^\dagger_p a^\dagger_q a_s}{a}{{}_r}{a}
        \contraction[1.25ex]{a^\dagger_p}{a}{{}^\dagger_q a_s a_r a^\dagger_a}{a}
        \contraction[1.5ex]{a^\dagger_p a^\dagger_q }{a}{{}_s a_r a^\dagger_a a_i}{a}
        \contraction[1.75ex]{}{a}{{}^\dagger_p a^\dagger_q a_s a_r a^\dagger_a a_i a^\dagger_b}{a}
        a^\dagger_p a^\dagger_q a_s  a_r a^\dagger_a a_i a^\dagger_b a_j \right\}
        +\left\{
        \contraction{a^\dagger_p a^\dagger_q}{a}{{}_s a_r}{a}
        \contraction[1.25ex]{a^\dagger_p}{a}{{}^\dagger_q a_s a_r a^\dagger_a}{a}
        \contraction[1.5ex]{a^\dagger_p a^\dagger_q a_s}{a}{{}_r a^\dagger_a a_i}{a}
        \contraction[1.75ex]{}{a}{{}^\dagger_p a^\dagger_q a_s a_r a^\dagger_a a_i a^\dagger_b}{a}
        a^\dagger_p a^\dagger_q a_s  a_r a^\dagger_a a_i a^\dagger_b a_j \right\}
        + \left\{
        \contraction{a^\dagger_p a^\dagger_q a_s}{a}{{}_r}{a}
        \contraction[1.25ex]{}{a}{{}^\dagger_p q^\dagger_q a_s a_r a^\dagger_a}{a}
        \contraction[1.5ex]{a^\dagger_p a^\dagger_q }{a}{{}_s a_r a^\dagger_a a_i}{a}
        \contraction[1.75ex]{a^\dagger_p}{a}{{}^\dagger_q a_s a_r a^\dagger_a a_i a^\dagger_b}{a}
        a^\dagger_p a^\dagger_q a_s  a_r a^\dagger_a a_i a^\dagger_b a_j \right\} \\
        & \quad +\left\{
        \contraction{a^\dagger_p a^\dagger_q}{a}{{}_s a_r}{a}
        \contraction[1.25ex]{}{a}{{}^\dagger_p q^\dagger_q a_s a_r a^\dagger_a}{a}
        \contraction[1.5ex]{a^\dagger_p a^\dagger_q a_s}{a}{{}_r a^\dagger_a a_i}{a}
        \contraction[1.75ex]{a^\dagger_p}{a}{{}^\dagger_q a_s a_r a^\dagger_a a_i a^\dagger_b}{a}
        a^\dagger_p a^\dagger_q a_s  a_r a^\dagger_a a_i a^\dagger_b a_j \right\}
        \Bigr) \ket{\Phi_0} \\ 
        &= \frac{1}{2} \sum_{ijab} \bra{ij}\hat{v}\ket{ab} t_i^a t_j^b.
    \end{align*}
 Collecting all terms we have   the final expression for the correlation energy with a two-body interaction given by
  \begin{equation}\label{eq:energyccsd}
  \Delta E=\sum_{ai}\langle i| \hat{f}|a \rangle t_{i}^{a}+\frac{1}{2} \sum_{ijab} \bra{ij}\hat{v}\ket{ab} t_i^a t_j^b+
  \frac{1}{4}\sum_{ijab}\langle ij | \hat{v}| ab \rangle t_{ij}^{ab}.
  \end{equation}
We leave it as a challenge to the reader to derive the corresponding equations for the Hamiltonian matrix elements of Eq.~\ref{eq:amplitudeeq}.


  There are several interesting features with the coupled cluster
  equations. With a truncation like CCSD or even with the inclusion of
  triples (CCSDT), we can include to infinite order correlations based
  on one-particle-one-hole and two-particle-two-hole contributions.
  We can include a large basis of single-particle states, normally not
  possible in standard FCI calculations. Typical FCI calculations for
  light nuclei $A\le 16$ can be performed in at most some few harmonic
  oscillator shells. For heavier nuclei, at most two major shells can
  be included due to too large dimensionalities.  However, Coupled
  Cluster theory is non-variational and if we want to find properties
  of excited states, additional calculations via for example equation
  of motion methods are needed \cite{shavittbartlett2009,hagen2014}.
  If correlations are strong, a single-reference ansatz may not be the
  best starting point and a multi-reference approximation is needed
  \cite{jansen2015}. Furthermore, we cannot quantify properly the
  error we make when truncations are made in the cluster operator.

  \subsection{The CCD approximation}

  We will now approximate the cluster operator $\hat{T}$ to include
  only $2p-2h$ correlations. This leads to the so-called CCD
  approximation, that is
  \[
  \hat{T}\approx
  \hat{T}_2=\frac{1}{4}\sum_{abij}t_{ij}^{ab}a^{\dagger}_aa^{\dagger}_ba_ja_i,
  \]
  meaning that we have
  \[
  \vert \Psi_0 \rangle \approx \vert \Psi_{CCD} \rangle =
  \exp{\left(\hat{T}_2\right)}\vert \Phi_0\rangle.
  \]

  Inserting these equations in the expression for the computation of
  the energy we have, with a Hamiltonian defined with respect to a
  general reference vacuum
  \[
  \hat{H}=\hat{H}_N+E_{\mathrm{ref}},
  \]
  with
  \[
  \hat{H}_N=\sum_{pq}\langle p \vert \hat{f} \vert q \rangle
  a^{\dagger}_pa_q + \frac{1}{4}\sum_{pqrs}\langle pq \vert \hat{v}
  \vert rs \rangle a^{\dagger}_pa^{\dagger}_qa_sa_r,
  \]
  we obtain that the energy can be written as
  \[
  \langle \Phi_0 \vert
  \exp{-\left(\hat{T}_2\right)}\hat{H}_N\exp{\left(\hat{T}_2\right)}\vert
  \Phi_0\rangle = \langle \Phi_0 \vert \hat{H}_N(1+\hat{T}_2)\vert
  \Phi_0\rangle = E_{CCD}.
  \]
  This quantity becomes
  \[
  E_{CCD}=E_{\mathrm{ref}}+\frac{1}{4}\sum_{abij}\langle ij \vert
  \hat{v} \vert ab \rangle t_{ij}^{ab},
  \]
  where the latter is the correlation energy from this level of
  approximation of coupled cluster  theory.  Similarly, the expression for the
  amplitudes reads (see problem \ref{problem:amplitudes})
  \[
  \langle \Phi_{ij}^{ab} \vert
  \exp{\left(-\hat{T}_2\right)}\hat{H}_N\exp{\left(\hat{T}_2\right)}\vert
  \Phi_0\rangle = 0.
  \]
  These equations can be reduced to (after several applications of
  Wick's theorem), for all $i > j$ and all $a > b$,
  \begin{align}
  0 = \langle ab \vert \hat{v} \vert ij \rangle +
  \left(\epsilon_a+\epsilon_b-\epsilon_i-\epsilon_j\right)t_{ij}^{ab}
  & \nonumber \\ +\frac{1}{2}\sum_{cd} \langle ab \vert \hat{v} \vert
  cd \rangle t_{ij}^{cd}+\frac{1}{2}\sum_{kl} \langle kl \vert \hat{v}
  \vert ij \rangle t_{kl}^{ab}+\hat{P}(ij\vert ab)\sum_{kc} \langle kb
  \vert \hat{v} \vert cj \rangle t_{ik}^{ac} & \nonumber
  \\ +\frac{1}{4}\sum_{klcd} \langle kl \vert \hat{v} \vert cd \rangle
  t_{ij}^{cd}t_{kl}^{ab}+\hat{P}(ij)\sum_{klcd} \langle kl \vert
  \hat{v} \vert cd \rangle t_{ik}^{ac}t_{jl}^{bd}& \nonumber
  \\ -\frac{1}{2}\hat{P}(ij)\sum_{klcd} \langle kl \vert \hat{v} \vert
  cd \rangle t_{ik}^{dc}t_{lj}^{ab}-\frac{1}{2}\hat{P}(ab)\sum_{klcd}
  \langle kl \vert \hat{v} \vert cd \rangle t_{lk}^{ac}t_{ij}^{db},&
  \label{eq:ccd}
  \end{align}
  where we have defined
  \[
  \hat{P}\left(ab\right)= 1-\hat{P}_{ab},
  \]
  where $\hat{P}_{ab}$ interchanges two particles occupying the
  quantum numbers $a$ and $b$.  The operator $\hat{P}(ij\vert ab)$ is
  defined as
  \[
  \hat{P}(ij\vert ab) = (1-\hat{P}_{ij})(1-\hat{P}_{ab}).
  \]
  Recall also that the unknown amplitudes $t_{ij}^{ab}$ represent
  anti-symmetrized matrix elements, meaning that they obey the same
  symmetry relations as the two-body interaction, that is
  \[
  t_{ij}^{ab}=-t_{ji}^{ab}=-t_{ij}^{ba}=t_{ji}^{ba}.
  \]
  The two-body matrix elements are also anti-symmetrized, meaning that
  \[
  \langle ab \vert \hat{v} \vert ij \rangle = -\langle ab \vert
  \hat{v} \vert ji \rangle= -\langle ba \vert \hat{v} \vert ij
  \rangle=\langle ba \vert \hat{v} \vert ji \rangle.
  \]
  The non-linear equations for the unknown amplitudes $t_{ij}^{ab}$
  are solved iteratively. We discuss the implementation of these
  equations below.

  \subsection{Approximations to the full CCD equations.}
  It is useful to make approximations to the equations for the
  amplitudes. These serve as important benchmarks when we are to develop a many-body code.
The standard method for solving these equations is to
  set up an iterative scheme where method's like Newton's method or
  similar root searching methods are used to find the amplitudes see for example Ref.~\cite{hagen2007}.

  Iterative solvers need a guess for the amplitudes. A good starting
  point is to use the correlated wave operator from perturbation
  theory to first order in the interaction.  This means that we define
  the zeroth approximation to the amplitudes as
  \[
  t^{(0)}=\frac{\langle ab \vert \hat{v} \vert ij
    \rangle}{\left(\epsilon_i+\epsilon_j-\epsilon_a-\epsilon_b\right)},
  \]
  leading to our first approximation for the correlation energy at the
  CCD level to be equal to second-order perturbation theory without
  $1p-1h$ excitations, namely
  \[
  \Delta E_{\mathrm{CCD}}^{(0)}=\frac{1}{4}\sum_{abij} \frac{\langle
    ij \vert \hat{v} \vert ab \rangle \langle ab \vert \hat{v} \vert
    ij
    \rangle}{\left(\epsilon_i+\epsilon_j-\epsilon_a-\epsilon_b\right)}.
  \]

  With this starting point, we are now ready to solve
  Eq. (\ref{eq:ccd}) iteratively. Before we attack the full equations,
  it is however instructive to study a truncated version of the
  equations. We will first study the following approximation where we
  take away all terms except the linear terms that involve the
  single-particle energies and the two-particle intermediate
  excitations, that is
  \begin{equation}
  0 = \langle ab \vert \hat{v} \vert ij \rangle +
  \left(\epsilon_a+\epsilon_b-\epsilon_i-\epsilon_j\right)t_{ij}^{ab}+\frac{1}{2}\sum_{cd}
  \langle ab \vert \hat{v} \vert cd \rangle t_{ij}^{cd}.
  \label{eq:ccd1}
  \end{equation}

  Setting the single-particle energies for the hole states equal to an
  energy variable $\omega = \epsilon_i+\epsilon_j$,
  Eq.~(\ref{eq:ccd1}) reduces to the well-known equations for the
  so-called $G$-matrix, widely used in infinite matter and finite
  nuclei studies, see for example Refs.~\cite{day1967,hh2000}.  The equation can then be reordered
  and solved by matrix inversion.  To see this let us define the
  following quantity
  \[
  \tau_{ij}^{ab}=
  \left(\omega-\epsilon_a-\epsilon_b\right)t_{ij}^{ab},
  \]
  and inserting
  \[
  1=\frac{\left(\omega-\epsilon_c-\epsilon_d\right)}{\left(\omega-\epsilon_c-\epsilon_d\right)},
  \]
  in the intermediate sums over $cd$ in Eq.~(\ref{eq:ccd1}), we can
  rewrite the latter equation as
  \[
  \tau_{ij}^{ab}(\omega)= \langle ab \vert \hat{v} \vert ij \rangle +
  \frac{1}{2}\sum_{cd} \langle ab \vert \hat{v} \vert cd \rangle
  \frac{1}{\omega-\epsilon_c-\epsilon_d}\tau_{ij}^{cd}(\omega),
  \]
  where we have indicated an explicit energy dependence. This
  equation, transforming a two-particle configuration into a single
  index, can be transformed into a matrix inversion problem.  Solving
  the equations for a fixed energy $\omega$ allows us to compare
  directly with results from Green's function theory when only
  two-particle intermediate states are included.

  To solve Eq. (\ref{eq:ccd1}), we would thus start with a guess for
  the unknown amplitudes, normally using the wave operator defined by
  first order in perturbation theory, leading to a zeroth
  approximation to the energy given by second-order perturbation
  theory for the correlation energy.  A simple approach to the
  solution of Eq.~(\ref{eq:ccd1}), is to thus to
  \begin{enumerate}
  \item Start with a guess for the amplitudes and compute the zeroth
    approximation to the correlation energy

  \item Use the ansatz for the amplitudes to solve Eq. (\ref{eq:ccd1})
    via for example your root-finding method of choice (Newton's
    method or modifications thereof can be used) and continue these
    iterations till the correlation energy does not change more than a
    prefixed quantity $\lambda$; $\Delta E_{\mathrm{CCD}}^{(i)}-\Delta
    E_{\mathrm{CCD}}^{(i-1)} \le \lambda$.

  \item It is common during the iterations to scale the amplitudes
    with a parameter $\alpha$, with $\alpha \in (0,1]$ as
      $t^{(i)}=\alpha t^{(i)}+(1-\alpha)t^{(i-1)}$.
  \end{enumerate}

  \noindent
  The next approximation is to include the two-hole term in
  Eq.~(\ref{eq:ccd}), a term which allow us to make a link with
  Green's function theory with two-particle and two-hole
  correlations discussed in chapter 11. This means that we solve
  \begin{equation}
  0 = \langle ab \vert \hat{v} \vert ij \rangle +
  \left(\epsilon_a+\epsilon_b-\epsilon_i-\epsilon_j\right)t_{ij}^{ab}+\frac{1}{2}\sum_{cd}
  \langle ab \vert \hat{v} \vert cd \rangle
  t_{ij}^{cd}+\frac{1}{2}\sum_{kl} \langle kl \vert \hat{v} \vert ij
  \rangle t_{kl}^{ab}.
  \label{eq:ccd2}
  \end{equation}
  This equation is solved the same way as we would do for
  Eq. (\ref{eq:ccd1}). The final step is then to include all terms in
  Eq. (\ref{eq:ccd}).

\section{Developing a numerical project}\label{sec:chap8numproject}

When developing numerical projects we would like to emphasize some
topics we feel can help in structuring a large computational project.
Amongst these, the validation and verification of the correctness of
the employed algorithms and programs are central issues which can
save you a lot of time when developing a numerical project. In the
discussions below we will use repeatedly the simple pairing model of
problem \ref{problem:pairingmodel}.  This model allows for benchmarks
against exact results. In addition, it provides analytical answers to
several approximations, from perturbation theory to specific terms in the solution of the coupled
cluster equations, the in-medium similarity renormalization group
approach of chapter 10 and the Green's function approach of chapter
11. 

It is also important to develop an understanding of how our
algorithms can go wrong and how they can be implemented in order to
run as efficiently as possible. When working on a numerical project it
is important to keep in mind that computing covers numerical as well
as symbolic computing and paper and pencil solutions. Furthermore,
version control is something we strongly recommend. It does not only
save you time in case you struggle with odd errors in a new version of
your code. It allows you also to make science reproducible.  Making
your codes available to a larger audience and provinding proper
benchmarks allows fellow scientists to test what you have developed,
and perhaps come with considerable improvements and/or find flaws
or errors you were not aware of. 
Sharing your codes using for example modern version control
software makes thus your science reproducible and adds in a natural
way a sound ethical scientific element to what you develop.
In the discussions below, you will thus find several links to our 
common repository for the codes that we have developed.


When building up a numerical project there are several elements you should think of, amongst these we take the liberty of mentioning the following:
\begin{itemize}
\item Structure a code in terms of functions.
\item Modularize your codes.
\item Be able to  read input data flexibly.
\item Write unit tests (test functions) and let your code undergo heavy testing.
\item Refactor code in terms of classes (instead of functions only).
\item Conduct and automate large-scale numerical experiments.
\item New code is added in a modular fashion to a library (modules).
\item Programs are run through convenient user interfaces.
\item Use scripts in order to automatize  tedious manual work.
\item Make sure your scientific investigations are reproducible and document properly your results.
\end{itemize}


\subsection{Developing a CCD code for infinite matter}
  This section will focus on writing a working CCD code from
  scratch. If you are familiar with writing quantum many-body physics
  codes, feel free to skip ahead as we are going to go into some
  detail about implementing CCD as a computer code now. As we saw
  earlier, the CCD equations can be written as
  \begin{align}
  \left(\epsilon_i+\epsilon_j-\epsilon_a-\epsilon_b\right)t_{ij}^{ab}
  = \langle ab \vert \hat{v} \vert ij \rangle & \nonumber
  \\ +\frac{1}{2}\sum_{cd} \langle ab \vert \hat{v} \vert cd \rangle
  t_{ij}^{cd}+\frac{1}{2}\sum_{kl} \langle kl \vert \hat{v} \vert ij
  \rangle t_{kl}^{ab}+\hat{P}(ij\vert ab)\sum_{kc} \langle kb \vert
  \hat{v} \vert cj \rangle t_{ik}^{ac} & \nonumber
  \\ +\frac{1}{4}\sum_{klcd} \langle kl \vert \hat{v} \vert cd \rangle
  t_{ij}^{cd}t_{kl}^{ab}+\hat{P}(ij)\sum_{klcd} \langle kl \vert
  \hat{v} \vert cd \rangle t_{ik}^{ac}t_{jl}^{bd}& \nonumber
  \\ -\frac{1}{2}\hat{P}(ij)\sum_{klcd} \langle kl \vert \hat{v} \vert
  cd \rangle t_{ik}^{dc}t_{lj}^{ab}-\frac{1}{2}\hat{P}(ab)\sum_{klcd}
  \langle kl \vert \hat{v} \vert cd \rangle t_{lk}^{ac}t_{ij}^{db},&
  \label{eq:ccd2}
  \end{align}
  for all $i < j$ and all $a < b$, using the standard notation that
  $a,b,...$ are particle states and $i,j,...$ are hole states. With
  the CCD correlation energy given by
  \begin{equation}
  \Delta E_{CCD} = \frac{1}{4} \sum_{ijab}
  \braket{ij|\hat{v}|ab}t^{ab}_{ij}.
  \label{eq:ccdcorr}
  \end{equation}
  One way to solve these equations, is to write equation
  (\ref{eq:ccd2}) as a series of iterative nonlinear algebraic
  equations
  \begin{align}
  t_{ij}^{ab}{}^{(n+1)} = \frac{1}{\epsilon^{ab}_{ij}} \bigg(\langle
  ab \vert \hat{v} \vert ij \rangle & \nonumber
  \\ +\frac{1}{2}\sum_{cd} \langle ab \vert \hat{v} \vert cd \rangle
  t_{ij}^{cd}{}^{(n)}+\frac{1}{2}\sum_{kl} \langle kl \vert \hat{v}
  \vert ij \rangle t_{kl}^{ab}{}^{(n)}+\hat{P}(ij\vert ab)\sum_{kc}
  \langle kb \vert \hat{v} \vert cj \rangle t_{ik}^{ac}{}^{(n)} &
  \nonumber \\ +\frac{1}{4}\sum_{klcd} \langle kl \vert \hat{v} \vert
  cd \rangle
  t_{ij}^{cd}{}^{(n)}t_{kl}^{ab}{}^{(n)}+\hat{P}(ij)\sum_{klcd}
  \langle kl \vert \hat{v} \vert cd \rangle
  t_{ik}^{ac}{}^{(n)}t_{jl}^{bd}{}^{(n)}& \nonumber
  \\ -\frac{1}{2}\hat{P}(ij)\sum_{klcd} \langle kl \vert \hat{v} \vert
  cd \rangle
  t_{ik}^{dc}{}^{(n)}t_{lj}^{ab}{}^{(n)}-\frac{1}{2}\hat{P}(ab)\sum_{klcd}
  \langle kl \vert \hat{v} \vert cd \rangle
  t_{lk}^{ac}{}^{(n)}t_{ij}^{db}{}^{(n)} \bigg),&
  \label{eq:ccd3}
  \end{align}
  for all $i < j$ and all $a < b$, where $\epsilon^{ab}_{ij} =
  \left(\epsilon_i+\epsilon_j-\epsilon_a-\epsilon_b\right)$, and
  $t_{ij}^{ab}{}^{(n)}$ is the $t$ amplitude for the nth iteration of
  the series. This way, given some starting guess
  $t_{ij}^{ab}{}^{(0)}$, we can generate subsequent $t$ amplitudes
  that converges to some value. Discussion of the mathematical details
  regarding convergence will be presented below; for now we will talk
  about implementing these equations into a computer program and
  assume convergence. In pseudocode, the function that updates the $t$
  amplitudes looks like

\begin{svgraybox}
  \begin{algorithmic} 
  \State CCD\_Update() \For{$i \in \{0,N_{fermi}-1\}$ } \For{$j \in
    \{0,N_{fermi}-1\}$ } \For{$a \in \{N_{fermi},N_{sp}-1\}$ } \For{$b
    \in \{N_{fermi},N_{sp}-1\}$ } \State $\text{sum} \gets
  \text{TBME}[\text{index}(a,b,i,j)$] \For{$c \in
    \{N_{fermi},N_{sp}-1\}$ } \For{$d \in \{N_{fermi},N_{sp}-1\}$ }
  \State $\text{sum} \gets \text{sum} +
  0.5\times\text{ME}[\text{index}(a,b,c,d)] \times
  t\_\text{amplitudes}\_\text{old}[\text{index}(c,d,i,j)]$ \EndFor
  \EndFor \State ...  \State sum $\gets$ sum + (all other terms)
  \State ...  \State energy\_denom =
  SP\_energy[$i$]+SP\_energy[$j$]-SP\_energy[$a$]-SP\_energy[$b$]
  \State t\_amplitudes[index($a,b,i,j$)] = sum/energy\_denom \EndFor
  \EndFor \EndFor \EndFor
  \end{algorithmic}
\end{svgraybox} 
 Where $N_{fermi}$ is the fermi level and $N_{sp}$ is the total
  number of single particle (s.p.) states, indexed from 0 to
  $N_{sp}-1$. At the most basic level, the CCD equations are just the
  addition of many products containing $t_{ij}^{ab}$ amplitudes and
  two-body matrix elements (TBMEs) $\braket{ij|\hat{v}|ab}$.
  Care should thus be placed into how we store these objects. These are
  objects with four indices and a  sensible first implementation
  of the CCD equations would be to create two four-dimensional arrays to store the
  objects. However, it is often more convenient to work with simple
  one-dimensional arrays instead. The function $index()$ maps the four
  indices onto one index so that a one-dimensional array can be used. An example
  of such a function is
\begin{svgraybox} 
 \begin{algorithmic}
  \Function{index}{$p,q,r,s$} \State \textbf{return} $p\times N_{sp}^3 +
  q\times N_{sp}^2 + r\times N_{sp} + s$ \EndFunction
  \end{algorithmic}
\end{svgraybox}
  Because elements with repeated indices vanish,
  $t_{ii}^{ab}=t_{ij}^{aa}=0$ and
  $\braket{pp|\hat{v}|rs}=\braket{pq|\hat{v}|rr}=0$, data structures
  using this index function will contain many elements that are
  automatically zero. This means that we need to discuss more efficient storage
  strategies later. Notice also that we are looping over all
  indices $i,j,a,b$, rather than the restricted indices. This means that we
  are doing redundant work. The reason for presenting the equations this way is merely pedagogical. When developing a program, we would recommend to write a code which is as close as possible to the mathematical expressions. The first version of our code will then often be slow. However It is  often less error-prone and simpler to code in this way. 
Below we will however unrestrict these indices in order to achieve a better speed up of our code. 

   The goal of our code is to calculate the correlation energy,
   $\Delta E_{CCD}$, meaning that after each iteration of our equations, we use
   our newest $t$ amplitudes to update the correlation energy
  \begin{equation}
  \Delta E_{CCD}^{(n)} = \frac{1}{4} \sum_{ijab}
  \braket{ij|\hat{v}|ab}t^{ab}_{ij}{}^{(n)}.
  \end{equation}
  We check that our result is converged by testing whether the
  most recent iteration has changed the correlation energy by less
  than some tolerance threshold $\eta$,
  \begin{equation}
  \eta > | \Delta E_{CCD}^{(n+1)} - \Delta E_{CCD}^{(n)} |.
  \end{equation}
  The basic structure of the iterative process will look like
\begin{svgraybox}
  \begin{algorithmic}
    \While {(abs(energy\_Diff) $>$ tolerance)} \State CCD\_Update()
    \State correlation\_Energy $\gets$ CCD\_Corr\_Energy() \State
    energy\_Diff $\gets$ correlation\_Energy -
    correlation\_Energy\_old \State correlation\_Energy\_old $\gets$
    correlation\_Energy \State t\_amplitudes\_old $\gets$
    t\_amplitudes \EndWhile
  \end{algorithmic}
\end{svgraybox}
  Prior to this algorithm, the $t$ amplitudes should be initalized,
  $t_{ij}^{ab}{}^{(0)}$. A particularly convenient choice, as discussed above, is to set
  $t_{ij}^{ab}{}^{(0)} = 0$. Notice that if this starting point is
  used, then
  \begin{equation}
  t_{ij}^{ab}{}^{(1)} = \frac{\langle ab \vert \hat{v} \vert ij\rangle}{\epsilon^{ab}_{ij}},
  \label{eq:ccdGuess}
  \end{equation}
resulting in the correlation energy
  \begin{equation}
  \Delta E_{CCD}^{(1)} = \frac{1}{4} \sum_{ijab}\frac{\langle ij \vert \hat{v} \vert ab \rangle\langle ab \vert \hat{v} \vert ij \rangle}{\epsilon^{ab}_{ij}},
  \end{equation}
  which is the result from many-body perturbation theory to second order (MBPT2).  This is a very useful result, as one iteration
  of the CCD equations can be ran, and checked against MBPT2 to give
  some confidence that everything is working correctly. To check that
  everything is working, it is useful to run the code using a minimal
  example. We turn then our attention to the simple pairing model Hamiltonian of problem \ref{problem:pairingmodel},
  \begin{equation}
  \hat{H}_0 = \xi \sum_{p \sigma} (p-1) a^{\dagger}_{p \sigma} a_{p
    \sigma}\label{eq:sppairing}
  \end{equation}
  \begin{equation}
  \hat{V} = -\frac{1}{2}g \sum_{pq} a^{\dagger}_{p+}a^{\dagger}_{p-}
  a_{q-}a_{q+}\label{eq:intpairing}
  \end{equation}
  which represents a basic pairing model with $p$ levels, each having a
  spin degeneracy of 2. The form of the coupled cluster equations 
  uses single-particle states that are eigenstates of the
  Hartree-Fock operator, $\left(\hat{u}+\hat{u}_{\text{HF}}\right)\vert
  p\rangle=\epsilon_{p}\vert p\rangle$. In the pairing model, this
  condition is already fulfilled. All we have to do is define the
  lowest $N_{\mathrm{Fermi}}$ states as holes and  redefine the single-particle
  energies,
  \begin{equation}\label{eq:pairingsp}
  \epsilon_q = h_{qq} + \sum_{i} \braket{qi|\hat{v}|qi}.
  \end{equation}
  To be more specific, let us look at the pairing model with four
  particles and eight single-particle states. These states (with $\xi =1.0$) could be labeled as shown in 
Table \ref{tab:pairingmodelsp}.
\begin{table}
\caption{Single-particle states and their quantum numbers and their energies from Eq.~(\ref{eq:pairingsp}). The degeneracy for every quantum number $p$ is equal to 2 due to the two possible spin values.} \label{tab:pairingmodelsp}
  \begin{center}
      \begin{tabular}{| l | l | l | l | l |}
      \hline State Label & p & 2s$_z$ & E & type\\ \hline 0 & 1 & 1 &
      -g/2 & hole \\ \hline 1 & 1 & -1 & -g/2 & hole \\ \hline 2 & 2 &
      1 & 1-g/2 & hole \\ \hline 3 & 2 & -1 & 1-g/2 & hole \\ \hline 4
      & 3 & 1 & 2 & particle \\ \hline 5 & 3 & -1 & 2 & particle
      \\ \hline 6 & 4 & 1 & 3 & particle \\ \hline 7 & 4 & -1 & 3 &
      particle \\ \hline
      \end{tabular}
  \end{center}
\end{table}
The Hamiltonian matrix for this   four-particle problem with no broken pairs is defined by six possible Slater determinants,
one representing the ground state and zero-particle-zero-hole excitations $0p-0h$, four representing various $2p-2h$ excitations and finally one representing a $4p-4h$ excitation. Problem \ref{problem:pairingmodel} gives us for this specific problem
  \[
  H = \begin{bmatrix}
  2\delta -g & -g/2 & -g/2 & -g/2 & -g/2 & 0 \\ -g/2 & 4\delta -g &
  -g/2 & -g/2 & -0 & -g/2 \\ -g/2 & -g/2 & 6\delta -g & 0 & -g/2 &
  -g/2 \\ -g/2 & -g/2 & 0 & 6\delta-g & -g/2 & -g/2 \\ -g/2 & 0 & -g/2
  & -g/2 & 8\delta-g & -g/2 \\ 0 & -g/2 & -g/2 & -g/2 & -g/2 &
  10\delta -g
  \end{bmatrix}
  \]
  The following python program diagonalizes the above Hamiltonian
  matrix for a given span of interaction strength values, performing
  a full configuration interaction calculation. It plots the correlation energy, that is the difference between the ground state energy and the reference energy. Furthermore, for the pairing model we have added results from perturbation theory to second order (MBPT2)
and third order in the interaction MBPT3. Second order perturbation theory includes diagram (2) of Fig.~\ref{fig:goldstone}
while MBPT3 includes diagrams (3), (4), (5), (8) and (9) as well. Note that diagram (3) is zero for the pairing model and that diagrams (8) and (9) contribute as well with a canonical Hartree-Fock basis. 
  In the case of the simple pairing model it is easy to calculate
  $\Delta E_{MBPT2}$ anyltically. This is a very useful  check of our codes since this analytical expression  can  also be used to check our first CCD iteration.
We restate this expression here but restrict the sums over single-particle states
  \[
  \Delta E_{MBPT2} = \frac{1}{4} \sum_{abij} \frac{\braket{ij|\hat{v}|ab}
    \braket{ab|\hat{v}|ij}}{ \epsilon_{ij}^{ab}} = \sum_{a<b,i<j}
  \frac{\braket{ij|\hat{v}|ab} \braket{ab|\hat{v}|ij}}{ \epsilon_{ij}^{ab}}
  \]
  For our pairing example we obtain the following result
  \[
  \Delta E_{MBPT2} = \frac{\braket{01|\hat{v}|45}^2}{\epsilon_{01}^{45}} +
  \frac{\braket{01|\hat{v}|67}^2}{\epsilon_{01}^{67}} +
  \frac{\braket{23|\hat{v}|45}^2}{\epsilon_{23}^{45}} +
  \frac{\braket{23|\hat{v}|67}^2}{\epsilon_{23}^{67}},
  \]
which translates into
  \[
  \Delta E_{MBPT2} = -\frac{g^2}{4} \bigg( \frac{1}{ 4 + g} +
  \frac{1}{ 6 + g} + \frac{1}{ 2 + g} + \frac{1}{ 4 + g} \bigg).
  \]
 This expression can be used to check the results
  for any value of $g$ and provides thereby an important test of  our codes.
See \url{https://github.com/ManyBodyPhysics/LectureNotesPhysics/blob/master/doc/src/Chapter8-programs/python/mbpt.py} for the Python code shown here.
\begin{lstlisting}
#!/usr/bin/python
from sympy import *
from pylab import *
import matplotlib.pyplot as plt

below_fermi = (0,1,2,3)
above_fermi = (4,5,6,7)
states = [(1,1),(1,-1),(2,1),(2,-1),(3,1),(3,-1),(4,1),(4,-1)]
N = 8
g = Symbol('g')

def h0(p,q):
    if p == q:
        p1, s1 = states[p]
        return (p1 - 1)
    else:
        return 0

def f(p,q):
    if p == q:
        return 0
    s = h0(p,q)
    for i in below_fermi:
        s += assym(p,i,q,i)
        return s


def assym(p,q,r,s):
    p1, s1 = states[p]
    p2, s2 = states[q]
    p3, s3 = states[r]
    p4, s4 = states[s]

    if p1 != p2 or p3 != p4:
        return 0
    if s1 == s2 or s3 == s4:
        return 0
    if s1 == s3 and s2 == s4:
        return -g/2.
    if s1 == s4 and s2 == s3:
        return g/2.

def eps(holes, particles):
    E = 0
    for h in holes:
        p, s = states[h]
        E += (p-1)
    for p in particles:
        p, s = states[p]
        E -= (p-1)
    return E


# Diagram 1
s1 = 0
for a in above_fermi:
    for b in above_fermi:
        for i in below_fermi:
            for j in below_fermi:
                s1 += 0.25*assym(a,b,i,j)*assym(i,j,a,b)/eps((i,j),(a,b))


# Diagram 3
s3 = 0
for a in above_fermi:
   for b in above_fermi:
       for c in above_fermi:
           for i in below_fermi:
               for j in below_fermi:
                   for k in below_fermi:
                       s3 += assym(i,j,a,b)*assym(a,c,j,k)*assym(b,k,c,i)
                             /eps((i,j),(a,b))/eps((k,j),(a,c))

# Diagram 4
s4 = 0
for a in above_fermi:
    for b in above_fermi:
        for c in above_fermi:
            for d in above_fermi:
                for i in below_fermi:
                    for j in below_fermi:
                        s4 += 0.125*assym(i,j,a,b)*assym(a,b,c,d)*assym(c,d,i,j)
                               /eps((i,j),(a,b))/eps((i,j),(c,d))

# Diagram 5
s5 = 0
for a in above_fermi:
    for b in above_fermi:
        for i in below_fermi:
            for j in below_fermi:
                for k in below_fermi:
                    for l in below_fermi:
                        s5 += 0.125*assym(i,j,a,b)*assym(k,l,i,j)*assym(a,b,k,l)
                              /eps((i,j),(a,b))/eps((k,l),(a,b))

# Diagram 8 
s8 = 0
for a in above_fermi:
    for b in above_fermi:
        for i in below_fermi:
            for j in below_fermi:
                for k in below_fermi:
                    s8 -= 0.5*assym(i,j,a,b)*assym(a,b,i,k)*f(k,j)
                            /eps((i,j),(a,b))/eps((i,k),(a,b))

# Diagram 9 
s9 = 0
for a in above_fermi:
    for b in above_fermi:
        for c in above_fermi:
            for i in below_fermi:
                for j in below_fermi:
                    s9 += 0.5*assym(i,j,a,b)*assym(a,c,i,j)*f(b,c)
                        /eps((i,j),(a,b))/eps((i,j),(a,c))

ga = linspace(-1,1,20)
e1 = []
corr2 = []
corr3 = []

for g_val in ga:
    H1 = matrix([[2-g_val , -g_val/2.,  -g_val/2., -g_val/2., -g_val/2.,     0],
                         [-g_val/2.,   4-g_val,  -g_val/2., -g_val/2.,    0., -g_val/2.],
                         [-g_val/2., -g_val/2.,    6-g_val,     0, -g_val/2., -g_val/2.],
                 [-g_val/2., -g_val/2.,      0,   6-g_val, -g_val/2., -g_val/2.],
                 [-g_val/2.,     0,  -g_val/2., -g_val/2.,   8-g_val, -g_val/2.],
                 [0    , -g_val/2.,  -g_val/2., -g_val/2., -g_val/2.,  10-g_val]])

    u1, v1 = linalg.eig(H1)
    e1.append(min(u1))
    corr2.append((s1).subs(g,g_val))
    corr3.append((s1+s3+s4+s5).subs(g,g_val))

exact = e1 - (2-ga)

plt.axis([-1,1,-0.5,0.05])
plt.xlabel(r'Interaction strength, $g$', fontsize=16)
plt.ylabel(r'Correlation energy', fontsize=16)
exact = plt.plot(ga, exact,'b-*',linewidth = 2.0, label = 'Exact')
mbpt2 = plt.plot(ga, corr2,'r:.', linewidth = 2.0, label = 'MBPT2')
mbpt3 = plt.plot(ga, corr3, 'm:v',linewidth = 2.0, label = 'MBPT3')
plt.legend()
plt.savefig('perturbationtheory.pdf', format='pdf')
plt.show()
\end{lstlisting}
Figure \ref{fig:diagpairing} shows the resulting correlation energies for the exact case, MBPT2 and MBPT3.
  \begin{figure}
    \includegraphics[width=\linewidth]{Chapter8-figures/perturbationtheory.pdf}
    \caption{Correlation energy for the pairing model with exact diagonalization, MBPT2 and perturbation theory to third order MBPT3 for a range of interaction values.}
    \label{fig:diagpairing}
  \end{figure}
We note from the above program that we have coded the expressions for the various diagrams
following strictly the mathematical expressions of for example Eqs.~(\ref{eq:diag3})-(\ref{eq:diag5}).
This means that for every diagram we loop explicitely  over every single-particle state. As we will
  see later, this is extremely inefficient from a computational point
  of view. In our discussions below, we will rewrite
  the computations of most diagrams in terms of efficient
  matrix-matrix multiplications or matrix-vector multiplications.  
  Figure \ref{fig:diagpairing} shows us that the approximation to both
  second and third order are very good when the interaction strength
  is small and contained in the interval $g\in[-0.5,0.5]$, but as the
  interaction gets stronger in absolute value the agreement  with the exact reference energy for  MBPT2 and MBPT3 worsens. We also note
  that the third-order result is actually worse than the second order
  result for larger values of the interaction strength, indicating
  that there is no guarantee that higher orders in many-body
  perturbation theory may reduce the relative error in a systematic
  way.  Adding fourth order contributions as shown in Fig.~\ref{fig:pairingccmbpt4}
  for negative interaction strengths gives a
  better result than second and third order, while for $g>0$ the
  relative error is worse.  The fourth order contributions (not shown in the above figure) include also four-particle-four-hole correaltions.
However, the disagreement for stronger interaction values hints at  the possibility that many-body perturbation theory may not converge order by order.  Perturbative studies of nuclear systems may thus be questionable, unless selected contributions that soften the interactions are properly softened.   
 We note also the non-variational character
  of many-body perturbation theory, with results at different levels of many-body perturbation theory either
  overshooting or undershooting the true ground state correlation energy. 
The coupled cluster results are included in Fig.~\ref{fig:pairingccmbpt4} where we display the difference between the exact correlation energy and the correlation energy obtained with many-body perturbation theory to fourth order.  The MBPT4 results show a better agreement with experiment, but here as well for larger positive values of the interaction, we see clear signs of deviations. 
  \begin{figure}
    \includegraphics[width=\linewidth]{Chapter8-figures/CCDMBPT4theory.pdf}
    \caption{Correlation energy for the pairing model with exact diagonalization, CCD and perturbation theory to fourth order (MBPT4) for a range of interaction values.}
    \label{fig:pairingccmbpt4}
  \end{figure}
In Table \ref{tab:selectedbenchmarks} we list for the sake of completeness also our coupled cluster results at the CCD level for the same system.
\begin{table}
\caption{Coupled cluster and MBPT2 results for the simple pairing model with eight single-particle levels and four spin $1/2$ fermions
for different values of the interaction strength $g$.} \label{tab:selectedbenchmarks}
  \begin{center}
      \begin{tabular}{| l | l | l | l |}
      \hline g & E$_{ref}$ & $\Delta E_{MBPT2}$ & $\Delta E_{CCD}$
      \\ \hline -1.0 & 3 & -0.46667 & -0.21895* \\ \hline -0.5 & 2.5 &
      -0.08874 & -0.06306 \\ \hline 0.0 & 2 & 0 & 0 \\ \hline 0.5 &
      1.5 & -0.06239 & -0.08336 \\ \hline 1.0 & 1 & -0.21905 &
      -0.36956 \\ \hline
      \end{tabular}
  \end{center}
\end{table}
  The $g=-1.0$ case diverges without implementing iterative
  mixing. Sometimes iterative solvers run into oscillating solutions,
  and mixing can help the iterations break this cycle.
  \begin{equation}
  t^{(i)} = \alpha t^{(i)}_{no\_mixing} + (1 - \alpha) t^{(i-1)}
  \end{equation}




  Once a working pairing model has been implemented, improvements can
  start to be made, all the while using the pairing model to make sure
  that the code is still working and giving correct answers. Realistic
  systems will be much larger than this small pairing example.

  One limitation that will be ran into while trying to do realistic
  CCD calculations is that of memory. The four-indexed two-body matrix elements (TBMEs) and
  $t$-amplitudes have to store a lot of elements, and the size of these
  arrays can quickly exceed the available memory on
  a machine. If a calculation wants to use 500 single-particle basis states, then
  a structure like $\braket{pq|v|rs}$ will need a  length of 500 for each of
  its four indices, which means it will have $500^4 = 625\times 10^8$
  elements. To get a handle on how much memory is used, consider the
  elements as double-precision floating point type. One double takes
  up 8 bytes of memory. This specific array would take up $8\times 625\times 10^8$ bytes
  = $5000 \times 10^8$ bytes = $500$ Gbytes of memory. Most personal
  computers in 2016 have 4-8 Gbytes of RAM, meaning that this calculation would
  be way out of reach. There are supercomputers that can handle
  applications using 500 Gbytes of memory, but we can quickly reduce
  the total memory required by applying some physical arguments. In
  addition to vanishing elements with repeated indices, mentioned
  above, elements that do not obey certain symmetries are also
  zero. Almost all realistic two-body forces preserve some quantities
  due to symmetries in the interaction. For example, an interaction
  with rotational symmetry will conserve angular momentum. This means
  that a two-body ket state $\ket{rs}$, which has some set of quantum
  numbers, will retain quantum numbers corresponding to the
  interaction symmetries after being acted on by $\hat{v}$. This state
  is then projected onto $\ket{pq}$ with its own set of quantum
  numbers. Thus $\braket{pq|v|rs}$ is only non-zero if $\ket{pq}$ and
  $\ket{rs}$ share the same quantum numbers that are preserved by
  $\hat{v}$. In addition, because the cluster operators represent
  excitations due to the interaction, $t_{ij}^{ab}$ is only non-zero
  if $\ket{ij}$ has the same relevant quantum numbers as $\ket{ab}$.

  To take advantage of this, these two-body ket states can be
  organized into ``channels'' of shared quantum numbers. In the case
  of the pairing model, the interaction preserves the total spin
  projection of a two-body state, $S_{z}=s_{z1}+s_{z2}$. The single
  particle states can have spin of +1/2 or -1/2, so there can be three
  two-body channels with $S_{z}=-1,0,+1$. These channels can then be
  indexed with a unique label in a similar way to the single particle
  index scheme. In more complicated systems, there will be many more
  channels involving multiple symmetries, so it is useful to create a
  data structure that stores the relevant two-body quantum numbers to
  keep track of the labeling scheme.

  It is more efficient to use two-dimensional array data
  structures, where the first index refers to the channel number and
  the second refers to the element within that channel. So to access
  matrix elements or $t$ amplitudes, you can loop over the channels
  first, then the indices within that channel. To get an idea of the
  savings using this block diagonal structure, let's look at a case
  with a plane wave basis, with three momentum and one spin quantum
  numbers, with an interaction that conserves linear momentum in all
  three dimensions, as well as the total spin projection. Using 502
  basis states, the TBME's require about 0.23 Gb of memory in block
  diagonal form, which is an enormous saving from the 500 Gb mentioned
  earlier in the na\"ive storage scheme.


  Since the calculation of all  zeros can now be avoided,
  improvements in speed and memory will now follow. To get a handle on
  how these CCD calculations are implemented we need only to look at the
  most expensive sum in equation \ref{eq:ccd2}. This corresponds to
  the sum over $klcd$. Since this sum is repeated for all $i < j$ and
  $a < b$, it means that these equations will scale as
  $\mathcal{O}(n_{p}^{4} n_{h}^{4})$. However,
  they can be rewritten using intermediates as

  \begin{align}
  0 = \braket{ab|\hat{v}|ij} + \hat{P}(ab) \sum_{c} \braket{b| \chi
    |c} \braket{ac| t |ij} - \hat{P}(ij) \sum_{k} \braket{k| \chi |j}
  \braket{ab| t |ik} & \nonumber \\ + \frac{1}{2}\sum_{cd} \braket{ab|
    \chi |cd} \braket{cd| t |ij} + \frac{1}{2} \sum_{kl} \braket{ab| t
    |kl} \braket{kl| \chi |ij} \\ + \hat{P}(ij)\hat{P}(ab) \sum_{kc}
  \braket{ac| t |ik}\braket{kb| \chi |cj} & \nonumber
  \end{align}
  for all $i,j,a,b$, the reason why these indices are now unrestricted
  will be explained later. The intermediates $\chi$ are defined as
  \begin{equation}
  \braket{b| \chi |c} = \braket{b|f|c} - \frac{1}{2} \sum_{kld}
  \braket{bd|t|kl} \braket{kl|v|cd}
  \end{equation}
  \begin{equation}
  \braket{k| \chi |j} = \braket{k|f|j} + \frac{1}{2} \sum_{cdl}
  \braket{kl|v|cd} \braket{cd|t|jl}
  \end{equation}
  \begin{equation}
  \braket{kl| \chi |ij} = \braket{kl|v|ij} + \frac{1}{2} \sum_{cd}
  \braket{kl|v|cd} \braket{cd|t|ij}
  \label{eq:mtxEx}
  \end{equation}
  \begin{equation}
  \braket{kb| \chi |cj} = \braket{kb|v|cj} + \frac{1}{2} \sum_{dl}
  \braket{kl|v|cd} \braket{db|t|lj}
  \end{equation}
  \begin{equation}
  \braket{ab| \chi |cd} = \braket{ab|v|cd}
  \end{equation}


  With the introduction of the above intermediates, the CCD equations scale now as $\mathcal{O}(n_{h}^{2}
  n_{p}^{4})$, which is an important improvement. This is of
  course at the cost of computing the intermediates at the beginning
  of each iteration, where the most expensive one, $\braket{kb| \chi |cj}$ scales as $\mathcal{O}(n_{h}^{3} n_{p}^{3})$. To
  further speed up these computations, we see that these sums can be
  written in terms of  matrix-matrix multiplications. It is not obvious how to
  write all of these sums in such a way, but it is useful to first
  recall that the expression for the multiplication of two matrices $\hat{C} =
  \hat{A}\times \hat{B}$ can be written as
  \begin{equation}
  C_{ij} = \sum_{k} A_{ik} \times B_{kj}.
  \end{equation}
  We obeserve then  that equation (\ref{eq:mtxEx}) can be written as
  \[
  \braket{K| \chi |I} = \braket{K|v|I} + \frac{1}{2} \sum_{C}
  \braket{K|v|C} \braket{C|t|I}
  \]
  by mapping the two index pairs $kl \to K, ij \to I, cd \to C$. The sum looks now 
like a matrix-matrix multiplication. This is
  useful because there are packages like BLAS (Basic Linear Algebra
  Subprograms) \cite{blas} which have extremely fast implementations of
  matrix-matrix multiplication.
  The simplest example to consider is the expression for the correlation energy from MBPT2. We rewrite 
  \begin{equation}\label{eq:bruteforceMBPT}
  \Delta E_{MBPT2} = \frac{1}{4}\sum_{abij} \frac{\braket{ij|\hat{v}|ab}\braket{ab|\hat{v}|ij}}{ \epsilon_{ij}^{ab}},
\end{equation}
by defining the matrices $\hat{A}$ and $\hat{B}$ with new indices $I=(ij)$ and $A=(ab)$. The individual matrix elements of these matrices are 
\[
A_{IA} = \langle I \vert \hat{v} \vert A \rangle,
\]
and 
\[
B_{AI} = \frac{\langle A \vert \hat{v} \vert I \rangle}{\epsilon^A_I}.
\]
We can then rewrite the correlation energy from MBPT2 as
\begin{equation}\label{eq:smartMBPT}
  \Delta E_{MBPT2} = \frac{1}{4}\hat{A}\times \hat{B}.
\end{equation}
Figure \ref{fig:speedup1} shows the difference between the brute force summation over single-particle states
of Eq.~(\ref{eq:bruteforceMBPT}) and the smarter matrix-matrix multiplication of Eq.~(\ref{eq:smartMBPT}) for a given number  of basis states.
In these calculations we have only considered pure neutron matter with $N=14$ neutrons and a density $n=0.08$ fm$^{-3}$ and plane wave single-particle states with periodic boundary conditions, allowing for up to 
$1600$ single-particle basis states. The Minnesota interaction model has been used in these calculations.  
\begin{figure}
    \includegraphics[width=\linewidth]{Chapter8-figures/blockvsfull_log.png}
    \caption{MBPT2 contribution to the correlation for pure neutron matter with $N=14$ neutrons and periodic boundary conditions. Up to approximately 1600 single-particle states have been included in the sums over intermediate states in Eqs.~(\ref{eq:bruteforceMBPT}) and (\ref{eq:smartMBPT})}. 
    \label{fig:speedup1}
  \end{figure}
With $40$ single-particle shells, see Table \ref{tab:table1} for example, we have in total  $2713$ single-particle states. 
Using the matrix-matrix algorithm the final calculation time is $2.4$ s (this is the average time from ten numerical experiments).
The total time using the brute force is $100.6$ s (again the average of ten numerical experiments), resulting in a speed up of 42. It is useful to dissect the final time in terms of different operations.
For the matrix-matrix multiplication most of the time is spent setting up the matrix elements for the two-body channels and to load the matrix elements. The final matrix-matrix multiplication takes only $1\%$ of the total time. For the brute force algorithm, the multiplication and summation over the various single-particle states takes almost half of the total time. In our discussion on high-performance computing below, we will discuss in more detail the program used to obtain these results.



With the definition of the intermediates and appropriate matrix-matrix multiplications and  a working CCD program, we can move on to more
  realistic cases. One such case is infinite nuclear matter using a
  plane-wave basis. These states are solutions to the free-particle
  Hamiltonian,
  \begin{equation}
  \frac{-\hbar^2}{2m}\nabla^2\mathop{\phi(\vec{x})}=\epsilon\mathop{\phi(\vec{x})}.
  \end{equation}
  For a finite basis, we approximate the problem by constructing a box
  with sides of length $L$, which quantizes the momentum, and impose
  periodic boundary conditions in each direction.
  \begin{align}
  \mathop{\phi(x_{i})}=\mathop{\phi(x_{i}+L)}
  \\ \mathop{\phi_{\vec{k}}(\vec{x})}=\frac{1}{\sqrt{L^{3}}}e^{i\vec{k}\cdot\vec{x}},\hspace{0.5cm}\vec{k}=\frac{2\pi\vec{n}}{L},\hspace{0.5cm}n_{i}
  \end{align}

  The first step in calculating infinite matter is to construct a
  model space by finding every single-particle state relevant to a
  given problem. In our case, this amounts to looping over the quantum
  numbers for spin, isospin, and the three momentum directions. To
  control the model space size, the momentum can be truncated to give
  a cubic space, where $n_{i}\leq n_{\text{max}}$, or a spherical
  space, where $n_{x}^{2}+n_{y}^{2}+n_{z}^{2}\leq N_{\text{max}}$. The
  number of single-particle states in a cubic space increases rapidly
  with $n_{\text{max}}$ compared to the spherical case with
  $N_{\text{max}}$. For example, in pure neutron matter a cubic space
  with $n_{\text{max}}=3$ has $668$ states while the spherical space
  with $N_{\text{max}}=17$ has $610$ states. Therefore, the spherical
  case will be used for the rest of the calculations here. The loop
  increases in energy by counting the number of shells, so states can
  be 'filled' by labeling the first $P$ proton and $N$ neutron states
  as holes. The following loop is for pure neutron matter and requires
  the number of neutrons, $N$ and density, $\rho=N/L^{3}$, as
  input. Symmetric nuclear matter requires an extra loop over isospin.
\begin{svgraybox}
  \begin{algorithmic}
    \State $n=0$ \For{$\text{shell}\in\{ 0,...,N_{\text{max}}\}$}
    \For{$-\sqrt{N_{\text{max}}}\leq n_{x}\leq\sqrt{N_{\text{max}}}$}
    \For{$-\sqrt{N_{\text{max}}}\leq n_{y}\leq\sqrt{N_{\text{max}}}$}
    \For{$-\sqrt{N_{\text{max}}}\leq n_{z}\leq\sqrt{N_{\text{max}}}$}
    \For{$s_{z}\in\{-\frac{1}{2},\frac{1}{2}\}$}
    \If{$n_{x}^{2}+n_{y}^{2}+n_{z}^{2}=\text{shell}$} \State
    $\text{Energy}=\frac{4\pi^{2}\hbar^{2}}{2m}\times\text{shell}$
    \If{$n<N$} \State $\text{type}=\text{``hole''}$ \Else \State
    $\text{type}=\text{``particle''}$ \EndIf \State STATES $\gets$
    ($n$, $n_{x}$, $n_{y}$, $n_{z}$, $s_{z}$, Energy, type) \State
    $n\gets n+1$ \EndIf \EndFor \EndFor \EndFor \EndFor \EndFor
  \end{algorithmic}
\end{svgraybox}
  The next step is to build every two-body state in the model space
  and separate them by their particle/hole character and combined
  quantum numbers. While each single-particle state is unique,
  two-body states can share quantum numbers with other members of a
  particular two-body channel. These channels allow us to remove
  matrix elements and cluster amplitudes that violate the symmetries
  of the interaction. This reduces greatly the size and speed of the
  calculation. Our structures will depend on direct two-body channels,
  $T$, where the quantum numbers are added, and cross two-body
  channels, $X$, where the quantum numbers are subtracted. Before
  filling the channels, it is helpful to order them with an index
  function which returns a unique index for a given set of two-body
  quantum numbers. Without an index function, one has to loop over all
  the channels for each two-body state, adding a substantial amount
  of time to this algorithm. An example of an index function for the
  direct channels in symmetric nuclear matter is, for
  $N_{x}=n_{x,1}+n_{x,2}$, $N_{y}=n_{y,1}+n_{y,2}$,
  $N_{z}=n_{z,1}+n_{z,2}$, $S_{z}=s_{z,1}+s_{z,2}$,
  $T_{z}=t_{z,1}+t_{z,2}$, $m=2\lfloor\sqrt{N_{\text{max}}}\rfloor$,
  and $M=2m+1$,
  \begin{equation}
  \text{Ind}\left( N_{x},N_{y},N_{z},S_{z},T_{z}\right)=2\left(
  N_{x}+m\right)M^{3}+2\left( N_{y}+m\right)M^{2}+2\left(
  N_{z}+m\right)M+2\left( S_{z}+1\right)+\left(T_{z}+1\right).
  \end{equation}
  This function, which can also be used for the cross-channel index
  function, is well suited for a cubic model space but can be applied
  in either case. An additional restriction for two-body states is
  that they must be composed of two different states to satisfy the
  Pauli-exclusion principle.
\begin{svgraybox}
  \begin{algorithmic}
    \For{$\text{sp1}\in STATES$} \For{$\text{sp2}\in STATES$}
    \If{$sp1\neq sp2$} \State $N_{i}\gets n_{i,1}+n_{i,2}$ \State
    $S_{z}\gets s_{z,1}+s_{z,2}$ \State $T_{z}\gets t_{z,1}+t_{z,2}$
    \State
    $\text{i\_dir}\gets\text{Ind}\left(N_{x},N_{y},N_{z},S_{z},T_{z}\right)$
    \State $T\gets$ (sp1, sp2, i\_dir) \State $N'_{i}\gets
    n_{i,1}-n_{i,2}$ \State $S'_{z}\gets s_{z,1}-s_{z,2}$ \State
    $T'_{z}\gets t_{z,1}-t_{z,2}$ \State
    $\text{i\_cross}\gets\text{Ind}\left(N'_{x},N'_{y},N'_{z},S'_{z},T'_{z}\right)$
    \State $X\gets$ (sp1, sp2, i\_cross) \EndIf \EndFor \EndFor
  \end{algorithmic}
\end{svgraybox}
  From the cross channels, one can construct the cross channel
  complements, $X'$, where $X\left( pq\right)\equiv X'\left(
  qp\right)$. Also from the direct channels, one can construct
  one-body, and corresponding three-body, channels for each
  single-particle state, $K$ by finding every combination of two
  two-body states within a direct channel that contains that single
  particle state, $T\left( pq\right)=T\left( rs\right)\Rightarrow
  K_{p}\gets\left( qrs\right)$.
\begin{svgraybox}
  \begin{algorithmic}
    \For{$\text{Chan}\in T$} \For{$\text{tb1}\in\text{Chan}$}
    \For{$\text{tb2}\in\text{Chan}$} \State $K\gets\text{tb1}_{1}$
    \State
    $K_{\text{tb1}_{1}}\gets\mathop{\text{tb1}_{2},\text{tb2}_{1},\text{tb2}_{2}}$
    \EndFor \EndFor \EndFor
  \end{algorithmic}
\end{svgraybox}
  These different structures can be further categorized by a two-body
  state's particle-hole character, $\braket{pp| t |hh}, \braket{hh| v
    |hh}, \braket{pp| v |pp}, \braket{hh| v |pp}$, and $\braket{hp| v
    |hp}$, which greatly simplifies the matrix-matrix multiplications
  of the CCD iterations by indexing the summed variables in a
  systematic way. Summations are constructed by placing two
  structures next to each other in such a way that the inner summed
  indices are of the same channel. The resulting structure is indexed
  by the outer channels as shown here
  \begin{align}
  \braket{b| \chi |c} = \braket{b|f|c} - \frac{1}{2} \sum_{kld}
  \braket{bd|t|kl} \braket{kl|v|cd} &\rightarrow f_{c}^{b}\left(
  K\left( b\right),K\left( c\right)\right)\\ \nonumber & -
  \frac{1}{2}t_{kl}^{bd}\left( K\left( b\right),K_{b}\left(
  kld\right)\right) v_{cd}^{kl}\left( K_{c}\left(
  kld\right),K\left( c\right)\right) \\ \braket{k| \chi |j} =
  \braket{k|f|j} + \frac{1}{2} \sum_{cdl} \braket{kl|v|cd}
  \braket{cd|t|jl} &\rightarrow f_{j}^{k}\left( K\left(
  k\right),K\left( j\right)\right) \\ \nonumber &+ \frac{1}{2}v_{cd}^{kl}\left(
  K\left( k\right),K_{k}\left( cdl\right)\right)
  t_{jl}^{cd}\left( K_{j}\left( cdl\right),K\left( j\right)\right)
  \\ \braket{kl| \chi |ij} = \braket{kl|v|ij} + \frac{1}{2} \sum_{cd}
  \braket{kl|v|cd} \braket{cd|t|ij} &\rightarrow v_{ij}^{kl}\left(
  T\left( kl\right),T\left( ij\right)\right)\\ \nonumber  &+ 
  \frac{1}{2}v_{cd}^{kl}\left( T\left( kl\right),T\left(
  cd\right)\right) t_{ij}^{cd}\left( T\left( cd\right),T\left(
  ij\right)\right) \\ \braket{kb| \chi |cj} = \braket{kb|v|cj} +
  \frac{1}{2} \sum_{dl} \braket{kl|v|cd} \braket{db|t|lj} &\rightarrow
  v_{cj}^{kb}\left( X\left( kc\right),X\left( jb\right)\right)\\ \nonumber  &+
  \frac{1}{2}v_{cd}^{kl}\left( X\left( kc\right),X\left(
  dl\right)\right) t_{lj}^{db}\left( X\left( dl\right),X\left(
  jb\right)\right) \\ \braket{ab| \chi |cd} = \braket{ab|v|cd}
  &\rightarrow v_{cd}^{ab}\left( T\left( ab\right),T\left(
  cd\right)\right) \\ \sum_{c} \braket{b| \chi |c} \braket{ac| t |ij}
  &\rightarrow \chi_{c}^{b}\left( K\left( b\right),K\left(
  c\right)\right)\cdot t_{ij}^{ac}\left( K\left( c\right), K_{c}\left(
  ija\right)\right) \\ \sum_{k} \braket{k| \chi |j} \braket{ab| t |ik}
  &\rightarrow \chi_{j}^{k}\left( K\left( j\right),K\left(
  k\right)\right)\cdot t_{ik}^{ab}\left( K\left( c\right), K_{c}\left(
  ija\right)\right) \\ \sum_{cd} \braket{ab| \chi |cd} \braket{cd| t
    |ij} &\rightarrow \chi_{cd}^{ab}\left( T\left( ab\right),T\left(
  cd\right)\right)\cdot t_{ij}^{cd}\left( T\left( cd\right),T\left(
  ij\right)\right) \\ \sum_{kl} \braket{ab| t |kl} \braket{kl| \chi
    |ij} &\rightarrow t_{kl}^{ab}\left( T\left( ab\right),T\left(
  kl\right)\right)\cdot \chi_{ij}^{kl}\left( T\left( kl\right),T\left(
  ij\right)\right) \\ \sum_{kc} \braket{ac| t |ik}\braket{kb| \chi
    |cj} = \sum_{kc} \braket{ai^{-1}| t |kc^{-1}}\braket{kc^{-1}| \chi
    |jb^{-1}} &\rightarrow t_{ik}^{ac}\left( X\left( ia\right),X\left(
  kc\right)\right)\cdot \chi_{cj}^{kb}\left( X\left( kc\right),X\left(
  jb\right)\right)
  \end{align}
Figure \ref{fig:fig1} displays the convergence of the energy per particle for pure neutron matter as function of number particles 
for  the CCD approximation with the Minnesota potential for different with $\mathrm{N_{max}=20}$.
  \begin{figure}
    \includegraphics[width=\linewidth]{Chapter8-figures/fig1.pdf}
    \caption{Energy per particle of pure neutron matter computed in
      the CCD approximation with the Minnesota potential for different
      numbers of particles with $\mathrm{N_{max}=20}$.}
    \label{fig:fig1}
  \end{figure}
Similarly, Fig.~{fig:fig2} shows the convergence in terms of different model space sizes $\mathrm{N_{max}=20}$ with 
a fixed number of neutrons $N=114$. 
  \begin{figure}
    \includegraphics[width=\linewidth]{Chapter8-figures/fig2.pdf}
    \caption{Energy per particle of pure neutron matter computed in
      the CCD approximation with the Minnesota potential for different
      model space sizes with $\mathrm{A=114}$.}
    \label{fig:fig2}
  \end{figure}
We see from the last figure that at the CCD level and neutron matter only there is a good convergence with  $\mathrm{N_{max}=25}$.
This results depends however on the type of interaction and many-body approximation. 

In these calculations we
approximated our problem with periodic boundary conditions,
  $\mathop{\phi(x_{i})}=\mathop{\phi(x_{i}+L)}$, but we could have
  chosen anti-periodic boundary conditions,
  $\mathop{\phi(x_{i})}=-\mathop{\phi(x_{i}+L)}$. The difference
  between these two shows how the correlation energy contains
  finite-size effects \cite{finitesize}. One solution to this problem is by integrating
  over solutions between periodic and anti-periodic conditions, known
  as twist-averaging \cite{twistaverage}. First, we multiply the single-particle states by
  a phase for each direction, characterized by a twist-angle,
  $\theta_{i}$.
  \begin{equation}
    \mathop{\phi_{\vec{k}}(\vec{x}+\vec{L})}\rightarrow\mathop{e^{i\vec{\theta}}\phi_{\vec{k}}(\vec{x})}
  \end{equation}
  $\theta_{i}=0$ for PBC and $\theta_{i}=\pi$ for APBC
  \begin{align}
  \vec{k}\rightarrow\vec{k}+\frac{\vec{\theta}}{L}
  \\ \epsilon_{\vec{k}}\rightarrow\epsilon_{\vec{k}}+\frac{\pi}{L}\vec{k}\cdot\vec{\theta}+\frac{\pi^{2}}{L^{2}}
  \end{align}
  Adding these phases changes the single-particle energies, the
  correction of which disappear as $L\rightarrow\infty$, depending on
  $\vec{\theta}$ and thus changes the shell structure so that hole
  states can jump up to particle states and vis a versa. So it's
  necessary to fill hole states separately for each
  $\vec{\theta}$. Integration over some quantitiy is approximated by a
  weighted sum, such as Gauss-Legendre quadrature, over the quantity
  for each set of twist angles. The algorithm becomes then
\begin{svgraybox}
  \begin{algorithmic}
    \State Build mesh points and weights for each direction $i$:
    $\{\theta_{i},w_{i}\}$ \State $E_{\text{twist}}=0$
    \For{$\mathop{(\theta_{x},w_{x})}\in\mathop{\{\theta_{x},w_{x}\}}$}
    \For{$\mathop{(\theta_{y},w_{y})}\in\mathop{\{\theta_{y},w_{y}\}}$}
    \For{$\mathop{(\theta_{z},w_{z})}\in\mathop{\{\theta_{z},w_{z}\}}$}
    \State Build Basis States with $k_{i}\rightarrow
    k_{i}+\frac{\theta_{i}}{L}$ \State Order States by Energy and Fill
    Holes \State Get Result $E$ (T,HF,CCD) \State
    $E_{\text{twist}}=E_{\text{twist}}+\frac{1}{\pi^{3}}w_{x}w_{y}w_{z}E$
    \EndFor \EndFor \EndFor
  \end{algorithmic}
\end{svgraybox}
  This technique gives results which depend much less on the particle
  number, but requires a full calculation for each set of twist
  angles, which can grow very quickly. For example, using 10 twist
  angles in each direction requires 1000 calculations. To see the
  effects of twist averaging, it's easy to calculate the kinetic
  energy per particle and the Hartree-Fock energy per particle, which
  avoids the full CCD calculation. These calculations can be compared
  to the exact values for infinite matter, which are calculated by
  integrating the the relevent values up to the fermi surface
  \begin{align}
    \text{T}_{\text{inf}}=\frac{3\hbar^{2}k_{f}^{2}}{10m}
    \\ \text{HF}_{\text{inf}}=\frac{1}{\mathop{(2\pi)^{6}}}\frac{L^{3}}{2\rho}\int_{0}^{k_{f}}d\vec{k}_{1}\int_{0}^{k_{f}}d\vec{k}_{2}\braket{\vec{k}_{1}\vec{k}_{2}|\hat{v}|\vec{k}_{1}\vec{k}_{2}}
  \end{align}
Figure \ref{fig:fig3} shows the CCD kinetic energy of pure neutron
      matter computed with the Minnesota potential as a function of
      the number of particles for both periodic boundary conditions (PBC)
      and twist-averaged boundary conditions (TABC5). We see clearly that the 
twist-averaged boundary conditions soften the dependence on finite size effects. 
  \begin{figure}
    \includegraphics[width=\linewidth]{Chapter8-figures/fig3.pdf}
    \caption{Finite-size effects in the kinetic energy of pure neutron
      matter computed with the Minnesota potential as a function of
      the number of particles for both periodic boundary conditions (PBC)
      and twist-averaged boundary conditions (TABC5).}
    \label{fig:fig3}
  \end{figure}
Similarly, Fig.~\ref{fig:fig4} displays the corresponding Hartree-Fock energy (the reference energy) 
obtained with Minnesota interaction using both periodic and twist-average boundary conditions.  
  \begin{figure}
    \includegraphics[width=\linewidth]{Chapter8-figures/fig4.pdf}
    \caption{Finite-size effects in the Hartree-Fock energy of pure
      neutron matter computed with the Minnesota potential as a
      function of the number of particles for both periodic boundary (PBC)
      conditions and twist-averaged boundary conditions (TABC5).}
    \label{fig:fig4}
  \end{figure}
The results show again a weaker dependence on finite size effects.

The codes we have developed for obtaining these results, with
benchmarks and selected computations, are discussed in more detail in
the appendix.  The discussions hitherto have focused on the
development of an efficient and flexible many-body code. As discussed
in the appendix, the codes have been structured in a very flexible
way, allowing the user to study and add different physical systems,
spanning from the simple pairing model to quantum dots and infinite
nuclear matter. Structuring the codes in for a example an abstract
system class and a solver class allows an eventual user to study
different physical systems and add new many-body solvers without
having to write a totally new program. The structure of the program
discussed in the appendix of this chapter adhere to this philosophy, and as demonstrated in chapter 11, 
with few additions one can add 
the widely popular similarity renormalization group method. We discuss this in more detail in chapter 11. 

Till now we have limited our discussion to the construction of a
many-body code, including elements like how to structure a code in
terms of functions, how to modularize the code, how to develop classes
(see the appendix) and how to verify and validate our computations
(our checks provided by the simple pairing model and many-body
perturbation theory to second order) against known results.  With the
rewriting of our equations in terms of efficient matrix and vector
operations we have also shown how to make our code more efficient.
Matrix and vector operations can easily be parallelized. Such
algorithmic improvements are necessary in order to be able to study
complicated physical systems.  Our codes can also be easily parallelized in order to run on shared memory architectures using either OpenMP \cite{openmp} and/or MPI/OpenMPI \cite{mpi,openmpi}.
However, we have till now not touched
upon topics like parallelization and an efficient utilization of exisiting and future
high-performance facility and possible improvements and bottlenecks which our codes can face. We end thus this section with a brief discussion
of high-performance computing topics of relevance for wave function based methods. We will focus on many-body perturbation theory to second order and the two algorithms discussed in Eqs.~(\ref{eq:bruteforceMBPT}) and (\ref{eq:smartMBPT}). 


\subsection{High-performance computing and analysis of the MBPT program}
The aim of this subsection is to discuss in more detail how we can make the computations discussed in connection with equations 
Eqs.~(\ref{eq:bruteforceMBPT}) and (\ref{eq:smartMBPT}) more efficient using physical constraints, algorithm improvements, and parallel processing. For pedagocical reasons, we will use the MBPT parts of the program due to their simplicity while still containing the important elements of a larger, more complicated calculation. 
The codes can be found at the github link 
\url{https://github.com/ManyBodyPhysics/LectureNotesPhysics/tree/master/doc/src/Chapter8-programs/cpp/MBPT/src}.
We start by discussing the basic structure of these codes by looking at the MBPT2 functions in MBPTfunctions.cpp.
All of the functions with MBPT2 in their name calculate Eq.~(\ref{eq:bruteforceMBPT}), but each iteration utilizes more techniques to minimize its runtime.

The first function is the most simple way to calculate the sum over $ijab$ with four nested loops. When all hole states are indexed below all particle states, the loops over $ab$ can be restricted above the number of holes while the loops over $ij$ can be restricted under the number of hole states. This function scales as $h^2p^2$, where $h$ is the number of hole states and $p$ is the number of particle states.

\lstset{language=c++}
\begin{lstlisting}
  void MBPT2_0(const Input_Parameters &Parameters, const Model_Space &Space)
  {
    double energy0;
    double energy = 0.0;
    for(int i = 0; i < Space.indhol; ++i){
      for(int j = 0; j < Space.indhol; ++j){
        if(i == j){ continue; }
        for(int a = Space.indhol; a < Space.indtot; ++a){
	  for(int b = Space.indhol; b < Space.indtot; ++b){
	    if(a == b){ continue; }
	    energy0 = V_Minnesota(Space, i, j, a, b);
	    energy0 *= energy0;
	    energy0 /= (Space.qnums[i].energy + Space.qnums[j].energy - Space.qnums[a].energy - Space.qnums[b].energy);
	    energy += energy0;
	  }
        }
      }
    }
    energy *= 0.25;
  }
\end{lstlisting}

The second function improves upon the first by splitting the top loop over $a$ into different processing elements so the inner loops can be computed simultaneously. At this point it's important to think about which variables will only be used on a certain thread and which will be shared. In this case, each thread has a private variable named ``energy0'' and share the ``energy'' variable, which is subject to the specified reduction operation at the end of each parallel section. Naively, this should improve the calculation time by a factor equal to the number of processing threads, which in the case of these calculations is four. However, there is some overhead processing that occurs to split and recombine the threads which slows the overall time. In addition, because each team of threads can only proceed when the slowest member finishes, there is overhead in unbalanced threads and in optimizing their order. Fortunately, the nested loops over $bij$ are all equivalent, so each thread is balanced and declaring ``schedule(static)'' tells the thread scheduler not to spend time optimizing them.

\begin{lstlisting}
  void MBPT2_1(const Input_Parameters &Parameters, const Model_Space &Space)
  {
    double energy = 0.0;
    double energy0;
    #pragma omp parallel private(energy0)
    {
      #pragma omp for schedule(static) reduction(+:energy)
      for(int i = 0; i < Space.indhol; ++i){
        for(int j = 0; j < Space.indhol; ++j){
	  if(i == j){ continue; }
	  for(int a = Space.indhol; a < Space.indtot; ++a){
	    for(int b = Space.indhol; b < Space.indtot; ++b){
	      if(a == b){ continue; }
	      energy0 = V_Minnesota(Space, i, j, a, b);
	      energy0 *= energy0;
	      energy0 /= (Space.qnums[i].energy + Space.qnums[j].energy - Space.qnums[a].energy - Space.qnums[b].energy);
	      energy += energy0;
	    }
	  }
        }
      }
    }
    energy *= 0.25;
  }
\end{lstlisting}

The rest of the functions begin by exploiting the symmetries of the interaction to split the single-particle states into channels. This essentially removes all of the zeros that break the symmetry. The function that sets up these channels uses an index function that maps the summed quantum numbers of two states onto a unique channel index. Then, because the MBPT term uses only pairs of holes and pairs of particles, the function constructs lists of these indicies, ``hhvec'' and ``ppvec''. Now, instead of four nested loops over all holes and particles, the sum is obtained by looping over hhvec and ppvec inside each channel.

\begin{lstlisting}
  void MBPT2_2(const Input_Parameters &Parameters, const Model_Space &Space, const Channels &Chan)
  {
    double energy = 0.0;
    double energy0;
    int nhh, npp, i, j, a, b;
    for(int chan = 0; chan < Chan.size; ++chan){
      nhh = Chan.nhh[chan];
      npp = Chan.npp[chan];
      if(nhh*npp == 0){ continue; }
      
      for(int hh = 0; hh < nhh; ++hh){
        i = Chan.hhvec[chan][2*hh];
        j = Chan.hhvec[chan][2*hh + 1];
        for(int pp = 0; pp < npp; ++pp){
	  a = Chan.ppvec[chan][2*pp];
	  b = Chan.ppvec[chan][2*pp + 1];
	  energy0 = V_Minnesota(Space, i, j, a, b);
	  energy0 *= energy0;
	  energy0 /= (Space.qnums[i].energy + Space.qnums[j].energy - Space.qnums[a].energy - Space.qnums[b].energy);
	  energy += energy0;
        }
      }
    }
    energy *= 0.25;
  }
\end{lstlisting}

The next function is exactly like the last except that it is parallelized like the improvement from the first to the second function. However, there are some obvious differences. Because the sizes of hhvec and ppvec for each channel can be wildly different, splitting the loop over channels into a team of threads could be massively unbalanced. An easy way to balance the threads to use a static scheduler is to parallelize the loops over ppvec inside each channel because each nested loop over ''hhvec'' is equivalent.

\begin{lstlisting}
  void MBPT2_3(const Input_Parameters &Parameters, const Model_Space &Space, const Channels &Chan)
  {
    double energy = 0.0;
    double energy0;
    int nhh, npp, i, j, a, b;
    for(int chan = 0; chan < Chan.size; ++chan){
      nhh = Chan.nhh[chan];
      npp = Chan.npp[chan];
      if(nhh*npp == 0){ continue; }
      
      #pragma omp parallel private(i, j, a, b, energy0)
      {
        #pragma omp for schedule(static) reduction(+:energy)
        for(int hh = 0; hh < nhh; ++hh){
	  i = Chan.hhvec[chan][2*hh];
	  j = Chan.hhvec[chan][2*hh + 1];
	  for(int pp = 0; pp < npp; ++pp){
	    a = Chan.ppvec[chan][2*pp];
	    b = Chan.ppvec[chan][2*pp + 1];
	    energy0 = V_Minnesota(Space, i, j, a, b);
	    energy0 *= energy0;
	    energy0 /= (Space.qnums[i].energy + Space.qnums[j].energy - Space.qnums[a].energy - Space.qnums[b].energy);
	    energy += energy0;
	  }
        }
      }
    }
    energy *= 0.25;
  }
\end{lstlisting}

The last MBPT2 function uses the ``hhvec'' and ``ppvec'' lists from the channel function to make matrices of the relevant interaction matrix elements and energy denominators. Then it uses a matrix-matrix multiplication function from \cite{blas} to sum the elements together like equation Eq.~(\ref{eq:mtxmtx}). The benefit to this strategy is that this function is optimized to compute the matrix-matrix multiplication faster than an equivalent loop structure. The detriment is the memory required to hold the different matrix elements.

\begin{lstlisting}
  void MBPT2_4(const Input_Parameters &Parameters, const Model_Space &Space, const Channels &Chan)
  {
    double energy = 0.0;
    double *V1, *V2, *S1;
    char N = 'N';
    double fac0 = 0.0;
    double fac1 = 1.0;
    int nhh, npp, i, j, a, b, idx;
    double energy0;
    for(int chan = 0; chan < Chan.size; ++chan){
      nhh = Chan.nhh[chan];
      npp = Chan.npp[chan];
      if(nhh*npp == 0){ continue; }
      
      V1 = new double[nhh * npp];
      V2 = new double[npp * nhh];
      S1 = new double[nhh * nhh];
      #pragma omp parallel shared(V1, V2) private(i, j, a, b, idx, energy0)
      {
        #pragma omp for schedule(static)
        for(int hh = 0; hh < nhh; ++hh){
	  i = Chan.hhvec[chan][2*hh];
	  j = Chan.hhvec[chan][2*hh + 1];
	  for(int pp = 0; pp < npp; ++pp){
	    a = Chan.ppvec[chan][2*pp];
	    b = Chan.ppvec[chan][2*pp + 1];
	    idx = hh * npp + pp;
	    energy0 = V_Minnesota(Space, i, j, a, b);
	    V1[idx] = energy0 / (Space.qnums[i].energy + Space.qnums[j].energy - Space.qnums[a].energy - Space.qnums[b].energy);
	    idx = pp * nhh + hh;
	    V2[idx] = energy0;
	  }
        }
      } 
      RM_dgemm(V1, V2, S1, &nhh, &nhh, &npp, &fac1, &fac0, &N, &N);
      delete V1; delete V2;
      
      for(int hh = 0; hh < nhh; ++hh){ energy += S1[nhh*hh + hh]; }
      delete S1;
    }
  }
\end{lstlisting}

\begin{figure}
  \includegraphics[width=\linewidth]{Chapter8-figures/MBPT2fig.pdf}
  \caption{Computation times of the MBPT2 energy correction for different algorithms and the time to construct symmetry channels. These calculations use the Minnesota potential with a density of $\mathrm{\rho=0.08\ fm^{-3}}$ and $\mathrm{14}$ neutrons.}
  \label{fig:fig5}
\end{figure}

Figure~(\ref{fig:fig5}) shows the computation times from these MBPT2 functions and the channel setup function for up to 28 major shells with 14 neutrons at a density 0f $0.08 fm^{-3}$. There is a clear improvement from the first to the second function and the third to the fourth, except in very small cases where the overhead from parallelization is overwhelming. It's also clear that there is an order of magnitude by first computing the symmetry channels. However, there are two aspects of these improvements that aren't clear. First, the time it takes to setup the channels begins to overcome the MBPT2 sums for large cases due to its higher scaling. Second, the matrix-matrix multiplication in the fifth function doesn't improve on the previous function because the same loops are needed to fill the matrices in the first place.

To more clearly see the power of matrix-matrix multiplication and why the scaling of the channel function becomes insignificant, we move to the particle-particle term in the MBPT3 energy term which is shown in diagram 4 of fig. 8.2 and in eqn. 8.65. This sum should naively scale as $h^2p^4$ which for larger model spaces dramatically increase the computation time. The first four functions for MBPT3 mirror very closely those for MBPT2 with additional loop(s) for the additional two particle indices.

\begin{lstlisting}
  void MBPT3_0(const Input_Parameters &Parameters, const Model_Space &Space)
  {
    double energy0, energy1;
    double energy = 0.0;
    for(int i = 0; i < Space.indhol; ++i){
      for(int j = 0; j < Space.indhol; ++j){
        if(i == j){ continue; }
        for(int a = Space.indhol; a < Space.indtot; ++a){
	  for(int b = Space.indhol; b < Space.indtot; ++b){
	    if(a == b){ continue; }
	    energy0 = V_Minnesota(Space, i, j, a, b);
	    energy0 /= (Space.qnums[i].energy + Space.qnums[j].energy - Space.qnums[a].energy - Space.qnums[b].energy);
	    for(int c = Space.indhol; c < Space.indtot; ++c){
	      for(int d = Space.indhol; d < Space.indtot; ++d){
	        if(c == d){ continue; }
	        energy1 = V_Minnesota(Space, a, b, c, d);
	        energy1 *= V_Minnesota(Space, c, d, i, j);
	        energy1 /= (Space.qnums[i].energy + Space.qnums[j].energy - Space.qnums[c].energy - Space.qnums[d].energy);
	        energy += energy0 * energy1;
	      }
	    }
	  }
        }
      }
    }
    energy *= 0.125;
  }
\end{lstlisting}

\begin{lstlisting}
  void MBPT3_1(const Input_Parameters &Parameters, const Model_Space &Space)
  {
    double energy = 0.0;
    double energy0, energy1;
    #pragma omp parallel private(energy0, energy1)
    {
      #pragma omp for schedule(static) reduction(+:energy)
      for(int i = 0; i < Space.indhol; ++i){
        for(int j = 0; j < Space.indhol; ++j){
	  if(i == j){ continue; }
	  for(int a = Space.indhol; a < Space.indtot; ++a){
	    for(int b = Space.indhol; b < Space.indtot; ++b){
	      if(a == b){ continue; }
	      energy0 = V_Minnesota(Space, i, j, a, b);
	      energy0 /= (Space.qnums[i].energy + Space.qnums[j].energy - Space.qnums[a].energy - Space.qnums[b].energy);
	      for(int c = Space.indhol; c < Space.indtot; ++c){
	        for(int d = Space.indhol; d < Space.indtot; ++d){
		  if(c == d){ continue; }
		  energy1 = V_Minnesota(Space, a, b, c, d);
		  energy1 *= V_Minnesota(Space, c, d, i, j);
		  energy1 /= (Space.qnums[i].energy + Space.qnums[j].energy - Space.qnums[c].energy - Space.qnums[d].energy);
		  energy += energy0 * energy1;
	        }
	      }
	    }
	  }
        }
      }
    }
    energy *= 0.125;
  }
\end{lstlisting}

\begin{lstlisting}
  void MBPT3_2(const Input_Parameters &Parameters, const Model_Space &Space, const Channels &Chan)
  {
    double energy = 0.0;
    double energy0, energy1;
    int nhh, npp, i, j, a, b, c, d;
    for(int chan = 0; chan < Chan.size; ++chan){
      nhh = Chan.nhh[chan];
      npp = Chan.npp[chan];
      if(nhh*npp == 0){ continue; }
      
      for(int hh = 0; hh < nhh; ++hh){
        i = Chan.hhvec[chan][2*hh];
        j = Chan.hhvec[chan][2*hh + 1];
        for(int pp0 = 0; pp0 < npp; ++pp0){
	  a = Chan.ppvec[chan][2*pp0];
	  b = Chan.ppvec[chan][2*pp0 + 1];
	  energy0 = V_Minnesota(Space, i, j, a, b);
	  energy0 /= (Space.qnums[i].energy + Space.qnums[j].energy - Space.qnums[a].energy - Space.qnums[b].energy);
	  for(int pp1 = 0; pp1 < npp; ++pp1){
	    c = Chan.ppvec[chan][2*pp1];
	    d = Chan.ppvec[chan][2*pp1 + 1];
	    energy1 = V_Minnesota(Space, a, b, c, d);
	    energy1 *= V_Minnesota(Space, c, d, i, j);
	    energy1 /= (Space.qnums[i].energy + Space.qnums[j].energy - Space.qnums[c].energy - Space.qnums[d].energy);
	    energy += energy0 * energy1;
	  }
        }
      }
    }
    energy *= 0.125;
  }
\end{lstlisting}

\begin{lstlisting}
  void MBPT3_3(const Input_Parameters &Parameters, const Model_Space &Space, const Channels &Chan)
  {
    double energy = 0.0;
    double energy0, energy1;
    int nhh, npp, i, j, a, b, c, d;
    for(int chan = 0; chan < Chan.size; ++chan){
      nhh = Chan.nhh[chan];
      npp = Chan.npp[chan];
      if(nhh*npp == 0){ continue; }
      
      #pragma omp parallel private(i, j, a, b, c, d, energy0, energy1)
      {
        #pragma omp for schedule(static) reduction(+:energy)
        for(int hh = 0; hh < nhh; ++hh){
	  i = Chan.hhvec[chan][2*hh];
	  j = Chan.hhvec[chan][2*hh + 1];
	  for(int pp0 = 0; pp0 < npp; ++pp0){
	    a = Chan.ppvec[chan][2*pp0];
	    b = Chan.ppvec[chan][2*pp0 + 1];
	    energy0 = V_Minnesota(Space, i, j, a, b);
	    energy0 /= (Space.qnums[i].energy + Space.qnums[j].energy - Space.qnums[a].energy - Space.qnums[b].energy);
	    for(int pp1 = 0; pp1 < npp; ++pp1){
	      c = Chan.ppvec[chan][2*pp1];
	      d = Chan.ppvec[chan][2*pp1 + 1];
	      energy1 = V_Minnesota(Space, a, b, c, d);
	      energy1 *= V_Minnesota(Space, c, d, i, j);
	      energy1 /= (Space.qnums[i].energy + Space.qnums[j].energy - Space.qnums[c].energy - Space.qnums[d].energy);
	      energy += energy0 * energy1;
	    }
	  }
        }
      }
    }
    energy *= 0.125;
  }
\end{lstlisting}

The last function is slightly different from its MBPT2 counterpart where loops over $ijab$ were needed to fill the matrices. In this function, the matrices are filled by looping over $ijab$ and $abcd$, respectively, instead of $ijabcd$. Then, the matrix-matrix multiplications take care of the sum over $ab$ between the two structures into an intermediate matrix. This essentially allows the function to scale as the dominant loop, $p^4$, naively improving the computation time by a factor of $h^2$.

\begin{lstlisting}
  void MBPT3_4(const Input_Parameters &Parameters, const Model_Space &Space, const Channels &Chan)
  {
    double energy = 0.0;
    double *V1, *S1, *V2, *S2;
    char N = 'N';
    char T = 'T';
    double fac0 = 0.0;
    double fac1 = 1.0;
    int nhh, npp, i, j, a, b, c, d, idx;
    double energy0;
    for(int chan = 0; chan < Chan.size; ++chan){
      nhh = Chan.nhh[chan];
      npp = Chan.npp[chan];
      if(nhh*npp == 0){ continue; }
      
      V1 = new double[nhh * npp];
      S1 = new double[nhh * npp];
      V2 = new double[npp * npp];
      S2 = new double[nhh * nhh];
      #pragma omp parallel shared(V1, V2) private(i, j, a, b, c, d, idx, energy0)
      {
        #pragma omp for schedule(static)
        for(int pp0 = 0; pp0 < npp; ++pp0){
	  a = Chan.ppvec[chan][2*pp0];
	  b = Chan.ppvec[chan][2*pp0 + 1];
	  for(int hh = 0; hh < nhh; ++hh){
	    i = Chan.hhvec[chan][2*hh];
	    j = Chan.hhvec[chan][2*hh + 1];
	    idx = hh * npp + pp0;
	    energy0 = V_Minnesota(Space, i, j, a, b);
	    energy0 /= (Space.qnums[i].energy + Space.qnums[j].energy - Space.qnums[a].energy - Space.qnums[b].energy);
	    V1[idx] = energy0;
	  }
	  for(int pp1 = 0; pp1 < npp; ++pp1){
	    c = Chan.ppvec[chan][2*pp1];
	    d = Chan.ppvec[chan][2*pp1 + 1];
	    idx = pp0 * npp + pp1;
	    V2[idx] = V_Minnesota(Space, a, b, c, d);
	  }
        }
      }
      
      RM_dgemm(V1, V2, S1, &nhh, &npp, &npp, &fac1, &fac0, &N, &N);
      RMT_dgemm(S1, V1, S2, &nhh, &nhh, &npp, &fac1, &fac0, &N, &T);
      delete V1; delete V2; delete S1;
      for(int hh = 0; hh < nhh; ++hh){
        energy += S2[nhh*hh + hh];
      }
      delete S2;
    }
    energy *= 0.125;
  }
\end{lstlisting}

\begin{figure}
  \includegraphics[width=\linewidth]{Chapter8-figures/MBPT3fig.pdf}
  \caption{Computation times of the MBPT3 particle-particle energy correction for different algorithms and the time to construct symmetry channels. These calculations use the Minnesota potential with a density of $\mathrm{\rho=0.08\ fm^{-3}}$ and $\mathrm{14}$ neutrons. The dotted extensions for functions MBPT3_0 and MBPT3_1 are extrapolations.}
  \label{fig:fig6}
\end{figure}

Figure\ref{fig:fig6} shows the run times from the MBPT3 functions and the channel setup function up to 28 major shells with 14 neutrons at a density 0f $0.08 fm^{-3}$. The obvious difference between MBPT3 and MBPT2 is the massive increase in computation time. For example, the largest case with the first function would take approximately eight months to compute. Because of this, the first two functions had to be extrapolated for the larger cases. Again, there is a clear improvement from the first to the second function, from the third to the fourth, and by first computing the symmetry channels. In this case, however, the scaling of the channel function is dwarfed by the $h^2p^4$ scaling of the sum. In addition, the optimized matrix-matrix multiplication improves the computation time by another order of magnitude by using an intermediate matrix. Because all many-body methods include similar sums to MBPT and also utilize interactions that benefit from exploiting its symmetries, all of these strategies can be used to make computation times managable.

\section{Conclusions}
In this chapter we have presented many of the basic ingredients that
enter theoretical studies of infinite nuclear matter, with possible
extensions to the homogeneous electron gas in two and three dimensions
or other quantum mechanical systems.  We have focused on the
construction of a single-particle and many-body basis appropriate for
such systems, as well as introducing post Hartree-Fock many-body
methods like full configuration interaction theory, many-body
perturbation theory and coupled cluster theory. The results here,
albeit being obtained with a simpler model for the nuclear forces, can
easily be extended to more complicated and realistic models for
nuclear interactions and to include other many-body methods. We have
however, for pedagogical reasons, tried to keep the theoretical inputs
to the various many-body methods as simple as possible. The reader
should however, with the inputs from chapters 2-6, be able to have a
better of understanding of nuclear forces and how these can be derived
from the underlying theory for the strong force and effective field
theory.  The last exercise in this chapter replaces the simple Minnesota potential with
realistic interaction from effective field theory. 



The subsequent chapters 9, 10 and 11 show how many of the theoretical
concepts and code elements discussed in this chapter can be used to
add other many-body methods, without having to develop a new numerical
project.  With a proper modularization and flexible classes, we can
add new physical systems as well as new many-body methods.  The codes
which have been developed in this chapter can be reused in the
development and analysis of the in-medium similarity renormalizaton
group approach of chapter 10 or the Green's function approach in chapter 11. Similarly, the theoretical concepts we
have developed in this chapter, such as the definition of a
single-particle basis using plane wave functions and correlations from
many-body perturbation theory or coupled cluster theory, can be used
in chapter 9, 10 and 11 as well. Chapter 9 for example, uses results
from coupled cluster theory in order to provide better ways to constrain
the Jastrow factor, which accounts for correlations beyond a mean-field picture, 
in Monte Carlo calculations.



  \section{Exercises}
  \begin{prob} \label{problem:prob8.1}
  Show that the one-body part of the Hamiltonian
      \begin{equation*}
          \hat{H}_0 = \sum_{pq} \element{p}{\hat{h}_0}{q} a^\dagger_p
          a_q
      \end{equation*}
  can be written, using standard annihilation and creation operators,
  in normal-ordered form as
      \[
          \hat{H}_0 = \sum_{pq} \element{p}{\hat{h}_0}{q}
          \left\{a^\dagger_p a_q\right\} + \sum_i
          \element{i}{\hat{h}_0}{i}
      \]
  Explain the meaning of the various symbols. Which reference vacuum
  has been used?
  \end{prob}


  \begin{prob} \label{problem:prob8.2}
  Show that the two-body part of the Hamiltonian
      \begin{equation*}
          \hat{H}_I = \frac{1}{4} \sum_{pqrs}
          \element{pq}{\hat{v}}{rs} a^\dagger_p a^\dagger_q a_s a_r
      \end{equation*}
  can be written, using standard annihilation and creation operators,
  in normal-ordered form as
      \begin{align*}
      \hat{H}_I &= \frac{1}{4} \sum_{pqrs} \element{pq}{\hat{v}}{rs}
      a^\dagger_p a^\dagger_q a_s a_r \nonumber \\ &= \frac{1}{4}
      \sum_{pqrs} \element{pq}{\hat{v}}{rs} \normord{a^\dagger_p
        a^\dagger_q a_s a_r} + \sum_{pqi} \element{pi}{\hat{v}}{qi}
      \normord{a^\dagger_p a_q} + \frac{1}{2} \sum_{ij}
      \element{ij}{\hat{v}}{ij}
      \end{align*}
  Explain again the meaning of the various symbols.
  \end{prob}



  \begin{prob}\label{problem:prob8.3}
  Derive the normal-ordered form of the threebody part of the
  Hamiltonian.
  \[
      \hat{H}_3 = \frac{1}{36} \sum_{\substack{ pqr \\ stu}}
      \element{pqr}{\hat{v}_3}{stu} a^\dagger_p a^\dagger_q
      a^\dagger_r a_u a_t a_s,
  \]
  and specify the contributions to the two-body, one-body and the
  constant part.
  \end{prob}



  \begin{prob}\label{problem:spbasissetup}
  Develop a program which sets up a single-particle basis for nuclear
  matter calculations with input a given number of nucleons and a user
  specificied density or Fermi momentum. Follow the setup discussed in
  Table \ref{tab:table1}.  You need to define the number of particles
  $A$ and the density of the system using
  \[
  n = g \frac{k_F^3}{6\pi^2}.
  \]
  Here you can either define the density itself or the Fermi momentum
  $k_F$.  With the density/Fermi momentum and a fixed number of
  nucleons $A$, we can define the length $L$ of the box used with our
  periodic boundary contributions via the relation
  \[
    V= L^3= \frac{A}{n}.
  \]
  We can then can use $L$ to define the spacing between various
  $k$-values, that is
  \[
    \Delta k = \frac{2\pi}{L}.
  \]
  \end{prob}


  \begin{prob}\label{problem:fourier}
  The interaction we will use for these calculations is a
  semirealistic nucleon-nucleon potential known as the Minnesota
  potential \cite{minnesota} which has the form, $V_{\alpha}\left(
  r\right)=V_{\alpha}\exp{-(\alpha r^{2})}$. The spin and isospin
  dependence of the Minnesota potential is given by,
  \[
  V\left( r\right)=\frac{1}{2}\left( V_{R}+\frac{1}{2}\left(
  1+P_{12}^{\sigma}\right) V_{T}+\frac{1}{2}\left(
  1-P_{12}^{\sigma}\right) V_{S}\right)\left(
  1-P_{12}^{\sigma}P_{12}^{\tau}\right),
  \]
  where $P_{12}^{\sigma}=\frac{1}{2}\left(
  1+\sigma_{1}\cdot\sigma_{2}\right)$ and
  $P_{12}^{\tau}=\frac{1}{2}\left( 1+\tau_{1}\cdot\tau_{2}\right)$ are
  the spin and isospin exchange operators, respectively.  Show that a
  Fourier transform to momentum space results in
  \[
  \langle \mathbf{k}_p \mathbf{k}_q \vert V_{\alpha}\vert
  \mathbf{k}_r\mathbf{k}_s\rangle=\frac{V_{\alpha}}{L^{3}}\left(\frac{\pi}{\alpha}\right)^{3/2}\exp{\frac{-q^{2}}{4\alpha}}\delta_{\vec{k}_{p}+\vec{k}_{q},\vec{k}_{r}+\vec{k}_{s}}.
  \]
  Write thereafter a function which sets up the full anty-symmetrized
  matrix elements for the Minnesota potential using the parameters
  listed in Table \ref{tab:minnesotatab}.
  \end{prob}



  \begin{prob}\label{problem:unitarity}
  Consider a Slater determinant built up of orthogonal single-particle
  orbitals $\psi_{\lambda}$, with $\lambda = 1,2,\dots,A$.

  The unitary transformation
  \[
  \psi_a = \sum_{\lambda} C_{a\lambda}\phi_{\lambda},
  \]
  brings us into the new basis.  The new basis has quantum numbers
  $a=1,2,\dots,A$.  Show that the new basis is orthogonal.
  \begin{enumerate}
  \item[a)] Show that the new Slater determinant constructed from the
    new single-particle wave functions can be written as the
    determinant based on the previous basis and the determinant of the
    matrix $C$.
  \item[b)] Show that the old and the new Slater determinants are
    equal up to a complex constant with absolute value unity.  Hint:
    $C$ is a unitary matrix.
  \end{enumerate}
  \end{prob}

  \begin{prob}\label{problem:referenceE}
  Use the ansatz for the ground state in second quantization
  \[
  |\Phi_0\rangle = \left(\prod_{i\le
    F}\hat{a}_{i}^{\dagger}\right)|0\rangle,
  \]
  where the index $i$ defines different single-particle states up to
  the Fermi level, to calculate using Wick's theorem (see the
  appendix) the expectation value
  \[
    E[\Phi_0]= E_{\mathrm{Ref}}= \sum_{i\le F}^A \langle i | \hat{h}_0
    | i \rangle + \frac{1}{2}\sum_{ij\le F}^A\langle
    ij|\hat{v}|ij\rangle.
  \]
  Insert thereafter the plane wave function basis for the various
  single-particle states and show that the above energy can be written
  as
  \[
    E[\Phi_0] = \sum_{i\le F}^A \langle k_i | \hat{t} | k_i \rangle +
    \frac{1}{2}\sum_{ij\le F}^A\langle
    k_ik_j|\hat{v}|k_ik_j\rangle,
  \]
  where we use the shorthand $\vert k_i\rangle = \vert
  \mathbf{k}_i,\sigma_i,\tau_{z_i}\rangle$ for the single-particle
  states in three dimensions.

  Replace then the discrete sums with integrals, that is
  \[
  \sum_i \rightarrow
  \sum_{\sigma_i}\sum_{\tau_{z_i}}\frac{L^3}{(2\pi)^3}\int_0^{\mathbf{k}_F}d\mathbf{k},
  \]
  and show that the energy per particle $A$ can be written as (for
  symmetric nuclear matter)
  \[
    \frac{E_{\mathrm{Ref}}}{A}=\frac{3\hbar^2k_F^2}{10M_N}+\frac{1}{2n}\frac{L^3}{(2\pi)^6}\sum_{\sigma_i\sigma_j}\sum_{\tau_{z_i}\tau_{z_j}}\int_0^{\mathbf{k}_F}d\mathbf{k}_i\int_0^{\mathbf{k}_F}d\mathbf{k}_j\langle
    k_ik_j|\hat{v}|k_ik_j\rangle,
  \]
  with the density $n=V/A=L^3/A$.

  Find the following expression for pure neutron matter. Use the
  Minnesota interaction and try to simplify the above six-dimensional
  integral for pure neutron matter (Hint: the interaction depends only
  the momentum transfer squared and fix one of the momentum
  integrations along the $z$-axis. Integrate out the dependence on the
  various angles).

  Finally, write a program which computes the above energy for pure
  nuetron matter using the Minnesota potential.
  \end{prob}

  \begin{prob}\label{problem:hamiltoniansetup}
  We will assume that we can build various Slater determinants using
  an orthogonal single-particle basis $\psi_{\lambda}$, with $\lambda= 1,2,\dots,A$.


  The aim of this exercise is to set up specific matrix elements that
  will turn useful when we start our discussions of different
  many-body methods. In particular you will notice, depending on the
  character of the operator, that many matrix elements will actually
  be zero.

  Consider three $A$-particle Slater determinants $|\Phi_0$,
  $|\Phi_i^a\rangle$ and $|\Phi_{ij}^{ab}\rangle$, where the notation
  means that Slater determinant $|\Phi_i^a\rangle$ differs from
  $|\Phi_0\rangle$ by one single-particle state, that is a
  single-particle state $\psi_i$ is replaced by a single-particle
  state $\psi_a$.  It will later be interpreted as a so-called
  one-particle-one-hole excitation.  Similarly, the Slater determinant
  $|\Phi_{ij}^{ab}\rangle$ differs by two single-particle states from
  $|\Phi_0\rangle$ and is normally thought of as a
  two-particle-two-hole excitation.

  Define a general one-body operator $\hat{F} =
  \sum_{i}^A\hat{f}(x_{i})$ and a general two-body operator
  $\hat{G}=\sum_{i>j}^A\hat{g}(x_{i},x_{j})$ with $g$ being invariant
  under the interchange of the coordinates of particles $i$ and $j$.
  \begin{enumerate}
  \item[a)]
  \[
  \langle \Phi_0 \vert\hat{F}\vert\Phi_0\rangle,
  \]
  and
  \[
  \langle \Phi_0\vert\hat{G}|\Phi_0\rangle.
  \]
  \item[b)] Find thereafter
  \[
  \langle \Phi_0 |\hat{F}|\Phi_i^a\rangle,
  \]
  and
  \[
  \langle \Phi_0|\hat{G}|\Phi_i^a\rangle,
  \]
  \item[c)] Finally, find
  \[
  \langle \Phi_0 |\hat{F}|\Phi_{ij}^{ab}\rangle,
  \]
  and
  \[
  \langle \Phi_0|\hat{G}|\Phi_{ij}^{ab}\rangle.
  \]
  \item[d)] What happens with the two-body operator if we have a
    transition probability of the type
  \[
  \langle \Phi_0|\hat{G}|\Phi_{ijk}^{abc}\rangle,
  \]
  where the Slater determinant to the right of the operator differs by
  more than two single-particle states?
  \item[e)] With an orthogonal basis of Slater determinants
    $\Phi_{\lambda}$, we can now construct an exact many-body state as
    a linear expansion of Slater determinants, that is, a given exact
    state
  \[
  \Psi_i = \sum_{\lambda =0}^{\infty}C_{i\lambda}\Phi_{\lambda}.
  \]
  In all practical calculations the infinity is replaced by a given
  truncation in the sum.

  If you are to compute the expectation value of (at most) a two-body
  Hamiltonian for the above exact state
  \[
  \langle \Psi_i \vert \hat{H} \vert \Psi_i\rangle,
  \]
  based on the calculations above, which are the only elements which
  will contribute?  (there is no need to perform any calculation here,
  use your results from exercises a), b), and c)).

  These results simplify to a large extent shell-model calculations.
  \end{enumerate}
  \end{prob}

  \begin{prob}\label{problem:diagrams}
Write down the analytical expressions for diagrams (8) and (9) in Fig.~\ref{fig:goldstone} and discuss whether these
diagrams should be accounted for or not in the calculation of the energy per particle of infinite matter. 
If a Hartree-Fock basis is used, should these diagrams be included?  
Show also that diagrams (2), (6)-(7) and (10)-(16) are zero in infinite matter due to the lack of momentum conservation. 
\end{prob}

  \begin{prob}\label{problem:pairingmodel}


  We present a simplified Hamiltonian consisting of an unperturbed
  Hamiltonian and a so-called pairing interaction term. It is a model
  which to a large extent mimicks some central features of atomic
  nuclei, certain atoms and systems which exhibit superfluiditity or
  superconductivity.  To study this system, we will use a mix of
  many-body perturbation theory (MBPT), Hartree-Fock (HF) theory and
  full configuration interaction (FCI) theory. The latter will also
  provide us with the exact answer.  When setting up the Hamiltonian
  matrix you will need to solve an eigenvalue problem.

  We define first the Hamiltonian, with a definition of the model
  space and the single-particle basis. Thereafter, we present the
  various exercises (some of them are solved).


  The Hamiltonian acting in the complete Hilbert space (usually
  infinite dimensional) consists of an unperturbed one-body part,
  $\hat{H}_0$, and a perturbation $\hat{V}$.

  We limit ourselves to at most two-body interactions and our
  Hamiltonian is represented by the following operators
  \[
  \hat{H} = \sum_{\alpha\beta}\langle \alpha |h_0|\beta\rangle
  a_{\alpha}^{\dagger}a_{\beta}+\frac{1}{4}\sum_{\alpha\beta\gamma\delta}\langle
  \alpha\beta| V|\gamma\delta\rangle
  a_{\alpha}^{\dagger}a_{\beta}^{\dagger}a_{\delta}a_{\gamma},
  \]
  where $a_{\alpha}^{\dagger}$ and $a_{\alpha}$ etc.~are standard
  fermion creation and annihilation operators, respectively, and
  $\alpha\beta\gamma\delta$ represent all possible single-particle
  quantum numbers.  The full single-particle space is defined by the
  completeness relation
  \[
  \hat{{\bf 1}} = \sum_{\alpha=1}^{\infty}|\alpha \rangle \langle
  \alpha|.
  \]
  In our calculations we will let the single-particle states
  $|\alpha\rangle$ be eigenfunctions of the one-particle operator
  $\hat{h}_0$. Note that the two-body part of the Hamiltonian contains
  anti-symmetrized matrix elements.


  The above Hamiltonian acts in turn on various many-body Slater
  determinants constructed from the single-basis defined by the
  one-body operator $\hat{h}_0$.  As an example, the two-particle
  model space $\mathcal{P}$ is defined by an operator
  \[
  \hat{P} = \sum_{\alpha\beta =1}^{m}|\alpha\beta \rangle \langle
  \alpha\beta|,
  \]
  where we assume that $m=\dim(\mathcal{P})$ and the full space is
  defined by
  \[
  \hat{P}+\hat{Q}=\hat{{\bf 1}},
  \]
  with the projection operator
  \[
  \hat{Q} = \sum_{\alpha\beta =m+1}^{\infty}|\alpha\beta \rangle
  \langle \alpha\beta|,
  \]
  being the complement of $\hat{P}$.


  Our specific model consists of $N$ doubly-degenerate and equally
  spaced single-particle levels labelled by $p=1,2,\dots$ and spin
  $\sigma=\pm 1$.  These states are schematically portrayed in
  Fig.~\ref{fig:schematic}.  The first two single-particle levels
  define a possible model space, indicated by the label $\mathcal{P}$.
  The remaining states span the excluded space $\mathcal{Q}$.

  We write the Hamiltonian as
  \[ \hat{H} = \hat{H}_0 + \hat{V} , \]
  where
  \[
  \hat{H}_0=\xi\sum_{p\sigma}(p-1)a_{p\sigma}^{\dagger}a_{p\sigma}
  \]
  and
  \[
  \hat{V}=-\frac{1}{2}g\sum_{pq}a^{\dagger}_{p+}
  a^{\dagger}_{p-}a_{q-}a_{q+}.
  \]
  Here, $H_0$ is the unperturbed Hamiltonian with a spacing between
  successive single-particle states given by $\xi$, which we will set
  to a constant value $\xi=1$ without loss of generality. The two-body
  operator $\hat{V}$ has one term only. It represents the pairing
  contribution and carries a constant strength $g$.

  The indices $\sigma=\pm$ represent the two possible spin values. The
  interaction can only couple pairs and excites therefore only two
  particles at the time.


  \begin{enumerate}
  \item[a)] Show that the unperturbed Hamiltonian $\hat{H}_0$ and
    $\hat{V}$ commute with both the spin projection $\hat{S}_z$ and
    the total spin $\hat{S}^2$, given by
  \[
    \hat{S}_z := \frac{1}{2}\sum_{p\sigma} \sigma
    a^{\dagger}_{p\sigma}a_{p\sigma}
  \]
  and
  \[
    \hat{S}^2 := \hat{S}_z^2 + \frac{1}{2}(\hat{S}_+\hat{S}_- +
    \hat{S}_-\hat{S}_+),
  \]
  where
  \[
    \hat{S}_\pm := \sum_{p} a^{\dagger}_{p\pm} a_{p\mp}.
  \]
  This is an important feature of our system that allows us to
  block-diagonalize the full Hamiltonian. We will focus on total spin
  $S=0$.  In this case, it is convenient to define the so-called pair
  creation and pair annihilation operators
  \[
  \hat{P}^{+}_p = a^{\dagger}_{p+}a^{\dagger}_{p-},
  \]
  and
  \[
  \hat{P}^{-}_p = a_{p-}a_{p+},
  \]
  respectively.
  \item[b)] Show that you can rewrite the Hamiltonian (with $\xi=1$)
    as
  \[
  \hat{H}=\sum_{p\sigma}(p-1)a_{p\sigma}^{\dagger}a_{p\sigma}
  -\frac{1}{2}g\sum_{pq}\hat{P}^{+}_p\hat{P}^{-}_q.
  \]
  \item[c)] Show also that Hamiltonian commutes with the product of
    the pair creation and annihilation operators.  This model
    corresponds to a system with no broken pairs. This means that the
    Hamiltonian can only link two-particle states in so-called
    spin-reversed states.

  \item[d)] Construct thereafter the Hamiltonian matrix for a system
    with no broken pairs and total spin $S=0$ for the case of the four
    lowest single-particle levels indicated in the
    Fig.~\ref{fig:schematic}. Our system consists of four particles
    only.  Our single-particle space consists of only the four lowest
    levels $p=1,2,3,4$.  You need to set up all possible Slater
    determinants.  Find all eigenvalues by diagonalizing the
    Hamiltonian matrix.  Vary your results for values of $g\in
    [-1,1]$.  We refer to this as the exact calculation. Comment the
    behavior of the ground state as function of $g$.
  \end{enumerate}
  \end{prob}



  \begin{prob}\label{problem:prob8.5}
  \begin{enumerate}
  \item[a)] We will now set up the Hartree-Fock equations by varying
    the coefficients of the single-particle functions. The
    single-particle basis functions are defined as
  \[
  \psi_p = \sum_{\lambda} C_{p\lambda}\psi_{\lambda}.
  \]
  where in our case $p=1,2,3,4$ and $\lambda=1,2,3,4$, that is the
  first four lowest single-particle orbits of
  Fig.~\ref{fig:schematic}.  Set up the Hartree-Fock equations for
  this system by varying the coefficients $C_{p\lambda}$ and solve
  them for values of $g\in [-1,1]$.  Comment your results and compare
  with the exact solution. Discuss also which diagrams in
  Fig.~\ref{fig:diagrams} that can be affected by a Hartree-Fock
  basis. Compute the total binding energy using a Hartree-Fock basis
  and comment your results.

  \item[b)] We will now study the system using non-degenerate
    Rayleigh-Schr\"odinger perturbation theory to third order in the
    interaction.  If we exclude the first order contribution, all
    possible diagrams (so-called anti-symmetric Goldstone diagrams)
    are shown in Fig.~\ref{fig:diagrams}.


  Based on the form of the interaction, which diagrams contribute to
  the binding energy of the ground state?  Write down the expressions
  for the diagrams that contribute and find the contribution to the
  ground state energy as function $g\in [-1,1]$. Comment your results.
  Compare these results with those you obtained from the exact
  diagonalization with and without the $4p-4h$ state.  Discuss your
  results for a canonical Hartree-Fock basis and a non-canonical
  Hartree-Fock basis.


  Diagram 1 in Fig.~\ref{fig:diagrams} represents a second-order
  contribution to the energy and a so-called $2p-2h$ contribution to
  the intermediate states. Write down the expression for the wave
  operator in this case and compare the possible contributions with
  the configuration interaction calculations without the $4p-4h$
  Slater determinant. Comment your results for various values of $g\in
  [-1,1]$.

  We limit now the discussion to the canonical Hartree-Fock case
  only. To third order in perturbation theory we can produce diagrams
  with $1p-1h$, $2p-2h$ and $3p-3h$ intermediate excitations as shown in


  Define first linked and unlinked diagrams and explain briefly
  Goldstone's linked diagram theorem.  Based on the linked diagram
  theorem and the form of the pairing Hamiltonian, which diagrams will
  contribute to third order?

  Calculate the energy to third order with a canonical Hartree-Fock
  basis for $g\in [-1,1]$ and compare with the full diagonalization
  case in exercise b). Discuss the results.
  \end{enumerate}



  \end{prob}


  \begin{prob}\label{problem:prob8.6}
  This project serves as a continuation of the pairing model with the
  aim being to solve the same problem but now by developing a program
  that implements the coupled cluster method with double excitations
  only. In doing so you will find it convenient to write classes which
  define the single-particle basis and the Hamiltonian. Your functions
  that solve the coupled cluster equations will then just need to set
  up variables which point to interaction elements and single-particle
  states with their pertinent quantum numbers. Use for example the
  setup discussed in the FCI lectures for the pairing model.

  \begin{enumerate}

  \item[a)] Explain why no single excitations are involved in this
    model.


  \item[b)] Set up the coupled cluster equations for doubles
    excitations and convince yourself about their meaning and
    correctness.

  \item[c)] Write a class which holds single-particle data like
    specific quantum numbers, single-particle Hamiltonian etc. Write
    also a class which sets up and stores two-body matrix elements
    defined by the single-particle states.  Write thereafter
    functions/classes which implement the coupled cluster method with
    doubles only.


  \item[d)] Compare your results with those from the exact
    diagonalization with and without the $4p4h$ excitation. Compare
    also your results to perturbation theory at different orders, in
    particular to second order. Discuss your results.  If other
    students are solving the same problem using Green's function
    theory, you can also compare your results with those obtained from
    Green's function theory. The aim is to finalize this part during
    the first week. The codes you will develop can be used as a
    starting point for the second part of the project.
  \end{enumerate}
  \end{prob}

\begin{prob} \label{problem:amplitudes}
Derive the amplitude equations of Eq.~(\ref{eq:ccd}) starting with 
 \[
          0 = \langle\Phi_{i_1 \ldots i_n}^{a_1 \ldots a_n}\vert
          \overline{H}\vert \Phi_0\rangle.
 \]
\end{prob}
  \begin{prob}\label{problem:realisticforces}
Replace the Minnesota interaction model with realistic models for nuclear forces based on effective field theory. In particular 
replace the Minnesota interaction with the low-order (LO) contribution which includes a contact term and a one-pion exchange
term only. The expressions are discussed in section  \ref{subsec:forcemodels} and Eq.~(\ref{eq:eq_1PEci}). Reference \cite{ekstromPRX} contains a
detailed compilation of all terms up to order NNLO, with tabulated values for all constants. 
When adding realistic interaction models we recommend that you use the many-body perturbation theory codes to second order in the interaction, see the code link at \url{https://github.com/ManyBodyPhysics/LectureNotesPhysics/blob/master/doc/src/Chapter8-programs/cpp/MBPT2/src/}. 
\end{prob}

  \section{Solutions to selected exercises}
  \begin{sol}{problem:prob8.1}
  To solve this problem, we start by introducing the shorthand label
  for single-particle states below the Fermi level $F$ as $i,j,\ldots
  \leq F$. For single-particle states above the Fermi level we reserve
  the labels $a,b,\ldots > F$, while the labels $p,q, \ldots$
  represent any possible single particle state.  Using the ansatz for
  the ground state $\vert \Phi_0$ as new reference vacuum state, the
  anticommutation relations are
  \[
  \left\{a_p^\dagger, a_q \right\}= \delta_{pq}, p, q \leq F,
  \]
  and
  \[
  \left\{a_p, a_q^\dagger \right\} = \delta_{pq}, \hspace{0.1cm} p, q
  > F.
  \]
  It is easy to see then that
  \[
          a_i|\Phi_0\rangle = |\Phi_i\rangle\ne 0, \hspace{0.5cm}
          a_a^\dagger|\Phi_0\rangle = |\Phi^a\rangle\ne 0,
  \]
  and
  \[
  a_i^\dagger|\Phi_0\rangle = 0 \hspace{0.5cm} a_a|\Phi_0\rangle = 0.
  \]
  We can then rewrite the one-body Hamiltonian as
   \begin{align*}
          \hat{H}_0 &= \sum_{pq} \element{p}{\hat{h}_0}{q} a^\dagger_p
          a_q \\ &= \sum_{pq} \element{p}{\hat{h}_0}{q}
          \left\{a^\dagger_p a_q\right\} + \delta_{pq\in i} \sum_{pq}
          \element{p}{\hat{h}_0}{q} \\ &= \sum_{pq}
          \element{p}{\hat{h}_0}{q} \left\{a^\dagger_p a_q\right\} +
          \sum_i \element{i}{\hat{h}_0}{i},
   \end{align*}
  where the curly brackets represent normal-ordering with respect to
  the new vacuum state. Withe respect to the new vacuum reference
  state, the
  \end{sol}

  \begin{sol}{problem:prob8.2}
  Using our anti-commutation rules, Wick's theorem discussed in the
  appendix and the definition of the creation and annihilation
  operators from the previous problem, we can rewrite the set of
  creation and annihilation operators of
      \begin{equation*}
          \hat{H}_I = \frac{1}{4} \sum_{pqrs}
          \element{pq}{\hat{v}}{rs} a^\dagger_p a^\dagger_q a_s a_r
      \end{equation*}
  as
  \begin{align*}
      a^\dagger_p a^\dagger_q a_s a_r &=\normord{a^\dagger_p
        a^\dagger_q a_s a_r} \\ & + \normord{
        \contraction{a^\dagger_p}{a}{{}^\dagger_q}{a}a^\dagger_p
        a^\dagger_q a_s a_r}+
      \normord{\contraction{a^\dagger_p}{a}{{}^\dagger_q a_s}{a}
        a^\dagger_p a^\dagger_q a_s a_r}+
      \normord{\contraction{}{a}{{}^\dagger_p
          a^\dagger_q}{a}a^\dagger_p a^\dagger_q a_s a_r} \\ & +
      \normord{\contraction{}{a}{{}^\dagger_p a^\dagger_q
          a_s}{a}a^\dagger_p a^\dagger_q a_s a_r}+
      \normord{\contraction[1.5ex]{}{a}{{}^\dagger_p a_q^\dagger
          a_s}{a}
        \contraction{a^\dagger_p}{a}{{}^\dagger_q}{a}a^\dagger_p
        a^\dagger_q a_s a_r}+ \normord{\contraction{}{a}{{}^\dagger_p
          a_q^\dagger}{a}\contraction[1.5ex]{a^\dagger_p}{a}{{}^\dagger_q
          a_s}{a}a^\dagger_p a^\dagger_q a_s a_r} \\ &=
      \normord{a^\dagger_p a^\dagger_q a_s a_r}+ \delta_{qs\in i}
      \normord{ a^\dagger_p a_r}- \delta_{qr \in i}
      \normord{a^\dagger_p a_s} - \delta_{ps \in i}
      \normord{a^\dagger_q a_r}\\ & + \delta_{pr \in i}
      \normord{a^\dagger_q a_s} + \delta_{pr \in i} \delta_{qs \in i}
      - \delta_{ps \in i} \delta_{qr \in i}.
  \end{align*}
   Inserting the redefinition of the creation and annihilation
   operators with respect to the new vacuum state, we have
      \begin{align*}
      \hat{H}_I &= \frac{1}{4} \sum_{pqrs} \element{pq}{\hat{v}}{rs}
      a^\dagger_p a^\dagger_q a_s a_r \\ &= \frac{1}{4} \sum_{pqrs}
      \element{pq}{\hat{v}}{rs} \normord{a^\dagger_p a^\dagger_q a_s
        a_r} + \frac{1}{4} \sum_{pqrs} \Bigl( \delta_{qs\in i}
      \element{pq}{\hat{v}}{rs} \normord{ a^\dagger_p a_r}\\ & -
      \delta_{qr \in i} \element{pq}{\hat{v}}{rs} \normord{a^\dagger_p
        a_s} - \delta_{ps \in i}\element{pq}{\hat{v}}{rs}
      \normord{a^\dagger_q a_r}\\ & + \delta_{pr \in i}
      \element{pq}{\hat{v}}{rs} \normord{a^\dagger_q a_s}+ \delta_{pr
        \in i} \delta_{qs \in i}- \delta_{ps \in i} \delta_{qr \in i}
      \Bigr) \\ &= \frac{1}{4} \sum_{pqrs} \element{pq}{\hat{v}}{rs}
      \normord{a^\dagger_p a^\dagger_q a_s a_r}\\ & + \frac{1}{4}
      \sum_{pqi} \Bigl(\element{pi}{\hat{v}}{qi} -
      \element{pi}{\hat{v}}{iq} - \element{ip}{\hat{v}}{qi} +
      \element{ip}{\hat{v}}{iq}\Bigr) \normord{a^\dagger_p a_q}\\ & +
      \frac{1}{4} \sum_{ij} \Bigl(\element{ij}{\hat{v}}{ij}-
      \element{ij}{\hat{v}}{ji}\Bigr)\\ &= \frac{1}{4} \sum_{pqrs}
      \element{pq}{\hat{v}}{rs} \normord{a^\dagger_p a^\dagger_q a_s
        a_r} + \sum_{pqi} \element{pi}{\hat{v}}{qi}
      \normord{a^\dagger_p a_q} + \frac{1}{2} \sum_{ij}
      \element{ij}{\hat{v}}{ij}.
      \end{align*}
  Summing up, we obtain a two-body part defined as
      \begin{equation*}
              \hat{V}_N = \frac{1}{4} \sum_{pqrs}
              \element{pq}{\hat{v}}{rs} \normord{a^\dagger_p
                a^\dagger_q a_s a_r},
      \end{equation*}
  a one-body part given by
      \begin{equation*}
              \hat{F}_N = \sum_{pqi} \element{pi}{\hat{v}}{qi}
              \normord{a^\dagger_p a_q},
      \end{equation*}
      and finally the so-called reference energy
      \begin{equation*}
                  E_{\mathrm{ref}}= \frac{1}{2} \sum_{ij}
                  \element{ij}{\hat{v}}{ij}.
      \end{equation*}
  which is the energy expectation value for the reference state.
  Thus, our normal-ordered Hamiltonian with at most a two-body
  nucleon-nucleon interaction is defined as
  \[
  \hat{H}_N =\frac{1}{4} \sum_{pqrs} \bra{pq}\hat{v}\ket{rs}
  \normord{a^\dagger_p a^\dagger_q a_s a_r} + \sum_{pq} f_q^p
  \normord{a^\dagger_p a_q}= \hat{V}_N + \hat{F}_N,
  \]
  with
  \[
  \hat{F}_N = \sum_{pq} f_q^p \normord{a^\dagger_p a_q},
  \]
  and
  \[
  \hat{V}_N = \frac{1}{4} \sum_{pqrs} \bra{pq}\hat{v}\ket{rs}
  \normord{a^\dagger_p a^\dagger_q a_s a_r},
  \]
  where
  \[
    f_q^p = \element{p}{\hat{h}_0}{q} + \sum_i
    \element{pi}{\hat{v}}{qi}
  \]
  \end{sol}

  \begin{sol}{problem:spbasissetup}
  The following python code sets up the quantum numbers for both
  infinite nuclear matter and neutron matter employing a cutoff in
  the value of $n$. The full code can be found at  \url{https://github.com/ManyBodyPhysics/LectureNotesPhysics/blob/master/doc/src/Chapter8-programs/python/spstatescc.py}.
  \begin{lstlisting}
from numpy import *

nmax =2
nshell = 3*nmax*nmax
count = 1
tzmin = 1

print "Symmetric nuclear matter:"  
print "a, nx,   ny,   nz,   sz,   tz,   nx^2 + ny^2 + nz^2"
for n in range(nshell): 
    for nx in range(-nmax,nmax+1):
         for ny in range(-nmax,nmax+1):
            for nz in range(-nmax, nmax+1):  
                for sz in range(-1,1+1):
                    tz = 1
                    for tz in range(-tzmin,tzmin+1):
                        e = nx*nx + ny*ny + nz*nz
                        if e == n:
                            if sz != 0: 
                                if tz != 0: 
                                    print count, "  ",nx,"  ",ny, "  ",nz,"  ",sz,"  ",tz,"         ",e
                                    count += 1
                                    
                                    
nmax =1
nshell = 3*nmax*nmax
count = 1
tzmin = 1
print "------------------------------------"
print "Neutron matter:"                                    
print "a, nx,   ny,   nz,   sz,    nx^2 + ny^2 + nz^2"
for n in range(nshell): 
    for nx in range(-nmax,nmax+1):
         for ny in range(-nmax,nmax+1):
            for nz in range(-nmax, nmax+1):  
                for sz in range(-1,1+1):
                    e = nx*nx + ny*ny + nz*nz
                    if e == n:
                        if sz != 0: 
                            print count, "  ",nx,"  ",ny, "  ",sz,"  ",tz,"         ",e
                            count += 1     
  \end{lstlisting}                               
  \end{sol}






  \section*{Appendix, Wick's theorem}
  \addcontentsline{toc}{section}{Appendix} Wick's theorem is based on
  two fundamental concepts, namely $\textit{normal ordering}$ and
  $\textit{contraction}$. The normal-ordered form of
  $\hat{A}\hat{B}..\hat{X}\hat{Y}$, where the individual terms are
  either a creation or annihilation operator, is defined as
  \begin{align}
  \label{def: Normal ordering}
  \kpr{\hat{A}\hat{B}..\hat{X}\hat{Y}} \equiv
  (-1)^p\fpr{\text{creation operators}}\cdot\fpr{\text{annihilation
      operators}}.
  \end{align}
  The $p$ subscript denotes the number of permutations that is needed
  to transform the original string into the normal-ordered form. A
  contraction between to arbitrary operators $\hat{X}$ and $\hat{Y}$
  is defined as
  \begin{align}
  \contraction[0.5ex]{}{\hat{X}}{}{\hat{Y}}{} \hat{X}\hat{Y} \equiv
  \for{0}{\hat{X}\hat{Y}}{0}.
  \end{align}
  It is also possible to contract operators inside a normal ordered
  products. We define the original relative position between two
  operators in a normal ordered product as $p$, the so-called
  permutation number. This is the number of permutations needed to
  bring one of the two operators next to the other one. A contraction
  between two operators with $p \neq 0$ inside a normal ordered is
  defined as
  \begin{align}
  \kpr{\contraction[0.5ex]{}{\hat{A}}{\hat{B}..}{\hat{X}}\hat{A}\hat{B}..\hat{X}\hat{Y}}
  = (-1)^p
  \kpr{\contraction[0.5ex]{}{\hat{A}}{}{\hat{B}}\hat{A}\hat{B}..\hat{X}\hat{Y}}.
  \end{align}
  In the general case with $m$ contractions, the procedure is similar,
  and the prefactor changes to
  \begin{align}
  (-1)^{p_1 + p_2 + .. + p_m}.
  \end{align} 

  Wick's theorem states that every string of creation and annihilation
  operators can be written as a sum of normalordered products with all
  possible ways of contractions,
  \begin{align}
  \label{def: Wick's theorem}
  \hat{A}\hat{B}\hat{C}\hat{D}..\hat{R}\hat{X}\hat{Y}\hat{Z} &=
  \kpr{\hat{A}\hat{B}\hat{C}\hat{D}..\hat{R}\hat{X}\hat{Y}\hat{Z}}\\ &+
  \sum_{[1]} \kpr{ \contraction[0.5ex]{}{\hat{A}}{}{\hat{B}}
    \hat{A}\hat{B}\hat{C}\hat{D}..\hat{R}\hat{X}\hat{Y}\hat{Z}}\\ &+
  \sum_{[2]}
  \kpr{\contraction[0.5ex]{}{\hat{A}}{\hat{B}}{\hat{C}}\contraction[1.0ex]{\hat{A}}{\hat{B}}{\hat{C}}{\hat{D}}\hat{A}\hat{B}\hat{C}\hat{D}..\hat{R}\hat{X}\hat{Y}\hat{Z}}\\ &+
  ...\\ &+
  \sum_{[\frac{N}{2}]}\kpr{\contraction[0.5ex]{}{\hat{A}}{\hat{B}}{\hat{C}}\contraction[1.0ex]{\hat{A}}{\hat{B}}{\hat{C}}{\hat{D}}
    \hat{A}\hat{B}\hat{C}\hat{D}..\contraction[0.5ex]{}{\hat{R}}{\hat{X}}{\hat{Y}}\contraction[1.0ex]{\hat{R}}{\hat{X}}{\hat{Y}}{\hat{Z}}\ \hat{R}\hat{X}\hat{Y}\hat{Z}}.
  \end{align}

  The $\sum_{[m]}$ means the sum over all terms with $m$ contractions,
  while $\fpr{\frac{N}{2}}$ means the largest integer that not do not
  exceeds $\frac{N}{2}$ where $N$ is the number of creation and
  annihilation operators. When $N$ is even,
  \begin{align}
  \label{exp: Wick condition}
  \fpr{\frac{N}{2}} = \frac{N}{2},
  \end{align}
  and the last sum in Eq. (\ref{def: Wick's theorem}) is over fully
  contracted terms. When $N$ is odd,
  \begin{align}
  \fpr{\frac{N}{2}} \neq \frac{N}{2},
  \end{align}
  and none of the terms in Eq. (\ref{def: Wick's theorem}) are fully
  contracted.

  An important extension of Wick's theorem allow us to define
  contractions between normal-ordered strings of operators. This is
  the so-called generalized Wick's theorem,
  \begin{align}
  \label{def: Generalized Wick's theorem}
  \kpr{\hat{A}\hat{B}\hat{C}\hat{D}..}\kpr{\hat{R}\hat{X}\hat{Y}\hat{Z}..}
  &=
  \kpr{\hat{A}\hat{B}\hat{C}\hat{D}..\hat{R}\hat{X}\hat{Y}\hat{Z}}\\ &+
  \sum_{[1]} \kpr{
    \contraction[0.5ex]{}{\hat{A}}{\hat{B}\hat{C}\hat{D}..}{\hat{R}}
    \hat{A}\hat{B}\hat{C}\hat{D}..\hat{R}\hat{X}\hat{Y}\hat{Z}}\\ &+
  \sum_{[2]}
  \kpr{\contraction[0.5ex]{}{\hat{A}}{\hat{B}\hat{C}\hat{D}..}{\hat{R}}\contraction[1.0ex]{\hat{A}}{\hat{B}}{\hat{C}\hat{D}..\hat{R}}{\hat{X}}\hat{A}\hat{B}\hat{C}\hat{D}..\hat{R}\hat{X}\hat{Y}\hat{Z}}\\ &+
  ...
  \end{align}

  Turning back to the many-body problem, the vacuum expectation value
  of products of creation and annihilation operators can be written,
  according to Wick's theoren in Eq. (\ref{def: Wick's theorem}), as a
  sum over normal ordered products with all possible numbers and
  combinations of contractions,
  \begin{align}
  \for{0}{\hat{A}\hat{B}\hat{C}\hat{D}..\hat{R}\hat{X}\hat{Y}\hat{Z}}{0}
  &=
  \for{0}{\kpr{\hat{A}\hat{B}\hat{C}\hat{D}..\hat{R}\hat{X}\hat{Y}\hat{Z}}}{0}\\ &+
  \sum_{[1]} \for{0}{\kpr{\contraction[0.5ex]{}{\hat{A}}{}{\hat{B}}
      \hat{A}\hat{B}\hat{C}\hat{D}..\hat{R}\hat{X}\hat{Y}\hat{Z}}}{0}\\ &+
  \sum_{[2]}\for{0}{\kpr{\contraction[0.5ex]{}{\hat{A}}{\hat{B}}{\hat{C}}\contraction[1.0ex]{\hat{A}}{\hat{B}}{\hat{C}}{\hat{D}}\hat{A}\hat{B}\hat{C}\hat{D}..\hat{R}\hat{X}\hat{Y}\hat{Z}}}{0}\\ &+
  ... \\ &+ \sum_{[\frac{N}{2}]}
  \for{0}{\kpr{\contraction[0.5ex]{}{\hat{A}}{\hat{B}}{\hat{C}}\contraction[1.0ex]{\hat{A}}{\hat{B}}{\hat{C}}{\hat{D}}
      \hat{A}\hat{B}\hat{C}\hat{D}..\contraction[0.5ex]{}{\hat{R}}{\hat{X}}{\hat{Y}}\contraction[1.0ex]{\hat{R}}{\hat{X}}{\hat{Y}}{\hat{Z}}\ \hat{R}\hat{X}\hat{Y}\hat{Z}}}{0}.
  \end{align}

  All vacuum expectation values of normal ordered products without
  fully contracted terms are zero. Hence, the only contributions to
  the expectation value are those terms that $\textit{is}$ fully
  contracted,
  \begin{align}
  \for{0}{\hat{A}\hat{B}\hat{C}\hat{D}..\hat{R}\hat{X}\hat{Y}\hat{Z}}{0}
  &= \sum_{[all]}
  \for{0}{\kpr{\contraction[0.5ex]{}{\hat{A}}{\hat{B}}{\hat{C}}\contraction[1.0ex]{\hat{A}}{\hat{B}}{\hat{C}}{\hat{D}}
      \hat{A}\hat{B}\hat{C}\hat{D}..\contraction[0.5ex]{}{\hat{R}}{\hat{X}}{\hat{Y}}\contraction[1.0ex]{\hat{R}}{\hat{X}}{\hat{Y}}{\hat{Z}}\ \hat{R}\hat{X}\hat{Y}\hat{Z}}}{0}\\ &=
  \sum_{[all]}
  \contraction[0.5ex]{}{\hat{A}}{\hat{B}}{\hat{C}}\contraction[1.0ex]{\hat{A}}{\hat{B}}{\hat{C}}{\hat{D}}
  \hat{A}\hat{B}\hat{C}\hat{D}..\contraction[0.5ex]{}{\hat{R}}{\hat{X}}{\hat{Y}}\contraction[1.0ex]{\hat{R}}{\hat{X}}{\hat{Y}}{\hat{Z}}\ \hat{R}\hat{X}\hat{Y}\hat{Z}.
  \end{align}

  To obtain fully contracted terms, Eq. (\ref{exp: Wick condition})
  must hold. When the number of creation and annihilation operators is
  odd, the vacuum expectation value can be set to zero at once. When
  the number is even, the expectation value is simply the sum of terms
  with all possible combinations of fully contracted terms. Observing
  that the only contractions that give nonzero contributions are
  \begin{align}
  \contraction{}{a_{\alpha}}{}{a^{\dagger}_{\beta}}
  a_{\alpha}a^{\dagger}_{\beta} = \delta_{\alpha \beta},
  \end{align}
  the terms that contribute are reduced even more.

  Wick's theorem provides us with an algebraic method for easy
  determination of the terms that contribute to the matrix element.

  \section*{Code structure with benchmark calculations}
In section \ref{sec:chap8numproject} we emphasized several elements we
feel are important during the various development stages of a
numerical project. Here we would like to reiterate some of these. In
particular we would like to stress modularization of code and
refactoring into general classes which can easily be extended upon in
order to accomodate new physical systems and/or many-methods.

The codes of this chapter, listed at the link
\url{https://github.com/ManyBodyPhysics/LectureNotesPhysics/blob/master/doc/src/Chapter8-programs/cpp/CCD/src},
abide to this general philosophy via two major general classes, one
for the physical systems under study and one for the specific
many-body methods. The latter allows us, in a fairly straightforward
way to add new many-body methods like the in-medium similarity
renormalization group approach of chapter 10 or to extend our nuclear
matter calculations to systems like the homogenous electron gas in two
or three dimensions.

To be more explicit, the general class  {\em abstractSPbasis} allows easily for extensions the homogenous electron gas or systems like quantum dots.  The abstract class is defined as (for the complete code see the above link)
\begin{lstlisting}
#ifndef ABSTRACTSPBASIS_HPP
#define ABSTRACTSPBASIS_HPP

class abstractSPbasis{
public:
  // double g;
  // double density;
  // double r_s;
  // int tzMax;
  // int nMax;
  // int shellMax;
  int Nspstates;
  int Nparticles;
  int Nchannels;
  int ** indexMap;
  double * spEnergy;
  channelBundle * chanValue;
  channelBundle * chanModValue;

  abstractSPbasis() {}
  // abstractSPbasis(double densityIn, int tzMaxIn, int shellMaxIn, int NparticlesIn);
  virtual void generateIndexMap() = 0;
  virtual void generateBasis() = 0;
  virtual int checkSympqrs(int p, int q, int r, int s) = 0;
  virtual int checkModSympqrs(int p, int q, int r, int s) = 0;
  virtual int checkChanSym(int p, int q, int ichan) = 0;  
  virtual int checkChanModSym(int p, int q, int ichan) = 0;  
  virtual void setUpTwoStateChannels() = 0;
  virtual void printBasis() = 0;
  virtual void deallocate() = 0;  

  virtual double calc_TBME(int p, int q, int r, int s) = 0;
};
#endif /*ABSTRACTSPBASIS_HPP*/
\end{lstlisting} 
This class defines general quantum numbers and functions that can in turn be inhereted by other systems.
The inheritance diagram for this specific class is shown in Fig.~\ref{fig:absinherit}.
\begin{figure}
\caption{Inheritance diagram for the abstract class.} \label{fig:absinherit}
\begin{center}
\includegraphics{Chapter8-figures/classabstractspbasis.pdf}
\end{center}
\end{figure}
As an example, the class that is used in the infinite matter calculations is shown here.
\begin{lstlisting}
#ifndef INFMATTER_HPP
#define INFMATTER_HPP

#include "abstractSPbasis.hpp"

// struct channelBundle{
//   int chanNx;
//   int chanNy;
//   int chanNz;
//   int chanSz;
//   int chanTz; 
// };

class infMatterSPBasis: public abstractSPbasis{
public:
   double density;
   int tzMax;
   int nMax;
   int shellMax;
  // int Nspstates;
  // int Nparticles;
  // int Nchannels;
  // int ** indexMap;
  // double * spEnergy;
  // channelBundle * chanValue;
  // channelBundle * chanModValue;

  infMatterSPBasis(double densityIn, int tzMaxIn, int shellMaxIn, int NparticlesIn);// : abstractSPbasis(densityIn, tzMaxIn, shellMaxIn, NparticlesIn) {}
  void generateIndexMap();
  void generateBasis();
  int checkSympqrs(int p, int q, int r, int s);
  int checkModSympqrs(int p, int q, int r, int s);
  int checkChanSym(int p, int q, int ichan);
  int checkChanSym2(int p, int q, int chanNx, int chanNy, int chanNz, int chanSz, int chanTz);
int checkChanModSym2(int p, int q, int chanNx, int chanNy, int chanNz, int chanSz, int chanTz);
  int checkChanModSym(int p, int q, int ichan);  
  void setUpTwoStateChannels();
  void printBasis();
  void deallocate();

  double calc_TBME(int p, int q, int r, int s);
  int spinExchangeMtxEle(int i, int j, int k, int l);
  int kron_del(int i, int j);

};

#endif /* INFMATTER_HPP */
\end{lstlisting}

  \begin{acknowledgement}
  We are much indebted to Thomas Papenbrock for many discussions on
  many-body theory.  Computational resources were provided by
  Michigan State University and the Research Council of Norway via the
  Notur project (Supercomputing grant NN2977K).  This work was
  supported by NSF Grant No.~PHY-1404159 (Michigan State University).
  \end{acknowledgement}



\bibliographystyle{spphys} 
\bibliography{lnplib}



